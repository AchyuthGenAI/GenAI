<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat@AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Lottie Player Script -->
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>

    <style>
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        html, body { font-family: 'Inter', sans-serif; }
        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50; /* Increased z-index */
        }
        .mic-active { color: #f43f5e; } /* rose-500 */
        #chat-input {
            max-height: 200px; /* Set max height for the textarea */
            resize: none; /* Disable manual resizing by user */
        }

        /* Styles for Markdown content generated by Marked.js */
        .prose { color: #d1d5db; /* gray-300 */ }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: #f1f5f9; /* slate-100 */ }
        .prose a { color: #22d3ee; /* cyan-400 */ }
        .prose strong { color: #f8fafc; /* slate-50 */ }
        .prose ul > li::marker { color: #64748b; /* slate-500 */ }
        .prose pre {
            background-color: #0f172a; /* slate-900 */
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            overflow-x: auto; /* Add horizontal scroll for long code lines */
        }
        .prose code { font-size: 0.9rem; }

        /* Action buttons for code blocks (Copy, Preview) */
        .code-btn-wrapper {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .prose pre:hover .code-btn-wrapper { opacity: 1; }
        .code-action-btn {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .history-item-container:hover .delete-chat-btn { opacity: 1; }

        /* Responsive Table Styles */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
            table-layout: auto;
        }
        .prose th, .prose td {
            border: 1px solid #334155; /* slate-700 */
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .prose th {
            background-color: #1e293b; /* slate-800 */
            font-weight: 600;
            color: #f1f5f9; /* slate-100 */
        }
        .prose tbody tr:nth-child(even) { background-color: rgba(30, 41, 59, 0.5); }
        .table-responsive-wrapper {
            overflow-x: auto;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .table-responsive-wrapper table {
            margin: 0 !important;
        }

        /* Blinking cursor for typing animation */
        .typing-cursor {
            animation: blink 1s step-end infinite;
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background-color: #94a3b8; /* slate-400 */
            vertical-align: sub;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #94a3b8; } /* slate-400 */
        }

        .auth-container { background: #0f172a; }
        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: #1e293b; /* slate-800 */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #334155; /* slate-700 */
            width: 200px;
            z-index: 100; /* Increased z-index for dropdown */
            display: none;
        }
        .profile-dropdown.show { display: block; }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: #64748b; /* slate-500 */
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #334155; /* slate-700 */
        }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        /* Password Strength */
        #password-strength-bar {
            height: 5px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }

        /* Styles for action buttons on chat responses */
        .chat-message {
            position: relative;
            padding-bottom: 2.5rem; /* Space for buttons */
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            position: absolute;
            bottom: 0.5rem; /* Adjusted position */
            left: 56px; /* Align to the right of model icon for model messages */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .chat-message.user .action-buttons {
            right: 56px; /* Adjust for user avatar */
            left: auto;
        }

        .chat-message:hover .action-buttons {
            opacity: 1;
        }

        .action-buttons button {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            border: none;
            padding: 0; /* Removed padding for better centering */
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center; /* Center SVG */
            width: 32px; /* Fixed width */
            height: 32px; /* Fixed height */
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
        }
        .action-buttons button:hover {
            background-color: #475569; /* slate-600 */
            color: #f1f5f9; /* slate-100 */
        }
        .action-buttons button:active {
            transform: scale(0.95);
        }
        .action-buttons .active-like {
            background-color: #1e293b; /* slate-800 */
            color: #34d399; /* emerald-400 */
        }
        .action-buttons .active-dislike {
            background-color: #1e293b; /* slate-800 */
            color: #f87171; /* red-400 */
        }


        /* Sidebar overlay improvements */
        .sidebar-overlay {
            z-index: 40; /* Ensure overlay is below sidebar but above content */
        }

        /* Ensure sidebar is properly positioned */
        @media (max-width: 1023px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-full flex overflow-hidden">
    <!-- Auth Page -->
    <div id="auth-page" class="w-full h-full flex items-center justify-center auth-container p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-cyan-400 mb-2">Welcome to Chat@AI</h1>
                <p class="text-slate-400 text-sm sm:text-base">Your intelligent chat companion.</p>
            </div>
            <div id="auth-error" class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6 hidden"></div>
            <!-- Login Form -->
            <form id="login-form" class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h2 class="text-2xl font-semibold text-center text-white">Log In</h2>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div class="relative">
                    <label for="login-password" class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition pr-10">
                    <button type="button" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-slate-400 hover:text-white" onclick="togglePasswordVisibility('login-password')">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Log In</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <div class="divider">OR</div>
                <button type="button" id="google-login-btn" class="w-full bg-white text-slate-700 font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center hover:bg-slate-200">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Continue with Google
                </button>
                <p class="text-center text-slate-400">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-cyan-400 hover:text-cyan-300">Sign up</a>
                </p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center text-white">Sign Up</h2>
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-slate-300 mb-2">Full Name</label>
                    <input type="text" id="signup-name" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                    <input type="email" id="signup-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                    <p id="email-error" class="text-red-400 text-sm mt-1 hidden"></p>
                </div>
                <div class="relative">
                    <label for="signup-password" class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <input type="password" id="signup-password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition pr-10">
                     <button type="button" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-slate-400 hover:text-white" onclick="togglePasswordVisibility('signup-password')">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                 <div class="w-full bg-slate-700 rounded-full h-[5px]">
                    <div id="password-strength-bar" class="rounded-full"></div>
                </div>
                <p id="password-error" class="text-red-400 text-sm -mt-3 hidden"></p>

                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Sign Up</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <div class="divider">OR</div>
                 <button type="button" id="google-signup-btn" class="w-full bg-white text-slate-700 font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center hover:bg-slate-200">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Continue with Google
                </button>
                <p class="text-center text-slate-400">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-cyan-400 hover:text-cyan-300">Log in</a>
                </p>
            </form>
        </div>
    </div>

    <div id="chat-app" class="hidden w-full h-full flex relative">
        <!-- Sidebar for Chat History -->
        <aside id="sidebar" class="sidebar bg-slate-800 w-72 flex-shrink-0 flex flex-col p-4 lg:relative lg:translate-x-0">
            <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg px-4 py-3 transition duration-300 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>New Chat</span>
            </button>
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-slate-300">History</h2>
                <button id="clear-all-btn" class="p-1 text-slate-500 hover:text-red-500" title="Clear all chats">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto pr-2">
                <ul id="history-list" class="space-y-2">
                    <!-- Chat history items will be injected here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full relative z-10 bg-slate-900">
            <!-- Header -->
            <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 shadow-lg sticky top-0 z-30">
                <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
                     <div class="flex items-center gap-4">
                        <button id="menu-btn" class="lg:hidden p-2 -ml-2 text-slate-300 hover:bg-slate-700 rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 rounded-full shadow" />
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-200">Chat@AI</h1>
                     </div>
                     <div class="flex items-center gap-2 sm:gap-4">
                        <a href="./index.html" class="flex items-center gap-2 text-slate-300 hover:bg-slate-700 rounded-md px-3 py-2 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            <span class="font-medium hidden sm:block">Home</span>
                        </a>
                        <div class="relative">
                            <button id="profile-btn" class="flex items-center gap-2 text-slate-300 hover:bg-slate-700 rounded-full p-1 transition-colors">
                                <div id="profile-avatar" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white overflow-hidden"></div>
                            </button>
                            <div id="profile-dropdown" class="profile-dropdown">
                                <div class="p-4 border-b border-slate-700">
                                    <p class="font-bold text-white truncate" id="profile-name"></p>
                                    <p class="text-sm text-slate-400 truncate" id="profile-email"></p>
                                </div>
                                <button id="logout-btn" class="w-full text-left px-4 py-3 hover:bg-slate-700/50 text-red-400 font-medium flex items-center gap-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Chat Area -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                <div id="chat-container" class="max-w-4xl mx-auto space-y-6">
                    <!-- Chat messages will be injected here -->
                </div>
            </main>

            <!-- Message Input Form & Controls -->
            <footer class="bg-slate-900/50 backdrop-blur-sm sticky bottom-0">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                     <!-- Stop Generating Button Container -->
                    <div id="generation-controls" class="text-center pb-2 hidden">
                        <button id="stop-generating-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg px-4 py-2 transition duration-300 flex items-center mx-auto">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                             <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                           </svg>
                            Stop Generating
                        </button>
                    </div>
                    <form id="chat-form">
                        <div class="flex items-end bg-slate-800 border border-slate-700 rounded-2xl p-2 transition-all duration-300 focus-within:ring-2 focus-within:ring-cyan-500">
                            <textarea id="chat-input" placeholder="Enter a prompt here..." autocomplete="off" rows="1" class="flex-1 bg-transparent px-4 py-2 text-white placeholder-slate-400 focus:outline-none disabled:bg-transparent disabled:cursor-not-allowed"></textarea>

                            <button id="mic-btn" type="button" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 transition-colors duration-200 disabled:opacity-50">
                                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                            </button>

                            <button type="submit" class="bg-slate-600 text-white rounded-full p-2 ml-1 transition-colors duration-300 flex items-center justify-center disabled:bg-slate-700 disabled:cursor-not-allowed w-10 h-10 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                            </button>
                        </div>
                    </form>
                </div>
            </footer>
        </div>
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/50 backdrop-blur-sm hidden lg:hidden"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="delete-modal-title" class="text-xl font-bold text-white mb-4">Delete Chat?</h3>
            <p id="delete-modal-text" class="text-slate-400 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 transition-colors">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Code Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full h-full max-w-4xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h3 class="text-xl font-bold text-white">Live Preview</h3>
                <button id="close-preview-btn" class="p-2 rounded-full hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div class="flex-1 p-1 bg-white">
                <iframe id="preview-iframe" class="w-full h-full border-0 rounded-md"></iframe>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            addDoc,
            query,
            getDocs,
            deleteDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element References ---
        const authPage = document.getElementById('auth-page');
        const chatApp = document.getElementById('chat-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleSignupBtn = document.getElementById('google-signup-btn');
        const signupNameInput = document.getElementById('signup-name');
        const signupPasswordInput = document.getElementById('signup-password');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const emailError = document.getElementById('email-error');
        const passwordError = document.getElementById('password-error');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileAvatarContainer = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const submitButton = chatForm.querySelector('button[type="submit"]');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const previewModal = document.getElementById('preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const previewIframe = document.getElementById('preview-iframe');
        const generationControls = document.getElementById('generation-controls');
        const stopGeneratingBtn = document.getElementById('stop-generating-btn');

        // --- API & Firebase Configuration ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const API_KEY = 'AIzaSyDirhQ899FnmcWCuwfHfzS05TEenhZntwA'; // IMPORTANT: Replace with your actual API key

        const firebaseConfig = {
            apiKey: "AIzaSyAMqtiL99s78TnDyHEi8VlBbzMzZh8Jqh8",
            authDomain: "login-90932.firebaseapp.com",
            projectId: "login-90932",
            storageBucket: "login-90932.appspot.com",
            messagingSenderId: "574568827002",
            appId: "1:574568827002:web:7ed038c10c3fe0bc3953c3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);


        // --- State Management ---
        let currentChatId = null;
        let allChats = {};
        let chatIdToDelete = null;
        let stopGenerationFlag = false;
        let currentUser = null;

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
             // Configure Marked.js
            marked.setOptions({
                gfm: true,
                breaks: true,
                sanitizer: (html) => html,
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            });
            addEventListeners();
            checkAuthState();
        });

        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                     if (userDoc.exists()) {
                         const userData = userDoc.data();
                         currentUser = { ...user, ...userData };
                    } else {
                         // If user signed up with Google, their info might already be in auth object
                         const displayName = user.displayName || signupNameInput.value || "Anonymous";
                         const photoURL = user.photoURL || null;
                         await setDoc(userDocRef, {
                            displayName: displayName,
                            email: user.email,
                            photoURL: photoURL,
                            createdAt: new Date()
                        });
                        currentUser = { ...user, displayName, photoURL };
                    }

                    showChatApp();
                    setupUserProfile(currentUser);
                    loadChatsFromFirestore();
                } else {
                    currentUser = null;
                    showAuthPage();
                }
            });
        }

        function showAuthPage() {
            authPage.classList.remove('hidden');
            chatApp.classList.add('hidden');
        }

        function showChatApp() {
            authPage.classList.add('hidden');
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
        }

        function setupUserProfile(user) {
            profileEmail.textContent = user.email;
            profileName.textContent = user.displayName || 'No Name';

            // Use Google photo if available, otherwise use initial
            if (user.photoURL) {
                profileAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full">`;
                profileAvatarContainer.classList.remove('bg-purple-600', 'flex', 'items-center', 'justify-center', 'font-bold', 'text-white');
            } else {
                const initial = (user.displayName || user.email).charAt(0).toUpperCase();
                profileAvatarContainer.innerHTML = initial;
                profileAvatarContainer.classList.add('bg-purple-600', 'flex', 'items-center', 'justify-center', 'font-bold', 'text-white');
            }
        }

        function addEventListeners() {
            // Auth form switching
            showSignupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });

             // Auth form submission
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            googleLoginBtn.addEventListener('click', handleGoogleSignIn);
            googleSignupBtn.addEventListener('click', handleGoogleSignIn);

            // Advanced Auth UI Listeners
            signupPasswordInput.addEventListener('input', updatePasswordStrength);
            document.getElementById('signup-email').addEventListener('input', validateEmail);

            // Profile & Logout
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
            });
            logoutBtn.addEventListener('click', handleLogout);
            document.addEventListener('click', (e) => {
                 if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            });


            // Chat app event listeners
            chatForm.addEventListener('submit', handleSendMessage);
            newChatBtn.addEventListener('click', startNewChat);
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            clearAllBtn.addEventListener('click', () => showDeleteModal(null));
            confirmDeleteBtn.addEventListener('click', confirmDeletion);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            closePreviewBtn.addEventListener('click', hidePreviewModal);
            stopGeneratingBtn.addEventListener('click', () => {
                stopGenerationFlag = true;
            });


            chatInput.addEventListener('input', () => {
                autoResizeTextarea(chatInput);
                updateSendButtonState();
            });
            chatInput.addEventListener('keydown', handleTextareaKeydown);

            if (recognition) {
                micBtn.addEventListener('click', toggleVoiceRecognition);
                recognition.onresult = handleVoiceResult;
                recognition.onend = () => micIcon.classList.remove('mic-active', 'animate-pulse');
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                };
            } else {
                 micBtn.disabled = true;
            }

            // Event delegation for action buttons on dynamically added chat messages
            chatContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button.copy-btn, button.regenerate-btn, button.like-btn, button.dislike-btn');
                if (!button) return;

                const messageElement = button.closest('.chat-message');
                if (!messageElement) return;

                const proseElement = messageElement.querySelector('.prose');
                const responseText = proseElement ? proseElement.innerText : '';

                if (button.classList.contains('copy-btn')) {
                    const originalIcon = button.innerHTML;
                    navigator.clipboard.writeText(responseText).then(() => {
                        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                    });
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                    }, 1500);
                } else if (button.classList.contains('regenerate-btn')) {
                    const messageIndex = Array.from(chatContainer.children).indexOf(messageElement);
                    regenerateMessage(messageIndex);
                } else if (button.classList.contains('like-btn')) {
                    const dislikeBtn = messageElement.querySelector('.dislike-btn');
                    button.classList.toggle('active-like');
                    if (button.classList.contains('active-like')) {
                        dislikeBtn.classList.remove('active-dislike');
                    }
                } else if (button.classList.contains('dislike-btn')) {
                    const likeBtn = messageElement.querySelector('.like-btn');
                    button.classList.toggle('active-dislike');
                    if (button.classList.contains('active-dislike')) {
                        likeBtn.classList.remove('active-like');
                    }
                }
            });
        }

        // --- AUTHENTICATION LOGIC ---
        async function handleLogin(e) {
            e.preventDefault();
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Login error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            if(!validateForm()) return;

            const submitBtn = signupForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const fullName = signupNameInput.value.trim();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Signup error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Google Sign-in error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                allChats = {};
                currentChatId = null;
                chatContainer.innerHTML = '';
                historyList.innerHTML = '';
            } catch (error) {
                console.error("Logout error", error);
            }
        }

        // --- ADVANCED AUTH UI & HELPERS ---
        function getFriendlyAuthError(error) {
            switch(error.code) {
                case 'auth/invalid-email': return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid email or password. Please try again.';
                case 'auth/email-already-in-use': return 'This email is already registered. Please log in.';
                case 'auth/weak-password': return 'Password is too weak. Please use at least 6 characters.';
                default: return 'An unexpected error occurred. Please try again.';
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('svg');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 013.542-5.45m5.545-2.271A10.02 10.02 0 0112 5c4.478 0 8.268 2.943 9.542 7a10.02 10.02 0 01-1.343 2.596m-3.41-3.41a3 3 0 11-4.243-4.243" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />`;
            } else {
                input.type = 'password';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
            }
        }

        function updatePasswordStrength() {
            const password = signupPasswordInput.value;
            let strength = 0;
            if (password.length > 5) strength++;
            if (password.length > 7) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;

            let color = 'bg-slate-600';
            if (strength <= 2) color = 'bg-red-500';
            else if (strength <= 4) color = 'bg-yellow-500';
            else color = 'bg-green-500';

            passwordStrengthBar.className = `rounded-full ${color}`;
            passwordStrengthBar.style.width = `${(strength / 5) * 100}%`;
            validatePassword();
        }

        function validateEmail() {
            const email = document.getElementById('signup-email').value;
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (!re.test(String(email).toLowerCase())) {
                emailError.textContent = 'Please enter a valid email address.';
                emailError.classList.remove('hidden');
                return false;
            }
            emailError.classList.add('hidden');
            return true;
        }

        function validatePassword() {
            const password = signupPasswordInput.value;
            if (password.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters long.';
                passwordError.classList.remove('hidden');
                return false;
            }
            passwordError.classList.add('hidden');
            return true;
        }

        function validateForm() {
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            const isNameValid = signupNameInput.value.trim() !== '';
            return isEmailValid && isPasswordValid && isNameValid;
        }

        function toggleButtonLoading(button, isLoading) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.button-loader');
            button.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }


        // --- CHAT LOGIC ---
        async function handleSendMessage(e) {
            if(e) e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput || !currentUser) return;

            if (!API_KEY || API_KEY.includes('YOUR_API_KEY_HERE')) {
                appendMessage("`Error`: API Key is missing.\n\nPlease add your Google AI Gemini API key in the `<script>` section of the HTML file to enable the chat functionality.", 'model-error');
                return;
            }

            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;

            if (!currentChatId) {
                try {
                     const title = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                     const newChatRef = await addDoc(collection(db, "users", currentUser.uid, "chats"), {
                        title: title,
                        createdAt: new Date()
                    });
                    currentChatId = newChatRef.id;
                    allChats[currentChatId] = { id: currentChatId, createdAt: new Date(), title: title, messages: [] };
                    renderHistorySidebar();
                } catch (error) {
                    console.error("Error creating new chat:", error);
                    appendMessage("Error: Could not start a new chat session.", "model-error");
                    toggleForm(true);
                    generationControls.classList.add('hidden');
                    return;
                }
            }

            appendMessage(userInput, 'user');

            const userMessage = { role: 'user', parts: [{ text: userInput }], timestamp: new Date() };
            allChats[currentChatId].messages.push(userMessage);
            await addDoc(collection(db, "users", currentUser.uid, "chats", currentChatId, "messages"), userMessage);

            if(allChats[currentChatId].messages.length === 1) {
                const newTitle = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                await updateDoc(doc(db, "users", currentUser.uid, "chats", currentChatId), { title: newTitle });
                allChats[currentChatId].title = newTitle;
                renderHistorySidebar();
            }

            chatInput.value = '';
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            appendLoadingIndicator();
            scrollToBottom();

            try {
                const apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: apiMessages }),
                });

                removeLoadingIndicator();
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText) {
                    const messageId = appendMessage('', 'model');
                    const messageElement = document.getElementById(messageId);
                    const contentContainer = messageElement.querySelector('.prose');

                    const finalText = await streamResponse(contentContainer, aiResponseText, messageId);

                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    await addDoc(collection(db, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);

                } else {
                    appendMessage("I couldn't generate a response. The response was empty.", 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage(`Error: ${error.message}`, 'model-error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
            }
        }

        async function regenerateMessage(messageIndex) {
            if (!currentChatId || !allChats[currentChatId] || !API_KEY) return;

            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;

            try {
                const messagesToRegen = allChats[currentChatId].messages.slice(0, messageIndex);
                const apiMessages = messagesToRegen.map(({ role, parts }) => ({ role, parts }));

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: apiMessages }),
                });

                if (!response.ok) throw new Error((await response.json()).error?.message);

                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText && !stopGenerationFlag) {
                    const messageElement = chatContainer.children[messageIndex];
                    if (messageElement) {
                        const contentContainer = messageElement.querySelector('.prose');
                        if (contentContainer) {
                            contentContainer.innerHTML = '';
                            const finalText = await streamResponse(contentContainer, aiResponseText, messageElement.id);
                            const regeneratedMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                            allChats[currentChatId].messages[messageIndex] = regeneratedMessage;
                            // In a full implementation, you'd also update this specific message in Firestore.
                        }
                    }
                }
            } catch (error) {
                console.error('Error regenerating response:', error);
                appendMessage(`Error regenerating response: ${error.message}`, 'model-error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
            }
        }

        // --- UI & DOM MANIPULATION ---
        function handleTextareaKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey && !submitButton.disabled) {
                e.preventDefault();
                handleSendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.style.overflowY = textarea.scrollHeight > 200 ? 'auto' : 'hidden';
        }

        function appendMessage(text, sender) {
            const messageId = `msg-${sender}-${Date.now()}`;
            const isModel = sender === 'model' || sender === 'model-error';
            const messageContainerMaxWidth = 'max-w-3xl';
            const messageContentHtml = `<div class="prose max-w-none text-slate-200"></div>`;

            let userAvatarHtml = '';
            if (sender === 'user' && currentUser) {
                if(currentUser.photoURL) {
                    userAvatarHtml = `<img src="${currentUser.photoURL}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full">`;
                } else {
                    const initial = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                    userAvatarHtml = `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold text-white flex-shrink-0">${initial}</div>`;
                }
            }

            const isError = sender === 'model-error';
            const modelIconHtml = `<div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br ${isError ? 'from-red-500 to-orange-600' : 'from-cyan-500 to-blue-600'} flex items-center justify-center shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 sm:w-6 sm:h-6 text-white"><path d="m12 14 4-4"/><path d="m12 14 4 4"/><path d="M12 14H2.5"/><path d="M12 14v7.5"/><path d="m20 10-4-4"/><path d="m20 10-4 4"/><path d="M20 10h-7.5"/><path d="M4 14v-2.5"/><path d="M4 14H2.5"/><path d="M4 14l-1.5-1.5L4 11l1.5 1.5L4 14Z"/><path d="m12 6-2-2-2 2-2-2-2 2-2-2-2 2"/><path d="M12 6V2.5"/></svg></div>`;

            const actionButtonsHtml = `
                <div class="action-buttons">
                    <button class="copy-btn" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button>
                    <button class="regenerate-btn" title="Regenerate"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg></button>
                    <button class="like-btn" title="Like"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 18.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88Z"/></svg></button>
                    <button class="dislike-btn" title="Dislike"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a2 2 0 0 1-1.79-1.11L9 18.12Z"/></svg></button>
                </div>`;

            const messageHtml = sender === 'user' ?
                `<div id="${messageId}" class="chat-message flex items-start gap-2 sm:gap-3 justify-end"><div class="bg-cyan-600 rounded-lg p-3 sm:p-4 ${messageContainerMaxWidth} shadow-lg"><div class="prose max-w-none text-white">${marked.parse(text)}</div></div><div class="flex-shrink-0">${userAvatarHtml}</div></div>` :
                `<div id="${messageId}" class="chat-message flex items-start gap-2 sm:gap-3"><div class="flex-shrink-0">${modelIconHtml}</div><div class="${isError ? 'bg-red-900/50' : 'bg-slate-800'} rounded-lg p-3 sm:p-4 ${messageContainerMaxWidth} shadow-lg">${messageContentHtml}</div>${isModel ? actionButtonsHtml : ''}</div>`;

            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            const messageElement = document.getElementById(messageId);
            const contentContainer = messageElement.querySelector('.prose');

            if (isModel && contentContainer) {
                 contentContainer.innerHTML = marked.parse(text);
                 makeTablesResponsive(contentContainer);
                 enhanceCodeBlocks(messageId);
            }

            scrollToBottom();
            return messageId;
        }

        function streamResponse(contentContainer, fullText, messageId) {
            return new Promise((resolve) => {
                let currentText = '';
                let index = 0;
                const typingSpeed = 10;

                function type() {
                    if (stopGenerationFlag || index >= fullText.length) {
                        const finalHtml = marked.parse(currentText);
                        contentContainer.innerHTML = finalHtml;
                        makeTablesResponsive(contentContainer);
                        enhanceCodeBlocks(messageId);
                        resolve(currentText);
                        return;
                    }

                    currentText += fullText[index];
                    index++;
                    const tempHtml = marked.parse(currentText + ''); // Use block char as cursor
                    contentContainer.innerHTML = tempHtml;
                    scrollToBottom();
                    setTimeout(type, typingSpeed);
                }
                type();
            });
        }

        function makeTablesResponsive(element) {
            if (!element) return;
            element.querySelectorAll('table').forEach(table => {
                if (table.parentElement.classList.contains('table-responsive-wrapper')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'table-responsive-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }


        function enhanceCodeBlocks(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            messageElement.querySelectorAll('pre').forEach(block => {
                const code = block.querySelector('code');
                if (!code || block.querySelector('.code-btn-wrapper')) return;

                const btnWrapper = document.createElement('div');
                btnWrapper.className = 'code-btn-wrapper';

                const language = Array.from(code.classList).find(c => c.startsWith('language-'))?.replace('language-', '');
                if (['html', 'markup', 'xml'].includes(language)) {
                    const previewBtn = document.createElement('button');
                    previewBtn.className = 'code-action-btn';
                    previewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg> <span>Preview</span>`;
                    previewBtn.addEventListener('click', () => showPreviewModal(code.innerText));
                    btnWrapper.appendChild(previewBtn);
                }

                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg> <span>Copy</span>`;
                copyBtn.addEventListener('click', () => {
                    const originalContent = copyBtn.innerHTML;
                    navigator.clipboard.writeText(code.innerText).then(() => {
                        copyBtn.innerHTML = `<span>Copied!</span>`;
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        copyBtn.innerHTML = `<span>Error</span>`;
                    });
                    setTimeout(() => { copyBtn.innerHTML = originalContent; }, 2000);
                });
                btnWrapper.appendChild(copyBtn);

                block.appendChild(btnWrapper);
            });
        }

        function updateSendButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            submitButton.disabled = !hasText;
            submitButton.classList.toggle('bg-slate-700', !hasText);
            submitButton.classList.toggle('hover:bg-cyan-700', hasText);
            submitButton.classList.toggle('bg-cyan-600', hasText);
        }

        function renderHistorySidebar() {
            historyList.innerHTML = '';
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            clearAllBtn.style.display = sortedChats.length > 0 ? 'block' : 'none';

            sortedChats.forEach(chat => {
                const li = document.createElement('li');
                const isActive = chat.id === currentChatId;
                li.className = `history-item-container flex items-center justify-between rounded-md ${isActive ? 'bg-slate-700' : 'hover:bg-slate-700/50'}`;

                const titleBtn = document.createElement('button');
                titleBtn.className = `flex-1 text-left px-3 py-2 truncate ${isActive ? 'text-white' : 'text-slate-400 hover:text-slate-200'}`;
                titleBtn.textContent = chat.title || 'New Chat';
                titleBtn.addEventListener('click', () => loadChat(chat.id));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-chat-btn p-2 text-slate-500 hover:text-red-500 transition-opacity duration-200 opacity-0';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteModal(chat.id);
                });

                li.appendChild(titleBtn);
                li.appendChild(deleteBtn);
                historyList.appendChild(li);
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
        }

        function toggleForm(isEnabled) {
            chatInput.disabled = !isEnabled;
            micBtn.disabled = !isEnabled;
            if(isEnabled) {
                updateSendButtonState();
                chatInput.focus();
            } else {
                submitButton.disabled = true;
            }
        }

        function scrollToBottom() {
            const mainArea = chatContainer.parentElement;
            mainArea.scrollTop = mainArea.scrollHeight;
        }

        // --- HISTORY & STATE MANAGEMENT (FIRESTORE) ---
        function startNewChat() {
            currentChatId = null;
            chatContainer.innerHTML = '';
            const userName = currentUser ? (currentUser.displayName || "there") : "there";
            const welcomeMessage = `Hello ${userName}! Welcome to Chat@AI. How can I help you today?`;

            const messageId = appendMessage("", 'model');
            const messageElement = document.getElementById(messageId);
            const contentContainer = messageElement.querySelector('.prose');

            streamResponse(contentContainer, welcomeMessage, messageId);
            renderHistorySidebar();

            if (window.innerWidth < 1024) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            }
        }

        async function loadChat(chatId) {
            if (!currentUser || !allChats[chatId]) return;
            currentChatId = chatId;
            chatContainer.innerHTML = '';

            const messagesQuery = query(collection(db, "users", currentUser.uid, "chats", chatId, "messages"));
            const messagesSnapshot = await getDocs(messagesQuery);
            const messages = messagesSnapshot.docs.map(doc => doc.data()).sort((a,b) => a.timestamp.toMillis() - b.timestamp.toMillis());
            allChats[chatId].messages = messages;

            messages.forEach(msg => appendMessage(msg.parts[0].text, msg.role));

            renderHistorySidebar();
            scrollToBottom();
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        async function loadChatsFromFirestore() {
            if (!currentUser) return;
            const chatsQuery = query(collection(db, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            allChats = {};
            querySnapshot.forEach((doc) => {
                allChats[doc.id] = { id: doc.id, ...doc.data(), messages: [] };
            });

            loadMostRecentChat();
        }

        function loadMostRecentChat() {
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            if (sortedChats.length > 0) {
                loadChat(sortedChats[0].id);
            } else {
                startNewChat();
            }
        }

        function showDeleteModal(chatId) {
            chatIdToDelete = chatId;
            deleteModalTitle.textContent = chatId ? "Delete Chat?" : "Delete All Chats?";
            deleteModalText.textContent = `This will permanently delete ${chatId ? 'this conversation' : 'all conversations'}. This action cannot be undone.`;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function hideDeleteModal() {
            chatIdToDelete = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }

        function showPreviewModal(htmlCode) {
            const fullHtml = `<html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="https://cdn.tailwindcss.com"><\/script></head><body>${htmlCode}</body></html>`;
            previewIframe.srcdoc = fullHtml;
            previewModal.classList.remove('hidden');
            previewModal.classList.add('flex');
        }

        function hidePreviewModal() {
            previewIframe.srcdoc = '';
            previewModal.classList.add('hidden');
            previewModal.classList.remove('flex');
        }

        async function confirmDeletion() {
            if (chatIdToDelete) {
                await handleSingleDelete();
            } else {
                await handleDeleteAll();
            }
        }

        async function handleSingleDelete() {
            if (!chatIdToDelete || !currentUser) return;
            const wasCurrentChat = chatIdToDelete === currentChatId;
            await deleteDoc(doc(db, "users", currentUser.uid, "chats", chatIdToDelete));
            delete allChats[chatIdToDelete];
            renderHistorySidebar();
            if (wasCurrentChat) loadMostRecentChat();
            hideDeleteModal();
        }

        async function handleDeleteAll() {
            if(!currentUser) return;
            const chatsQuery = query(collection(db, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            allChats = {};
            renderHistorySidebar();
            startNewChat();
            hideDeleteModal();
        }

        // --- VOICE INPUT ---
        function toggleVoiceRecognition() {
            if (micIcon.classList.contains('mic-active')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    micIcon.classList.add('mic-active', 'animate-pulse');
                } catch(e) { console.error("Could not start recognition:", e) }
            }
        }

        function handleVoiceResult(event) {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            updateSendButtonState();
            autoResizeTextarea(chatInput);
        }

        function appendLoadingIndicator() {
            const loadingHtml = `
                <div id="loading-indicator" class="flex items-center gap-2 sm:gap-3">
                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 sm:w-6 sm:h-6 text-white"><path d="m12 14 4-4"/><path d="m12 14 4 4"/><path d="M12 14H2.5"/><path d="M12 14v7.5"/><path d="m20 10-4-4"/><path d="m20 10-4 4"/><path d='M20 10h-7.5'/><path d="M4 14v-2.5"/><path d="M4 14H2.5"/><path d="M4 14l-1.5-1.5L4 11l1.5 1.5L4 14Z"/><path d="m12 6-2-2-2 2-2-2-2 2-2-2-2 2"/><path d="M12 6V2.5"/></svg>
                    </div>
                    <div class="rounded-lg max-w-lg flex items-center justify-center">
                        <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 120px; height: 120px;" loop autoplay></dotlottie-player>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
        }

        // --- GLOBAL HELPER FUNCTIONS ---
        window.togglePasswordVisibility = togglePasswordVisibility;

    </script>
</body>
</html>
