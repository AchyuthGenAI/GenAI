<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat@AI - Your Intelligent Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Lottie Player Script -->
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <style>
        /* Theme CSS Variables */
        :root {
            /* Light Theme */
            --bg-primary: 255, 255, 255;
            --bg-secondary: 248, 250, 252;
            --bg-tertiary: 241, 245, 249;
            --bg-quaternary: 226, 232, 240;
            --bg-accent: 37, 99, 235;
            --bg-accent-hover: 29, 78, 216;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 15, 23, 42;
            --text-secondary: 51, 65, 85;
            --text-tertiary: 100, 116, 139;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 255, 255, 255;
            --text-accent: 37, 99, 235;
            --text-success: 22, 163, 74;
            --text-error: 220, 38, 38;
            --text-warning: 217, 119, 6;
            
            --border-primary: 226, 232, 240;
            --border-secondary: 203, 213, 225;
            --border-accent: 37, 99, 235;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: 15, 23, 42;
            --bg-secondary: 30, 41, 59;
            --bg-tertiary: 51, 65, 85;
            --bg-quaternary: 71, 85, 105;
            --bg-accent: 6, 182, 212;
            --bg-accent-hover: 8, 145, 178;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 248, 250, 252;
            --text-secondary: 226, 232, 240;
            --text-tertiary: 203, 213, 225;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 15, 23, 42;
            --text-accent: 34, 211, 238;
            --text-success: 74, 222, 128;
            --text-error: 248, 113, 113;
            --text-warning: 251, 191, 36;
            
            --border-primary: 51, 65, 85;
            --border-secondary: 71, 85, 105;
            --border-accent: 6, 182, 212;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        [data-theme="midnight"] {
            /* Midnight Dark Theme */
            --bg-primary: 3, 7, 18;
            --bg-secondary: 15, 23, 42;
            --bg-tertiary: 30, 41, 59;
            --bg-quaternary: 51, 65, 85;
            --bg-accent: 139, 92, 246;
            --bg-accent-hover: 124, 58, 237;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 255, 255, 255;
            --text-secondary: 241, 245, 249;
            --text-tertiary: 226, 232, 240;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 3, 7, 18;
            --text-accent: 196, 181, 253;
            --text-success: 74, 222, 128;
            --text-error: 248, 113, 113;
            --text-warning: 251, 191, 36;
            
            --border-primary: 30, 41, 59;
            --border-secondary: 51, 65, 85;
            --border-accent: 139, 92, 246;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        /* Theme-aware classes */
        .bg-theme-primary { background-color: rgb(var(--bg-primary)); }
        .bg-theme-secondary { background-color: rgb(var(--bg-secondary)); }
        .bg-theme-tertiary { background-color: rgb(var(--bg-tertiary)); }
        .bg-theme-quaternary { background-color: rgb(var(--bg-quaternary)); }
        .bg-theme-accent { background-color: rgb(var(--bg-accent)); }
        .bg-theme-success { background-color: rgb(var(--bg-success)); }
        .bg-theme-error { background-color: rgb(var(--bg-error)); }
        .bg-theme-warning { background-color: rgb(var(--bg-warning)); }

        .text-theme-primary { color: rgb(var(--text-primary)); }
        .text-theme-secondary { color: rgb(var(--text-secondary)); }
        .text-theme-tertiary { color: rgb(var(--text-tertiary)); }
        .text-theme-quaternary { color: rgb(var(--text-quaternary)); }
        .text-theme-inverse { color: rgb(var(--text-inverse)); }
        .text-theme-accent { color: rgb(var(--text-accent)); }
        .text-theme-success { color: rgb(var(--text-success)); }
        .text-theme-error { color: rgb(var(--text-error)); }
        .text-theme-warning { color: rgb(var(--text-warning)); }

        .border-theme-primary { border-color: rgb(var(--border-primary)); }
        .border-theme-secondary { border-color: rgb(var(--border-secondary)); }
        .border-theme-accent { border-color: rgb(var(--border-accent)); }

        .hover\:bg-theme-accent:hover { background-color: rgb(var(--bg-accent-hover)); }
        .hover\:bg-theme-tertiary:hover { background-color: rgb(var(--bg-tertiary)); }
        .hover\:bg-theme-quaternary:hover { background-color: rgb(var(--bg-quaternary)); }

        /* Medical mode specific styles */
        .medical-mode-indicator {
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .medical-disclaimer {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .medical-feature-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        .medical-feature-card:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border-color: rgba(16, 185, 129, 0.5);
            transform: translateY(-2px);
        }

        /* Theme selector styles */
        .theme-selector {
            position: relative;
        }

        .theme-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            width: 150px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .theme-dropdown.show { display: block; }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: rgb(var(--text-secondary));
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .theme-option:hover {
            background-color: rgb(var(--bg-tertiary));
        }
        .theme-option.active {
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
        }

        /* Custom scrollbar for themed appearance */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: rgb(var(--bg-secondary)); }
        ::-webkit-scrollbar-thumb { background: rgb(var(--bg-quaternary)); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(var(--border-secondary)); }

        html, body { 
            font-family: 'Inter', sans-serif;
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
        }
        
        .main-content {
            min-width: 0;
        }
        
        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        .mic-active { color: rgb(var(--text-error)); }
        #chat-input {
            max-height: 200px;
            resize: none;
        }

        /* Enhanced Prose Styling - Claude-like formatting */
        .prose { 
            color: rgb(var(--text-secondary));
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.75;
            font-size: 1rem;
        }

        /* Improved Typography Hierarchy */
        .prose h1 { 
            color: rgb(var(--text-primary)); 
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.02em;
        }
        .prose h2 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.75rem;
            font-weight: 600;
            line-height: 1.3;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }
        .prose h3 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.4;
            margin-top: 1.75rem;
            margin-bottom: 0.75rem;
            font-family: 'Inter', sans-serif;
        }
        .prose h4 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.4;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-family: 'Inter', sans-serif;
        }
        .prose h5 { 
            color: rgb(var(--text-primary)); 
            font-size: 1.125rem;
            font-weight: 600;
            line-height: 1.4;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            font-family: 'Inter', sans-serif;
        }
        .prose h6 { 
            color: rgb(var(--text-primary)); 
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.4;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            font-family: 'Inter', sans-serif;
        }

        /* Enhanced Paragraph Styling */
        .prose p { 
            margin-bottom: 1.25rem;
            line-height: 1.75;
            color: rgb(var(--text-secondary));
        }
        .prose p:last-child { margin-bottom: 0; }

        /* Improved Link Styling */
        .prose a { 
            color: rgb(var(--text-accent));
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .prose a:hover {
            border-bottom-color: rgb(var(--text-accent));
        }

        /* Enhanced Strong/Bold Text */
        .prose strong, .prose b { 
            color: rgb(var(--text-primary));
            font-weight: 600;
        }

        /* Enhanced Emphasis */
        .prose em, .prose i {
            color: rgb(var(--text-primary));
            font-style: italic;
        }

        /* Enhanced List Styling */
        .prose ul, .prose ol {
            margin-bottom: 1.25rem;
            padding-left: 1.5rem;
        }
        .prose ul li {
            margin-bottom: 0.5rem;
            position: relative;
        }
        .prose ul li::marker { 
            color: rgb(var(--text-accent));
        }
        .prose ol li {
            margin-bottom: 0.5rem;
            position: relative;
        }
        .prose ol li::marker { 
            color: rgb(var(--text-accent));
            font-weight: 600;
        }
        .prose li > ul, .prose li > ol {
            margin-top: 0.5rem;
            margin-bottom: 0;
        }

        /* Enhanced Blockquote Styling */
        .prose blockquote {
            border-left: 4px solid rgb(var(--text-accent));
            padding-left: 1.5rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            margin: 1.5rem 0;
            background-color: rgba(var(--bg-accent), 0.05);
            border-radius: 0 0.5rem 0.5rem 0;
            font-style: italic;
            color: rgb(var(--text-tertiary));
        }
        .prose blockquote p {
            margin-bottom: 0.75rem;
        }
        .prose blockquote p:last-child {
            margin-bottom: 0;
        }

        /* Enhanced Code Styling */
        .prose code { 
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            background-color: rgba(var(--bg-tertiary), 0.8);
            color: rgb(var(--text-accent));
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid rgba(var(--border-primary), 0.5);
            font-weight: 500;
        }

        /* Enhanced Pre/Code Block Styling */
        .prose pre {
            background-color: rgb(var(--bg-quaternary));
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
            overflow-x: auto; 
            margin: 1.5rem 0;
            border: 1px solid rgb(var(--border-primary));
            box-shadow: var(--shadow);
        }
        .prose pre code { 
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            background: none;
            color: rgb(var(--text-primary));
            padding: 0;
            border: none;
            border-radius: 0;
        }

        /* Code Action Buttons */
        .code-btn-wrapper {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .prose pre:hover .code-btn-wrapper { opacity: 1; }
        .code-action-btn {
            background-color: rgba(var(--bg-primary), 0.9);
            color: rgb(var(--text-secondary));
            border: 1px solid rgba(var(--border-primary), 0.5);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
        }
        .code-action-btn:hover {
            background-color: rgb(var(--bg-tertiary));
            border-color: rgb(var(--border-secondary));
        }

        /* Enhanced Table Styling */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.875rem;
            background-color: rgb(var(--bg-primary));
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .prose th, .prose td {
            border: 1px solid rgb(var(--border-primary));
            padding: 0.875rem 1rem;
            text-align: left;
            vertical-align: top;
        }
        .prose th {
            background-color: rgb(var(--bg-tertiary));
            font-weight: 600;
            color: rgb(var(--text-primary));
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .prose tbody tr:nth-child(even) { 
            background-color: rgba(var(--bg-tertiary), 0.3); 
        }
        .prose tbody tr:hover {
            background-color: rgba(var(--bg-tertiary), 0.5);
        }
        .table-responsive-wrapper {
            overflow-x: auto;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            margin: 1.5rem 0;
            box-shadow: var(--shadow);
        }
        .table-responsive-wrapper table {
            margin: 0 !important;
            border-radius: 0;
            box-shadow: none;
        }

        /* Enhanced HR Styling */
        .prose hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgb(var(--border-primary)), transparent);
            margin: 2rem 0;
        }

        /* Enhanced Image Styling */
        .prose img {
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            margin: 1.5rem 0;
        }

        /* Responsive Design for Prose */
        @media (max-width: 768px) {
            .prose {
                font-size: 0.9rem;
            }
            .prose h1 { font-size: 1.75rem; }
            .prose h2 { font-size: 1.5rem; }
            .prose h3 { font-size: 1.25rem; }
            .prose h4 { font-size: 1.125rem; }
            .prose pre {
                padding: 1rem;
            }
        }

        /* Typing Animation */
        .typing-cursor {
            animation: blink 1s step-end infinite;
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background-color: rgb(var(--text-tertiary));
            vertical-align: sub;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: rgb(var(--text-tertiary)); }
        }

        /* Additional UI Components */
        .history-item-container:hover .history-item-actions { opacity: 1; }
        .history-item-actions {
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }

        .auth-container { background: rgb(var(--bg-primary)); }
        
        .profile-dropdown, .export-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: rgb(var(--bg-secondary));
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgb(var(--border-primary));
            width: 200px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .profile-dropdown.show, .export-dropdown.show { display: block; }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: rgb(var(--text-secondary));
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-primary));
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: rgb(var(--text-quaternary));
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgb(var(--border-primary));
        }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        #password-strength-bar {
            height: 5px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }

        .chat-message {
            position: relative;
            padding-bottom: 2.5rem;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            position: absolute;
            bottom: 0.5rem;
            left: 56px;
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }
        .chat-message.user .action-buttons {
            right: 56px;
            left: auto;
        }

        .chat-message:hover .action-buttons {
            opacity: 1;
        }

        .action-buttons button, .action-buttons a {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: none;
            padding: 0;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
            text-decoration: none;
        }
        .action-buttons button:hover, .action-buttons a:hover {
            background-color: rgb(var(--bg-quaternary));
            color: rgb(var(--text-primary));
        }
        .action-buttons button:active, .action-buttons a:active {
            transform: scale(0.95);
        }
        .action-buttons .active-like {
            background-color: rgb(var(--bg-secondary));
            color: rgb(var(--text-success));
        }
        .action-buttons .active-dislike {
            background-color: rgb(var(--bg-secondary));
            color: rgb(var(--text-error));
        }
        .action-buttons .interactive-btn {
            width: auto;
            padding: 0 0.5rem;
        }
         .action-buttons .interactive-btn span {
            font-size: 0.75rem;
            line-height: 1rem;
            margin-left: 0.25rem;
         }

        /* TTS Button Styles */
        .action-buttons .tts-button {
            position: relative;
        }
        .action-buttons .tts-button.speaking {
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
        }
        .action-buttons .tts-button.speaking::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid rgb(var(--bg-accent));
            border-radius: 0.5rem;
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.1);
                opacity: 0;
            }
        }

        .sidebar-overlay {
            z-index: 40;
        }

        .welcome-card {
            background: linear-gradient(135deg, rgb(var(--bg-secondary)) 0%, rgb(var(--bg-tertiary)) 100%);
            border: 1px solid rgb(var(--border-secondary));
        }

        .feature-card {
            background: rgba(var(--bg-tertiary), 0.5);
            border: 1px solid rgb(var(--border-primary));
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            background: rgba(var(--bg-tertiary), 0.8);
            border-color: rgb(var(--border-secondary));
            transform: translateY(-2px);
        }
        
        .suggestion-card {
            background-color: rgba(var(--bg-tertiary), 0.5);
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            text-align: left;
            width: 100%;
        }
        .suggestion-card:hover {
            background-color: rgba(var(--bg-tertiary), 0.8);
            border-color: rgb(var(--border-secondary));
            transform: translateY(-2px);
        }

        .help-tooltip {
            position: relative;
        }
        .help-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgb(var(--bg-secondary));
            color: rgb(var(--text-primary));
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            border: 1px solid rgb(var(--border-primary));
        }

        /* Scroll to Bottom Button */
        .scroll-to-bottom-btn {
            position: fixed;
            bottom: 150px;
            right: 2rem;
            width: 48px;
            height: 48px;
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            border: none;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
        }

        .scroll-to-bottom-btn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-to-bottom-btn:hover {
            background-color: rgb(var(--bg-accent-hover));
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -3px rgba(0, 0, 0, 0.15), 0 6px 8px -2px rgba(0, 0, 0, 0.1);
        }

        .scroll-to-bottom-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .scroll-to-bottom-btn {
                right: 1rem;
                bottom: 120px;
                width: 44px;
                height: 44px;
            }
        }

        @media (max-width: 1023px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1rem;
            color: rgb(var(--text-primary));
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            border-color: rgb(var(--text-success));
        }
        .notification.error {
            border-color: rgb(var(--text-error));
        }
        
        /* Multimedia upload */
        #file-preview-container {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: none;
            position: relative;
            background: rgb(var(--bg-tertiary));
            border-radius: 0.5rem;
        }
        #file-preview-container img, #file-preview-container video {
            max-height: 100px;
            border-radius: 0.25rem;
        }
        #file-preview-container audio {
            width: 100%;
        }
        #remove-file-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background: rgb(var(--bg-error));
            color: rgb(var(--text-inverse));
            border-radius: 9999px;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgb(var(--bg-secondary));
        }

        /* JSON Explorer Styles */
        .json-formatter { font-family: 'Fira Code', monospace; white-space: pre-wrap; font-size: 0.9rem; }
        .json-formatter .string { color: rgb(var(--text-accent)); }
        .json-formatter .number { color: rgb(var(--text-warning)); }
        .json-formatter .boolean { color: rgb(var(--text-error)); }
        .json-formatter .null { color: rgb(var(--text-quaternary)); }
        .json-formatter .key { color: rgb(var(--text-accent)); }
        .json-formatter details { padding-left: 1.5rem; border-left: 1px solid rgb(var(--border-secondary)); }
        .json-formatter summary { cursor: pointer; list-style: none; }
        .json-formatter summary::-webkit-details-marker { display: none; }
        .json-formatter summary::before {
            content: '►';
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.1s;
        }
        .json-formatter details[open] > summary::before {
            transform: rotate(90deg);
        }

        /* Enhanced Code Visualizer Styles with Monaco Editor */
        #code-visualizer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            height: 100%;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
        }
        
        #monaco-editor-container {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        
        #editor-toolbar {
            background: rgb(var(--bg-secondary));
            border-bottom: 1px solid rgb(var(--border-primary));
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 1rem;
        }
        
        #monaco-editor {
            height: calc(100% - 50px);
        }
        
        #visualizer-explanation-pane {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgb(var(--text-secondary));
        }
        #visualizer-state-pane {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-y: auto;
        }
        #visualizer-state-pane h4 {
            font-weight: bold;
            color: rgb(var(--text-tertiary));
            margin-bottom: 0.5rem;
        }
        #visualizer-state-pane .variable {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        #visualizer-state-pane .var-name {
            color: rgb(var(--text-accent));
        }
        #visualizer-state-pane .var-value {
            color: rgb(var(--text-accent));
        }

        /* Edit message styles */
        .edit-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            background-color: rgb(var(--bg-primary));
            color: rgb(var(--text-primary));
            font-family: inherit;
            font-size: 0.875rem;
            line-height: 1.25rem;
            resize: vertical;
            min-height: 80px;
        }
        .edit-textarea:focus {
            outline: none;
            border-color: rgb(var(--border-accent));
            box-shadow: 0 0 0 2px rgba(var(--bg-accent), 0.1);
        }
        .edit-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            justify-content: flex-end;
        }
        .edit-buttons button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-save-btn {
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            border: none;
        }
        .edit-save-btn:hover {
            background-color: rgb(var(--bg-accent-hover));
        }
        .edit-cancel-btn {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: 1px solid rgb(var(--border-primary));
        }
        .edit-cancel-btn:hover {
            background-color: rgb(var(--bg-quaternary));
        }

        /* Monaco Editor Theme Styles */
        .monaco-editor-toolbar-btn {
            background: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .monaco-editor-toolbar-btn:hover {
            background: rgb(var(--bg-quaternary));
            color: rgb(var(--text-primary));
        }
        .monaco-editor-toolbar-btn.active {
            background: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            border-color: rgb(var(--border-accent));
        }

        /* Output panel styles */
        #output-panel {
            background: rgb(var(--bg-primary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .output-line {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        
        .output-line.error {
            background: rgba(var(--bg-error), 0.1);
            color: rgb(var(--text-error));
        }
        
        .output-line.success {
            color: rgb(var(--text-success));
        }

        /* Prompt Library Styles */
        .prompt-card {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .prompt-card:hover {
            background: rgb(var(--bg-tertiary));
            border-color: rgb(var(--border-secondary));
            transform: translateY(-1px);
        }
        
        .prompt-category {
            background: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Scheduler Styles */
        .scheduled-task {
            background: rgb(var(--bg-warning));
            color: rgb(var(--text-inverse));
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .time-picker {
            background: rgb(var(--bg-tertiary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: rgb(var(--text-primary));
        }
        
        /* Profile Settings Styles */
        .settings-section {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgb(var(--border-primary));
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .toggle-switch {
            position: relative;
            width: 3rem;
            height: 1.5rem;
            background: rgb(var(--bg-quaternary));
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .toggle-switch.active {
            background: rgb(var(--bg-accent));
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            background: rgb(var(--bg-primary));
            border-radius: 50%;
            top: 0.125rem;
            left: 0.125rem;
            transition: transform 0.2s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(1.5rem);
        }
        
        .avatar-upload {
            position: relative;
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            background: rgb(var(--bg-tertiary));
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed rgb(var(--border-primary));
            transition: all 0.2s;
        }
        
        .avatar-upload:hover {
            border-color: rgb(var(--border-accent));
            background: rgb(var(--bg-quaternary));
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-content {
            background: rgb(var(--bg-primary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 32rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgb(var(--border-primary));
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgb(var(--border-primary));
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        /* Button Styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            border: none;
        }
        
        .btn-primary {
            background: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
        }
        
        .btn-primary:hover {
            background: rgb(var(--bg-accent-hover));
        }
        
        .btn-secondary {
            background: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: 1px solid rgb(var(--border-primary));
        }
        
        .btn-secondary:hover {
            background: rgb(var(--bg-quaternary));
            color: rgb(var(--text-primary));
        }
        
        .btn-success {
            background: rgb(var(--bg-success));
            color: rgb(var(--text-inverse));
        }
        
        .btn-error {
            background: rgb(var(--bg-error));
            color: rgb(var(--text-inverse));
        }
        
        .btn-warning {
            background: rgb(var(--bg-warning));
            color: rgb(var(--text-inverse));
        }
        
        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.375rem;
            background: rgb(var(--bg-tertiary));
            color: rgb(var(--text-primary));
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: rgb(var(--border-accent));
            box-shadow: 0 0 0 2px rgba(var(--bg-accent), 0.1);
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgb(var(--text-secondary));
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .inline-flex { display: inline-flex; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .rounded { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow { box-shadow: var(--shadow); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        
        /* Mobile responsiveness for code visualizer */
        @media (max-width: 768px) {
            #code-visualizer-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            #monaco-editor-container {
                grid-column: 1;
                grid-row: 1;
                min-height: 300px;
            }
            
            #visualizer-explanation-pane {
                grid-column: 1;
                grid-row: 2;
            }
            
            #visualizer-state-pane {
                grid-column: 1;
                grid-row: 3;
                max-height: 200px;
            }
            
            #editor-toolbar {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            #editor-toolbar > div {
                justify-content: center;
            }
            
            .modal-content {
                max-width: 95vw;
                margin: 0.5rem;
            }
        }

        /* Photo upload progress styles */
        .upload-progress {
            position: relative;
            background: rgb(var(--bg-tertiary));
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .upload-progress-bar {
            height: 4px;
            background: rgb(var(--bg-quaternary));
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .upload-progress-fill {
            height: 100%;
            background: rgb(var(--bg-accent));
            transition: width 0.3s ease;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-theme-primary text-theme-primary h-full overflow-hidden">
    <!-- Notification Container -->
    <div id="notification" class="notification hidden">
        <div class="flex items-center gap-2">
            <div id="notification-icon"></div>
            <span id="notification-text"></span>
        </div>
    </div>

    <!-- Scroll to Bottom Button -->
    <button id="scroll-to-bottom-btn" class="scroll-to-bottom-btn" title="Scroll to bottom">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 13l3 3 3-3"/>
            <path d="M7 6l3 3 3-3"/>
        </svg>
    </button>

    <!-- Auth Page -->
    <div id="auth-page" class="w-full h-full flex items-center justify-center auth-container p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 bg-theme-accent rounded-full flex items-center justify-center shadow-lg">
                        <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-16 h-16 rounded-full shadow-lg"/>
                    </div>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-cyan-400 mb-2">Welcome to Chat@AI</h1>
                <p class="text-theme-quaternary text-sm sm:text-base">Your intelligent AI-chat companion with advanced features.</p>
                <div class="mt-4 text-xs text-theme-quaternary">
                    <p>✨ Advanced AI conversations • 🔒 Secure authentication • 💾 Chat history • 🏥 Medical AI assistant</p>
                </div>
            </div>
            <div id="auth-error" class="bg-theme-error/20 border border-theme-error text-theme-error px-4 py-3 rounded-lg mb-6 hidden"></div>
            
            <!-- Login Form -->
            <form id="login-form" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Log In</h2>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-theme-secondary mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition">
                </div>
                <div class="relative">
                    <label for="login-password" class="block text-sm font-medium text-theme-secondary mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition pr-10">
                    <button type="button" id="login-password-toggle" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-theme-quaternary hover:text-theme-primary">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <button type="submit" class="w-full bg-theme-accent hover:bg-theme-accent text-theme-inverse font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Log In</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <p class="text-center text-theme-quaternary">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-theme-accent hover:text-theme-accent">Sign up</a>
                </p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Sign Up</h2>
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-theme-secondary mb-2">Full Name</label>
                    <input type="text" id="signup-name" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-theme-secondary mb-2">Email</label>
                    <input type="email" id="signup-email" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition">
                    <p id="email-error" class="text-theme-error text-sm mt-1 hidden"></p>
                </div>
                <div class="relative">
                    <label for="signup-password" class="block text-sm font-medium text-theme-secondary mb-2">Password</label>
                    <input type="password" id="signup-password" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition pr-10">
                     <button type="button" id="signup-password-toggle" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-theme-quaternary hover:text-theme-primary">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                 <div class="w-full bg-theme-tertiary rounded-full h-[5px]">
                    <div id="password-strength-bar" class="rounded-full"></div>
                </div>
                <p id="password-error" class="text-theme-error text-sm -mt-3 hidden"></p>

                <button type="submit" class="w-full bg-theme-accent hover:bg-theme-accent text-theme-inverse font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Sign Up</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <p class="text-center text-theme-quaternary">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-theme-accent hover:text-theme-accent">Log in</a>
                </p>
            </form>
        </div>
    </div>

    <div id="chat-app" class="hidden w-full h-full flex relative">
        <!-- Sidebar for Chat History -->
        <aside id="sidebar" class="sidebar bg-theme-secondary w-72 flex-shrink-0 flex flex-col p-4 lg:relative lg:translate-x-0">
            <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full bg-theme-accent hover:bg-theme-accent text-theme-inverse font-semibold rounded-lg px-4 py-3 transition duration-300 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>New Chat</span>
            </button>
            
            <!-- Medical AI Mode Button -->
            <button id="medical-ai-btn" class="flex items-center justify-center gap-2 w-full bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg px-4 py-3 transition duration-300 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                    <path d="M12 5L8 21l4-7 4 7-4-16"/>
                </svg>
                <span>AI Medical</span>
            </button>

            <!-- Chat@AI Mode Button (shown when in medical mode) -->
            <button id="chat-ai-btn" class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-4 py-3 transition duration-300 mb-4 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Chat@AI</span>
            </button>

            <!-- Enhanced Features Buttons -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="prompt-library-btn" class="flex items-center justify-center gap-1 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg px-3 py-2 transition duration-300 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                    </svg>
                    <span>Prompts</span>
                </button>
                <button id="scheduler-btn" class="flex items-center justify-center gap-1 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg px-3 py-2 transition duration-300 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                        <line x1="16" x2="16" y1="2" y2="6"/>
                        <line x1="8" x2="8" y1="2" y2="6"/>
                        <line x1="3" x2="21" y1="10" y2="10"/>
                    </svg>
                    <span>Schedule</span>
                </button>
            </div>
            
            <div class="relative mb-4">
                <input type="text" id="search-history-input" placeholder="Search history..." class="w-full bg-theme-tertiary/50 border border-theme-primary rounded-md pl-10 pr-4 py-2 text-sm text-theme-primary placeholder-theme-quaternary focus:outline-none focus:ring-2 focus:ring-theme-accent">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
            </div>

            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-theme-secondary">History</h2>
                <div class="flex items-center gap-2">
                    <button id="clear-all-btn" class="p-1 text-theme-quaternary hover:text-theme-error" title="Clear all chats">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto pr-2">
                <ul id="history-list" class="space-y-2">
                    <!-- Chat history items will be injected here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 flex flex-col h-full relative z-10 bg-theme-primary">
            <!-- Header -->
            <header class="bg-theme-secondary/50 backdrop-blur-sm border-b border-theme-primary shadow-lg sticky top-0 z-30">
                 <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
                     <div class="flex items-center gap-4">
                        <button id="menu-btn" class="lg:hidden p-2 -ml-2 text-theme-secondary hover:bg-theme-tertiary rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <div class="w-8 h-8 bg-theme-accent rounded-full flex items-center justify-center shadow">
                           <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 rounded-full shadow" />
                        </div>
                        <h1 class="text-xl sm:text-2xl font-bold text-theme-primary">Chat@AI</h1>
                        <!-- Medical Mode Indicator -->
                        <div id="medical-mode-indicator" class="medical-mode-indicator hidden" title="Medical AI Mode Active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                <path d="M12 5L8 21l4-7 4 7-4-16"/>
                            </svg>
                        </div>
                     </div>
                     <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Theme Selector -->
                        <div class="theme-selector relative">
                            <button id="theme-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-md px-3 py-1.5 transition-colors">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                               <span class="hidden sm:inline">Theme</span>
                            </button>
                            <div id="theme-dropdown" class="theme-dropdown">
                                <div class="theme-option" data-theme="light">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                                     <span>Light</span>
                                </div>
                                <div class="theme-option" data-theme="dark">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                                    <span>Dark</span>
                                </div>
                                <div class="theme-option" data-theme="midnight">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                                    <span>Midnight</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <button id="export-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-md px-3 py-1.5 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                               <span class="hidden sm:inline">Export</span>
                            </button>
                            <div id="export-dropdown" class="export-dropdown">
                                <button class="dropdown-item" data-format="txt">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                                     <span>As TXT</span>
                                </button>
                                <button class="dropdown-item" data-format="md">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M7 15v-4.5a1.5 1.5 0 0 1 3 0V15"></path><path d="M7 12h3"></path><path d="M12 15l2-2.5 2 2.5"></path><path d="M17 15v-5"></path></svg>
                                    <span>As Markdown</span>
                                </button>
                                <button class="dropdown-item" data-format="pdf">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M12.25 15.75a1 1 0 0 0 1.5 0v-2.5a1 1 0 0 0-1.5 0Z"/><path d="M10 12h1a2 2 0 1 1 0 4h-1v-4Z"/><path d="M15 12h1a2 2 0 0 1 0 4h-1"/></svg>
                                    <span>As PDF</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <button id="profile-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-full p-1 transition-colors">
                                <div id="profile-avatar" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white overflow-hidden"></div>
                            </button>
                            <div id="profile-dropdown" class="profile-dropdown">
                                <div class="p-4 border-b border-theme-primary">
                                    <p class="font-bold text-theme-primary truncate" id="profile-name"></p>
                                    <p class="text-sm text-theme-quaternary truncate" id="profile-email"></p>
                                </div>
                                <button id="home-btn" class="dropdown-item w-full text-theme-secondary">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        <polyline points="9 22 9 12 15 12 15 22"/>
                                     </svg>
                                    <span>Home</span>
                                </button>
                                <button id="profile-settings-btn" class="dropdown-item w-full text-theme-secondary">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                     </svg>
                                    <span>Profile Settings</span>
                                </button>
                                <button id="logout-btn" class="dropdown-item w-full text-theme-error font-medium">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Chat Area -->
            <main id="chat-main-area" class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                <div id="chat-container" class="max-w-4xl mx-auto space-y-6">
                    <!-- Welcome content will be shown here initially -->
                </div>
            </main>

            <!-- Message Input Form & Controls -->
            <footer class="bg-theme-primary/50 backdrop-blur-sm sticky bottom-0">
                 <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
                    <div id="generation-controls" class="text-center pb-2 hidden">
                        <button id="stop-generating-btn" class="bg-theme-tertiary hover:bg-theme-quaternary text-theme-primary font-semibold rounded-lg px-4 py-2 transition duration-300 flex items-center mx-auto">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                             <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                           </svg>
                            Stop Generating
                        </button>
                    </div>
                    <form id="chat-form">
                        <div id="file-preview-container">
                            <div id="file-preview"></div>
                            <button type="button" id="remove-file-btn" title="Remove file">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="flex items-end bg-theme-secondary border border-theme-primary rounded-2xl p-2 transition-all duration-300 focus-within:ring-2 focus-within:ring-theme-accent">
                            <div class="help-tooltip">
                                <button id="attach-file-btn" type="button" class="text-theme-quaternary hover:text-theme-primary p-2 rounded-full hover:bg-theme-tertiary transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                </button>
                                <div class="tooltip-content">Attach File</div>
                            </div>
                             <input type="file" id="file-input" class="hidden" accept="image/*,audio/*,video/*,.csv,.txt,.py,.js,.java,.c,.cpp">
                             
                            <textarea id="chat-input" placeholder="Enter Your Prompt or paste code to visualize..." autocomplete="off" rows="1" class="flex-1 bg-transparent px-4 py-2 text-theme-primary placeholder-theme-quaternary focus:outline-none disabled:bg-transparent disabled:cursor-not-allowed"></textarea>

                            <div class="help-tooltip">
                                <button id="mic-btn" type="button" class="text-theme-quaternary hover:text-theme-primary p-2 rounded-full hover:bg-theme-tertiary transition-colors duration-200 disabled:opacity-50">
                                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                                </button>
                                <div class="tooltip-content">
                                    Voice input (click to start)
                                </div>
                            </div>

                            <button type="submit" class="bg-theme-quaternary text-theme-primary rounded-full p-2 ml-1 transition-colors duration-300 flex items-center justify-center disabled:bg-theme-tertiary disabled:cursor-not-allowed w-10 h-10 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                            </button>
                        </div>
                    </form>
                    
                </div>
            </footer>
        </div>
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/50 backdrop-blur-sm hidden lg:hidden"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-theme-secondary rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="delete-modal-title" class="text-xl font-bold text-theme-primary mb-4">Delete Chat?</h3>
            <p id="delete-modal-text" class="text-theme-quaternary mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-theme-tertiary hover:bg-theme-quaternary transition-colors">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-theme-error hover:bg-theme-error transition-colors font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Code Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
         <div class="bg-theme-secondary rounded-lg shadow-xl w-full h-full max-w-4xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-theme-primary flex-shrink-0">
                <h3 class="text-xl font-bold text-theme-primary">Live Preview</h3>
                <button id="close-preview-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div class="flex-1 p-1 bg-white">
                <iframe id="preview-iframe" class="w-full h-full border-0 rounded-md"></iframe>
            </div>
        </div>
    </div>

    <!-- Interactive Feature Modal -->
    <div id="interactive-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
        <div class="bg-theme-secondary border border-theme-primary rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-theme-primary flex-shrink-0">
                <h3 id="interactive-modal-title" class="text-xl font-bold text-theme-primary"></h3>
                <button id="close-interactive-modal-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div id="interactive-modal-body" class="flex-1 p-0 overflow-auto bg-theme-primary">
                <!-- Content will be injected here -->
            </div>
            <footer id="interactive-modal-footer" class="p-2 border-t border-theme-primary flex-shrink-0 hidden justify-center items-center gap-2">
                <!-- Footer content like buttons will be injected here -->
            </footer>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Profile Settings</h2>
                <button id="close-profile-settings-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Avatar Section -->
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-theme-primary mb-4">Avatar</h3>
                    <div class="flex items-center gap-4">
                        <div id="current-avatar" class="w-20 h-20 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white text-2xl overflow-hidden">A</div>
                        <div class="flex-1">
                            <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                            <button id="upload-avatar-btn" class="btn btn-primary mb-2">Upload New Avatar</button>
                            <p class="text-sm text-theme-quaternary">Upload a new profile picture (JPG, PNG, GIF - Max 5MB)</p>
                            <div id="upload-progress-container" class="hidden upload-progress">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-theme-secondary">Uploading...</span>
                                    <span id="upload-progress-percent" class="text-sm text-theme-secondary">0%</span>
                                </div>
                                <div class="upload-progress-bar">
                                    <div id="upload-progress-fill" class="upload-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-theme-primary mb-4">Account</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" id="profile-name-input" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Email</label>
                            <input type="email" id="profile-email-input" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">New Password</label>
                            <input type="password" id="profile-password-input" class="form-input" placeholder="Leave blank to keep current password">
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="settings-section">
                    <h3 class="text-lg font-semibold text-theme-primary mb-4">Preferences</h3>
                    <div class="space-y-4">
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Language</label>
                                <p class="text-sm text-theme-quaternary">Choose your preferred language</p>
                            </div>
                            <select id="language-select" class="form-input w-32">
                                <option value="en">English</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Português</option>
                                <option value="ru">Русский</option>
                                <option value="ja">日本語</option>
                                <option value="ko">한국어</option>
                                <option value="zh">中文</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Font Size</label>
                                <p class="text-sm text-theme-quaternary">Adjust text size for better readability</p>
                            </div>
                            <select id="font-size-select" class="form-input w-32">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                                <option value="extra-large">Extra Large</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Auto-save Conversations</label>
                                <p class="text-sm text-theme-quaternary">Automatically save chats to cloud</p>
                            </div>
                            <div class="toggle-switch active" id="auto-save-toggle"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">Sound Effects</label>
                                <p class="text-sm text-theme-quaternary">Play sounds for notifications</p>
                            </div>
                            <div class="toggle-switch" id="sound-effects-toggle"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <label class="font-medium text-theme-primary">TTS Auto-play</label>
                                <p class="text-sm text-theme-quaternary">Automatically read AI responses</p>
                            </div>
                            <div class="toggle-switch" id="tts-autoplay-toggle"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-profile-settings-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-profile-settings-btn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Prompt Library Modal -->
    <div id="prompt-library-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 48rem;">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Prompt Library</h2>
                <button id="close-prompt-library-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <input type="text" id="search-prompts" placeholder="Search prompts..." class="form-input w-64">
                        <select id="filter-category" class="form-input w-32">
                            <option value="">All Categories</option>
                            <option value="coding">Coding</option>
                            <option value="writing">Writing</option>
                            <option value="business">Business</option>
                            <option value="creative">Creative</option>
                            <option value="education">Education</option>
                            <option value="medical">Medical</option>
                        </select>
                    </div>
                    <button id="add-prompt-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Prompt
                    </button>
                </div>
                <div id="prompts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                    <!-- Prompt cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Prompt Modal -->
    <div id="add-prompt-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="add-prompt-title" class="text-xl font-bold text-theme-primary">Add New Prompt</h2>
                <button id="close-add-prompt-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="prompt-form" class="space-y-4">
                    <div>
                        <label class="form-label">Title</label>
                        <input type="text" id="prompt-title" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Category</label>
                        <select id="prompt-category" class="form-input" required>
                            <option value="">Select Category</option>
                            <option value="coding">Coding</option>
                            <option value="writing">Writing</option>
                            <option value="business">Business</option>
                            <option value="creative">Creative</option>
                            <option value="education">Education</option>
                            <option value="medical">Medical</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Prompt Text</label>
                        <textarea id="prompt-text" class="form-input h-32" required></textarea>
                    </div>
                    <div>
                        <label class="form-label">Description (Optional)</label>
                        <textarea id="prompt-description" class="form-input h-20"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-add-prompt-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-prompt-btn" class="btn btn-primary">Save Prompt</button>
            </div>
        </div>
    </div>

    <!-- Scheduler Modal -->
    <div id="scheduler-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 48rem;">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Schedule Prompts</h2>
                <button id="close-scheduler-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-theme-primary">Scheduled Tasks</h3>
                    <button id="add-schedule-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Schedule New
                    </button>
                </div>
                <div id="scheduled-tasks" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Scheduled tasks will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div id="add-schedule-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-theme-primary">Schedule New Task</h2>
                <button id="close-add-schedule-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="schedule-form" class="space-y-4">
                    <div>
                        <label class="form-label">Task Name</label>
                        <input type="text" id="schedule-name" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Prompt</label>
                        <textarea id="schedule-prompt" class="form-input h-32" required></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="form-label">Date</label>
                            <input type="date" id="schedule-date" class="form-input" required>
                        </div>
                        <div>
                            <label class="form-label">Time</label>
                            <input type="time" id="schedule-time" class="form-input" required>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Repeat</label>
                        <select id="schedule-repeat" class="form-input">
                            <option value="none">No Repeat</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="cancel-add-schedule-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-schedule-btn" class="btn btn-primary">Schedule Task</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile,
            updatePassword,
            updateEmail,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            addDoc,
            query,
            getDocs,
            deleteDoc,
            updateDoc,
            where,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL,
            uploadBytesResumable
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- DOM Element References ---
        const authPage = document.getElementById('auth-page');
        const chatApp = document.getElementById('chat-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const emailError = document.getElementById('email-error');
        const passwordError = document.getElementById('password-error');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileAvatarContainer = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');
        const homeBtn = document.getElementById('home-btn');
        const exportBtn = document.getElementById('export-btn');
        const exportDropdown = document.getElementById('export-dropdown');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationText = document.getElementById('notification-text');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const chatMainArea = document.getElementById('chat-main-area');
        const submitButton = chatForm.querySelector('button[type="submit"]');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const medicalAiBtn = document.getElementById('medical-ai-btn');
        const chatAiBtn = document.getElementById('chat-ai-btn');
        const medicalModeIndicator = document.getElementById('medical-mode-indicator');
        const historyList = document.getElementById('history-list');
        const searchHistoryInput = document.getElementById('search-history-input');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const previewModal = document.getElementById('preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const previewIframe = document.getElementById('preview-iframe');
        const generationControls = document.getElementById('generation-controls');
        const stopGeneratingBtn = document.getElementById('stop-generating-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreview = document.getElementById('file-preview');
        const removeFileBtn = document.getElementById('remove-file-btn');
        const interactiveModal = document.getElementById('interactive-modal');
        const interactiveModalTitle = document.getElementById('interactive-modal-title');
        const interactiveModalBody = document.getElementById('interactive-modal-body');
        const interactiveModalFooter = document.getElementById('interactive-modal-footer');
        const closeInteractiveModalBtn = document.getElementById('close-interactive-modal-btn');
        const themeBtn = document.getElementById('theme-btn');
        const themeDropdown = document.getElementById('theme-dropdown');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');

        // Enhanced Feature Elements
        const promptLibraryBtn = document.getElementById('prompt-library-btn');
        const schedulerBtn = document.getElementById('scheduler-btn');
        const profileSettingsBtn = document.getElementById('profile-settings-btn');

        // Modal Elements
        const profileSettingsModal = document.getElementById('profile-settings-modal');
        const promptLibraryModal = document.getElementById('prompt-library-modal');
        const addPromptModal = document.getElementById('add-prompt-modal');
        const schedulerModal = document.getElementById('scheduler-modal');
        const addScheduleModal = document.getElementById('add-schedule-modal');
        
        // --- API & Firebase Configuration ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const API_KEY = 'AIzaSyDirhQ899FnmcWCuwfHfzS05TEenhZntwA'; // IMPORTANT: Replace with your actual Gemini API key

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAMqtiL99s78TnDyHEi8VlBbzMzZh8Jqh8",
            authDomain: "login-90932.firebaseapp.com",
            projectId: "login-90932",
            storageBucket: "login-90932.firebasestorage.app",
            messagingSenderId: "574568827002",
            appId: "1:574568827002:web:7ed038c10c3fe0bc3953c3"
        };
        
        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- State Management ---
        let currentChatId = null;
        let allChats = {};
        let chatIdToDelete = null;
        let stopGenerationFlag = false;
        let currentUser = null;
        let notificationQueue = [];
        let isNotificationVisible = false;
        let attachedFile = null;
        let chartInstance = null;
        let isMedicalMode = false;
        
        // Code visualizer state
        let visualizerSteps = [];
        let currentVisStep = 0;
        let monacoEditor = null;
        let currentLanguage = 'javascript';
        let isAutoRunEnabled = false;
        const vizLanguages = ['python', 'javascript', 'java', 'c', 'c++'];
        const fileExtensionMap = {
            '.py': 'python',
            '.js': 'javascript',
            '.java': 'java',
            '.c': 'c',
            '.cpp': 'c++'
        };

        // Smart scrolling state
        let isUserScrolledUp = false;
        let isGenerating = false;
        let lastScrollPosition = 0;
        let autoScrollThreshold = 100;

        // Theme Management
        let currentTheme = 'light';

        // TTS State Management
        let currentTTSUtterance = null;
        let isTTSActive = false;
        let currentTTSButton = null;

        // Enhanced Features State
        let userPrompts = [];
        let scheduledTasks = [];
        let userSettings = {
            language: 'en',
            fontSize: 'medium',
            autoSave: true,
            soundEffects: false,
            ttsAutoplay: false
        };
        let currentEditingPrompt = null;
        let currentEditingSchedule = null;

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // --- TEXT-TO-SPEECH FUNCTIONS ---
        
        function initializeTTS() {
            if (!window.speechSynthesis) {
                console.warn('Speech synthesis not supported in this browser');
                return false;
            }
            
            window.speechSynthesis.onvoiceschanged = () => {
                console.log('TTS voices loaded:', window.speechSynthesis.getVoices().length);
            };
            
            return true;
        }

        function getPreferredVoice() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return null;
            
            const englishVoices = voices.filter(voice => 
                voice.lang.startsWith('en') && 
                !voice.name.includes('Google')
            );
            
            const femaleVoice = englishVoices.find(voice => 
                voice.name.toLowerCase().includes('female') || 
                voice.name.toLowerCase().includes('samantha') ||
                voice.name.toLowerCase().includes('karen') ||
                voice.name.toLowerCase().includes('victoria')
            );
            
            if (femaleVoice) return femaleVoice;
            return englishVoices[0] || voices[0];
        }

        function cleanTextForTTS(text) {
            let cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/`(.*?)`/g, '$1')
                .replace(/^\s*#{1,6}\s+/gm, '')
                .replace(/^\s*[-*+]\s+/gm, '')
                .replace(/^\s*\d+\.\s+/gm, '')
                .replace(/!\[.*?\]\(.*?\)/g, '')
                .replace(/\[.*?\]\(.*?\)/g, '$1')
                .replace(/```[\s\S]*?```/g, '[Code block]')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
            
            if (cleanText.length > 2000) {
                cleanText = cleanText.substring(0, 2000) + '... [Text truncated for speech]';
            }
            
            return cleanText;
        }

        function speakText(text, button) {
            if (!window.speechSynthesis) {
                showNotification('Text-to-speech not supported in this browser', 'error');
                return;
            }
            
            if (isTTSActive) {
                stopTTS();
            }
            
            const cleanText = cleanTextForTTS(text);
            if (!cleanText.trim()) {
                showNotification('No text to speak', 'error');
                return;
            }
            
            currentTTSUtterance = new SpeechSynthesisUtterance(cleanText);
            currentTTSButton = button;
            
            const preferredVoice = getPreferredVoice();
            if (preferredVoice) {
                currentTTSUtterance.voice = preferredVoice;
            }
            
            currentTTSUtterance.rate = 0.9;
            currentTTSUtterance.pitch = 1.0;
            currentTTSUtterance.volume = 1.0;
            
            currentTTSUtterance.onstart = () => {
                isTTSActive = true;
                updateTTSButton(button, 'speaking');
                showNotification('Started speaking', 'info');
            };
            
            currentTTSUtterance.onend = () => {
                isTTSActive = false;
                updateTTSButton(button, 'idle');
                currentTTSUtterance = null;
                currentTTSButton = null;
            };
            
            currentTTSUtterance.onerror = (event) => {
                console.error('TTS error:', event.error);
                isTTSActive = false;
                updateTTSButton(button, 'idle');
                currentTTSUtterance = null;
                currentTTSButton = null;
                showNotification('Speech synthesis error', 'error');
            };
            
            currentTTSUtterance.onpause = () => {
                updateTTSButton(button, 'paused');
            };
            
            currentTTSUtterance.onresume = () => {
                updateTTSButton(button, 'speaking');
            };
            
            window.speechSynthesis.speak(currentTTSUtterance);
        }

        function stopTTS() {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            if (currentTTSButton) {
                updateTTSButton(currentTTSButton, 'idle');
            }
            
            isTTSActive = false;
            currentTTSUtterance = null;
            currentTTSButton = null;
            showNotification('Speech stopped', 'info');
        }

        function pauseTTS() {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.pause();
            }
        }

        function resumeTTS() {
            if (window.speechSynthesis && window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
            }
        }

        function updateTTSButton(button, state) {
            if (!button) return;
            
            button.classList.remove('speaking', 'paused');
            
            switch (state) {
                case 'speaking':
                    button.classList.add('speaking');
                    button.title = 'Stop speaking';
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>`;
                    break;
                case 'paused':
                    button.classList.add('paused');
                    button.title = 'Resume speaking';
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M23 9l-7 4 7 4V9z"></path></svg>`;
                    break;
                default:
                    button.title = 'Listen to response';
                    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
                    break;
            }
        }

        function handleTTSButtonClick(button, text) {
            if (isTTSActive && currentTTSButton === button) {
                stopTTS();
            } else {
                speakText(text, button);
            }
        }

        function addTTSButton(container, text) {
            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'tts-button';
            ttsBtn.title = 'Listen to response';
            ttsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            
            ttsBtn.onclick = () => handleTTSButtonClick(ttsBtn, text);
            container.insertBefore(ttsBtn, container.firstChild);
        }

        // --- MEDICAL MODE FUNCTIONS ---
        
        function toggleMedicalMode() {
            isMedicalMode = !isMedicalMode;
            medicalModeIndicator.classList.toggle('hidden', !isMedicalMode);
            
            if (isMedicalMode) {
                medicalAiBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                medicalAiBtn.classList.add('bg-green-800', 'hover:bg-green-900');
                chatAiBtn.classList.remove('hidden');
                showMedicalWelcomeContent();
                showNotification('Medical AI Mode activated', 'success');
                updateInputPlaceholder('Ask about symptoms, medications, health advice...');
            } else {
                medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
                chatAiBtn.classList.add('hidden');
                showWelcomeContent();
                showNotification('Medical AI Mode deactivated', 'info');
                updateInputPlaceholder('Enter Your Prompt or paste code to visualize...');
            }
        }

        function switchToChatAI() {
            isMedicalMode = false;
            medicalModeIndicator.classList.add('hidden');
            medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
            chatAiBtn.classList.add('hidden');
            showWelcomeContent();
            showNotification('Switched to Chat@AI mode', 'success');
            updateInputPlaceholder('Enter Your Prompt or paste code to visualize...');
        }

        function updateInputPlaceholder(placeholder) {
            chatInput.placeholder = placeholder;
        }

        function showMedicalWelcomeContent() {
            const medicalWelcomeHtml = `
                <div class="welcome-card rounded-2xl p-8 mb-6 text-center">
                    <div class="w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                            <path d="M12 5L8 21l4-7 4 7-4-16"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-theme-primary mb-4">AI Medical Assistant</h2>
                    <p class="text-theme-secondary text-lg mb-6">Your intelligent medical companion for health information, symptom analysis, and wellness guidance.</p>
                    
                    <div class="medical-disclaimer mb-6">
                        <div class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 flex-shrink-0 mt-0.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v4"/>
                                <path d="M12 16h.01"/>
                            </svg>
                            <div class="text-sm">
                                <p class="font-semibold text-red-600 mb-2">Important Medical Disclaimer</p>
                                <p class="text-theme-secondary text-left">This AI assistant provides general health information only and is not a substitute for professional medical advice, diagnosis, or treatment. Always consult with qualified healthcare providers for medical concerns. In emergencies, contact emergency services immediately.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-theme-primary mb-4">Medical AI Features:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                           <button class="medical-feature-card suggestion-card" data-suggestion="I have a headache, fatigue, and sore throat. What could be causing these symptoms?">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                                </div>
                                <span class="text-theme-secondary">Symptom Checker</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="What is Lisinopril used for and what are its common side effects?">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                                </div>
                                <span class="text-theme-secondary">Medication Information</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Check for interactions between Warfarin and Aspirin.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-red-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><path d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Drug Interactions</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Explain diabetes in simple terms that a 10-year-old could understand.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M9 12l2 2 4-4"/><path d="M21 12c-1.5 0-3-1-3-3s1.5-3 3-3 3 1 3 3-1.5 3-3 3"/><path d="M3 12c1.5 0 3-1 3-3S4.5 6 3 6s-3 1-3 3 1.5 3 3 3"/></svg>
                                </div>
                                <span class="text-theme-secondary">Simple Explanations</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Create a personalized diet plan for a 30-year-old vegetarian looking to lose weight.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-400"><path d="M2 21a8 8 0 0 1 13.292-6"/><circle cx="10" cy="8" r="5"/><path d="M19 16v6"/><path d="M22 19h-6"/></svg>
                                </div>
                                <span class="text-theme-secondary">Diet & Fitness Plans</span>
                             </div>
                           </button>
                           <button class="medical-feature-card suggestion-card" data-suggestion="Guide me through a 5-minute breathing exercise for stress relief.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Mental Wellness</span>
                             </div>
                           </button>
                        </div>
                    </div>
                </div>`;
            chatContainer.innerHTML = medicalWelcomeHtml;
            exportBtn.disabled = true;
        }

        function createMedicalPrompt(userInput) {
            const medicalSystemPrompt = `You are an AI Medical Assistant designed to provide helpful, accurate health information while maintaining appropriate medical disclaimers. Follow these guidelines:

1. **Safety First**: Always include medical disclaimers where appropriate. Remind users that this is not a substitute for professional medical advice.

2. **Emergency Situations**: If symptoms suggest a medical emergency, immediately advise seeking emergency medical care.

3. **Scope of Practice**: Provide general health information, not specific medical diagnoses or treatment recommendations.

4. **Evidence-Based**: Base responses on established medical knowledge and current best practices.

5. **Accessible Language**: Use clear, understandable language while maintaining medical accuracy.

6. **Comprehensive**: When discussing conditions, include symptoms, potential causes, general treatment approaches, and when to see a healthcare provider.

For the following categories, provide specialized responses:

**Symptom Checker**: List possible conditions, ask clarifying questions, emphasize the need for professional evaluation.

**Medication Information**: Provide uses, common side effects, general precautions, but emphasize consulting healthcare providers for personalized advice.

**Drug Interactions**: Explain potential interactions and their significance, recommend checking with pharmacists or doctors.

**Simple Explanations**: Use analogies and simple language appropriate for the requested comprehension level.

**Diet & Fitness**: Provide general guidelines based on current nutritional science, but recommend consulting nutritionists for personalized plans.

**Mental Wellness**: Offer evidence-based techniques while emphasizing professional mental health resources for serious concerns.

User Query: ${userInput}

Respond with helpful, accurate medical information while maintaining appropriate disclaimers and safety considerations.`;

            return medicalSystemPrompt;
        }

        // --- MONACO EDITOR INITIALIZATION ---
        
        function initializeMonaco() {
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                console.log('Monaco Editor loaded successfully');
            });
        }

        function createMonacoEditor(container, code, language) {
            return new Promise((resolve) => {
                require(['vs/editor/editor.main'], function () {
                    const editor = monaco.editor.create(container, {
                        value: code,
                        language: language,
                        theme: getMonacoTheme(),
                        fontSize: 14,
                        fontFamily: 'Fira Code, monospace',
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false,
                        automaticLayout: true,
                        lineNumbers: 'on',
                        roundedSelection: false,
                        scrollbar: {
                            vertical: 'visible',
                            horizontal: 'visible'
                        },
                        wordWrap: 'on'
                    });
                    
                    const observer = new MutationObserver(() => {
                        editor.updateOptions({ theme: getMonacoTheme() });
                    });
                    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
                    
                    resolve(editor);
                });
            });
        }

        function getMonacoTheme() {
            switch (currentTheme) {
                case 'dark':
                case 'midnight':
                    return 'vs-dark';
                default:
                    return 'vs';
            }
        }

        // --- SMART SCROLLING FUNCTIONS ---
        
        function isAtBottom() {
            const scrollTop = chatMainArea.scrollTop;
            const scrollHeight = chatMainArea.scrollHeight;
            const clientHeight = chatMainArea.clientHeight;
            return scrollHeight - scrollTop - clientHeight < autoScrollThreshold;
        }

        function updateScrollState() {
            isUserScrolledUp = !isAtBottom();
            updateScrollButton();
        }

        function updateScrollButton() {
            if (isUserScrolledUp && isGenerating) {
                scrollToBottomBtn.classList.add('show');
            } else {
                scrollToBottomBtn.classList.remove('show');
            }
        }

        function scrollToBottomSmooth() {
            chatMainArea.scrollTo({
                top: chatMainArea.scrollHeight,
                behavior: 'smooth'
            });
            setTimeout(() => {
                isUserScrolledUp = false;
                updateScrollButton();
            }, 300);
        }

        function scrollToBottomInstant() {
            chatMainArea.scrollTop = chatMainArea.scrollHeight;
            isUserScrolledUp = false;
            updateScrollButton();
        }

        function initializeScrollHandling() {
            chatMainArea.addEventListener('scroll', () => {
                updateScrollState();
            });
            scrollToBottomBtn.addEventListener('click', scrollToBottomSmooth);
        }

        // --- THEME FUNCTIONS ---
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeDropdown();
            
            if (monacoEditor) {
                monacoEditor.updateOptions({ theme: getMonacoTheme() });
            }
        }

        function updateThemeDropdown() {
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.classList.toggle('active', option.dataset.theme === currentTheme);
            });
        }

        function handleThemeChange(newTheme) {
            setTheme(newTheme);
            themeDropdown.classList.remove('show');
            showNotification(`Theme changed to ${newTheme}`, 'success');
        }

        // --- ENHANCED FEATURES FUNCTIONS ---

        // === PROFILE SETTINGS ===
        function showProfileSettings() {
            // Load current user data
            document.getElementById('profile-name-input').value = currentUser.displayName || '';
            document.getElementById('profile-email-input').value = currentUser.email || '';
            document.getElementById('profile-password-input').value = '';
            
            // Load current avatar
            const currentAvatar = document.getElementById('current-avatar');
            if (currentUser.photoURL) {
                currentAvatar.innerHTML = `<img src="${currentUser.photoURL}" class="w-20 h-20 rounded-full">`;
            } else {
                const initial = (currentUser.displayName || 'A').charAt(0).toUpperCase();
                currentAvatar.innerHTML = initial;
            }
            
            // Load settings
            document.getElementById('language-select').value = userSettings.language;
            document.getElementById('font-size-select').value = userSettings.fontSize;
            document.getElementById('auto-save-toggle').classList.toggle('active', userSettings.autoSave);
            document.getElementById('sound-effects-toggle').classList.toggle('active', userSettings.soundEffects);
            document.getElementById('tts-autoplay-toggle').classList.toggle('active', userSettings.ttsAutoplay);
            
            profileSettingsModal.classList.remove('hidden');
        }

        function hideProfileSettings() {
            profileSettingsModal.classList.add('hidden');
        }

        async function saveProfileSettings() {
            const newName = document.getElementById('profile-name-input').value.trim();
            const newEmail = document.getElementById('profile-email-input').value.trim();
            const newPassword = document.getElementById('profile-password-input').value;
            
            try {
                // Update profile
                if (newName !== currentUser.displayName) {
                    await updateProfile(auth.currentUser, { displayName: newName });
                }
                
                // Update email (requires re-authentication in production)
                if (newEmail !== currentUser.email) {
                    await updateEmail(auth.currentUser, newEmail);
                }
                
                // Update password
                if (newPassword) {
                    await updatePassword(auth.currentUser, newPassword);
                }
                
                // Update user settings
                userSettings.language = document.getElementById('language-select').value;
                userSettings.fontSize = document.getElementById('font-size-select').value;
                userSettings.autoSave = document.getElementById('auto-save-toggle').classList.contains('active');
                userSettings.soundEffects = document.getElementById('sound-effects-toggle').classList.contains('active');
                userSettings.ttsAutoplay = document.getElementById('tts-autoplay-toggle').classList.contains('active');
                
                // Apply font size setting
                applyFontSizeSetting(userSettings.fontSize);
                
                // Save to Firestore
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    ...currentUser,
                    displayName: newName,
                    email: newEmail,
                    settings: userSettings
                }, { merge: true });
                
                // Update current user
                currentUser = { ...currentUser, displayName: newName, email: newEmail };
                setupUserProfile(currentUser);
                
                hideProfileSettings();
                showNotification('Profile updated successfully', 'success');
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile: ' + error.message, 'error');
            }
        }

        function applyFontSizeSetting(fontSize) {
            const root = document.documentElement;
            switch (fontSize) {
                case 'small':
                    root.style.fontSize = '14px';
                    break;
                case 'large':
                    root.style.fontSize = '18px';
                    break;
                case 'extra-large':
                    root.style.fontSize = '20px';
                    break;
                default:
                    root.style.fontSize = '16px';
            }
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('Image must be smaller than 5MB', 'error');
                return;
            }
            
            try {
                // Show progress
                const progressContainer = document.getElementById('upload-progress-container');
                const progressFill = document.getElementById('upload-progress-fill');
                const progressPercent = document.getElementById('upload-progress-percent');
                progressContainer.classList.remove('hidden');
                
                const storageRef = ref(storage, `avatars/${currentUser.uid}_${Date.now()}`);
                const uploadTask = uploadBytesResumable(storageRef, file);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Progress function
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressFill.style.width = progress + '%';
                        progressPercent.textContent = Math.round(progress) + '%';
                    }, 
                    (error) => {
                        // Error function
                        console.error('Upload error:', error);
                        showNotification('Error uploading avatar: ' + error.message, 'error');
                        progressContainer.classList.add('hidden');
                    }, 
                    async () => {
                        // Complete function
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            
                            await updateProfile(auth.currentUser, { photoURL: downloadURL });
                            
                            const currentAvatar = document.getElementById('current-avatar');
                            currentAvatar.innerHTML = `<img src="${downloadURL}" class="w-20 h-20 rounded-full">`;
                            
                            // Update profile avatar in header
                            profileAvatarContainer.innerHTML = `<img src="${downloadURL}" class="w-8 h-8 rounded-full">`;
                            
                            // Save to user data
                            currentUser.photoURL = downloadURL;
                            await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                                photoURL: downloadURL
                            }, { merge: true });
                            
                            progressContainer.classList.add('hidden');
                            showNotification('Avatar updated successfully', 'success');
                        } catch (error) {
                            console.error('Error updating profile with new photo:', error);
                            showNotification('Error updating avatar: ' + error.message, 'error');
                            progressContainer.classList.add('hidden');
                        }
                    }
                );
            } catch (error) {
                console.error('Error starting upload:', error);
                showNotification('Error uploading avatar: ' + error.message, 'error');
            }
        }

        // === PROMPT LIBRARY ===
        function showPromptLibrary() {
            promptLibraryModal.classList.remove('hidden');
            renderPromptLibrary();
        }

        function hidePromptLibrary() {
            promptLibraryModal.classList.add('hidden');
        }

        function renderPromptLibrary() {
            const searchTerm = document.getElementById('search-prompts').value.toLowerCase();
            const categoryFilter = document.getElementById('filter-category').value;
            const grid = document.getElementById('prompts-grid');
            
            let filteredPrompts = userPrompts.filter(prompt => {
                const matchesSearch = prompt.title.toLowerCase().includes(searchTerm) || 
                                    prompt.text.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || prompt.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
            
            if (filteredPrompts.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-theme-quaternary">No prompts found. Create your first prompt!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredPrompts.map(prompt => `
                <div class="prompt-card" data-id="${prompt.id}">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-theme-primary">${prompt.title}</h3>
                        <div class="flex items-center gap-2">
                            <span class="prompt-category">${prompt.category}</span>
                            <div class="flex gap-1">
                                <button class="text-theme-quaternary hover:text-theme-primary" onclick="editPrompt('${prompt.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                </button>
                                <button class="text-theme-quaternary hover:text-theme-error" onclick="deletePrompt('${prompt.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="text-theme-quaternary text-sm mb-3">${prompt.description || 'No description'}</p>
                    <p class="text-theme-secondary text-sm mb-3 line-clamp-2">${prompt.text}</p>
                    <button class="btn btn-primary w-full" onclick="usePrompt('${prompt.id}')">Use Prompt</button>
                </div>
            `).join('');
        }

        function showAddPrompt(editingId = null) {
            currentEditingPrompt = editingId;
            const title = document.getElementById('add-prompt-title');
            const form = document.getElementById('prompt-form');
            
            if (editingId) {
                title.textContent = 'Edit Prompt';
                const prompt = userPrompts.find(p => p.id === editingId);
                if (prompt) {
                    document.getElementById('prompt-title').value = prompt.title;
                    document.getElementById('prompt-category').value = prompt.category;
                    document.getElementById('prompt-text').value = prompt.text;
                    document.getElementById('prompt-description').value = prompt.description || '';
                }
            } else {
                title.textContent = 'Add New Prompt';
                form.reset();
            }
            
            addPromptModal.classList.remove('hidden');
        }

        function hideAddPrompt() {
            addPromptModal.classList.add('hidden');
            currentEditingPrompt = null;
        }

        async function savePrompt() {
            const title = document.getElementById('prompt-title').value.trim();
            const category = document.getElementById('prompt-category').value;
            const text = document.getElementById('prompt-text').value.trim();
            const description = document.getElementById('prompt-description').value.trim();
            
            if (!title || !category || !text) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const prompt = {
                id: currentEditingPrompt || Date.now().toString(),
                title,
                category,
                text,
                description,
                createdAt: currentEditingPrompt ? userPrompts.find(p => p.id === currentEditingPrompt).createdAt : new Date(),
                updatedAt: new Date()
            };
            
            try {
                if (currentEditingPrompt) {
                    const index = userPrompts.findIndex(p => p.id === currentEditingPrompt);
                    userPrompts[index] = prompt;
                } else {
                    userPrompts.push(prompt);
                }
                
                // Save to Firestore
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    prompts: userPrompts
                }, { merge: true });
                
                hideAddPrompt();
                renderPromptLibrary();
                showNotification(currentEditingPrompt ? 'Prompt updated' : 'Prompt saved', 'success');
            } catch (error) {
                console.error('Error saving prompt:', error);
                showNotification('Error saving prompt', 'error');
            }
        }

        async function deletePrompt(id) {
            if (!confirm('Are you sure you want to delete this prompt?')) return;
            
            try {
                userPrompts = userPrompts.filter(p => p.id !== id);
                
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    prompts: userPrompts
                }, { merge: true });
                
                renderPromptLibrary();
                showNotification('Prompt deleted', 'success');
            } catch (error) {
                console.error('Error deleting prompt:', error);
                showNotification('Error deleting prompt', 'error');
            }
        }

        function usePrompt(id) {
            const prompt = userPrompts.find(p => p.id === id);
            if (prompt) {
                chatInput.value = prompt.text;
                autoResizeTextarea(chatInput);
                updateSendButtonState();
                hidePromptLibrary();
                showNotification('Prompt loaded', 'success');
                chatInput.focus();
            }
        }

        // Make functions globally available
        window.editPrompt = (id) => showAddPrompt(id);
        window.deletePrompt = deletePrompt;
        window.usePrompt = usePrompt;

        // === SCHEDULER ===
        function showScheduler() {
            schedulerModal.classList.remove('hidden');
            renderScheduledTasks();
        }

        function hideScheduler() {
            schedulerModal.classList.add('hidden');
        }

        function renderScheduledTasks() {
            const container = document.getElementById('scheduled-tasks');
            
            if (scheduledTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-theme-quaternary">No scheduled tasks yet. Create your first scheduled task!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = scheduledTasks.map(task => `
                <div class="scheduled-task">
                    <div class="flex-1">
                        <h4 class="font-semibold">${task.name}</h4>
                        <p class="text-sm opacity-80">${task.prompt.substring(0, 50)}...</p>
                        <p class="text-xs opacity-60">
                            ${new Date(task.date).toLocaleDateString()} at ${task.time}
                            ${task.repeat !== 'none' ? `• Repeats ${task.repeat}` : ''}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button class="text-theme-quaternary hover:text-theme-primary" onclick="editScheduledTask('${task.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        </button>
                        <button class="text-theme-quaternary hover:text-theme-error" onclick="deleteScheduledTask('${task.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showAddSchedule(editingId = null) {
            currentEditingSchedule = editingId;
            const form = document.getElementById('schedule-form');
            
            if (editingId) {
                const task = scheduledTasks.find(t => t.id === editingId);
                if (task) {
                    document.getElementById('schedule-name').value = task.name;
                    document.getElementById('schedule-prompt').value = task.prompt;
                    document.getElementById('schedule-date').value = task.date;
                    document.getElementById('schedule-time').value = task.time;
                    document.getElementById('schedule-repeat').value = task.repeat;
                }
            } else {
                form.reset();
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('schedule-date').value = today;
            }
            
            addScheduleModal.classList.remove('hidden');
        }

        function hideAddSchedule() {
            addScheduleModal.classList.add('hidden');
            currentEditingSchedule = null;
        }

        async function saveScheduledTask() {
            const name = document.getElementById('schedule-name').value.trim();
            const prompt = document.getElementById('schedule-prompt').value.trim();
            const date = document.getElementById('schedule-date').value;
            const time = document.getElementById('schedule-time').value;
            const repeat = document.getElementById('schedule-repeat').value;
            
            if (!name || !prompt || !date || !time) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const task = {
                id: currentEditingSchedule || Date.now().toString(),
                name,
                prompt,
                date,
                time,
                repeat,
                createdAt: currentEditingSchedule ? scheduledTasks.find(t => t.id === currentEditingSchedule).createdAt : new Date(),
                updatedAt: new Date()
            };
            
            try {
                if (currentEditingSchedule) {
                    const index = scheduledTasks.findIndex(t => t.id === currentEditingSchedule);
                    scheduledTasks[index] = task;
                } else {
                    scheduledTasks.push(task);
                    scheduleTask(task);
                }
                
                // Save to Firestore
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    scheduledTasks: scheduledTasks
                }, { merge: true });
                
                hideAddSchedule();
                renderScheduledTasks();
                showNotification(currentEditingSchedule ? 'Task updated' : 'Task scheduled', 'success');
            } catch (error) {
                console.error('Error saving scheduled task:', error);
                showNotification('Error saving scheduled task', 'error');
            }
        }

        async function deleteScheduledTask(id) {
            if (!confirm('Are you sure you want to delete this scheduled task?')) return;
            
            try {
                scheduledTasks = scheduledTasks.filter(t => t.id !== id);
                
                await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                    scheduledTasks: scheduledTasks
                }, { merge: true });
                
                renderScheduledTasks();
                showNotification('Scheduled task deleted', 'success');
            } catch (error) {
                console.error('Error deleting scheduled task:', error);
                showNotification('Error deleting scheduled task', 'error');
            }
        }

        function scheduleTask(task) {
            const executionTime = new Date(`${task.date}T${task.time}`);
            const now = new Date();
            const delay = executionTime.getTime() - now.getTime();
            
            if (delay > 0) {
                setTimeout(() => {
                    executeScheduledTask(task);
                }, delay);
            }
        }

        async function executeScheduledTask(task) {
            try {
                // Auto-execute the scheduled prompt
                chatInput.value = task.prompt;
                await handleSendMessage();
                
                showNotification(`Scheduled task "${task.name}" executed`, 'success');
                
                // Handle repeat
                if (task.repeat !== 'none') {
                    const nextDate = getNextRepeatDate(task.date, task.repeat);
                    const updatedTask = { ...task, date: nextDate };
                    
                    const index = scheduledTasks.findIndex(t => t.id === task.id);
                    scheduledTasks[index] = updatedTask;
                    
                    await setDoc(doc(db, "artifacts", appId, "users", currentUser.uid), {
                        scheduledTasks: scheduledTasks
                    }, { merge: true });
                    
                    scheduleTask(updatedTask);
                }
            } catch (error) {
                console.error('Error executing scheduled task:', error);
                showNotification('Error executing scheduled task', 'error');
            }
        }

        function getNextRepeatDate(currentDate, repeatType) {
            const date = new Date(currentDate);
            switch (repeatType) {
                case 'daily':
                    date.setDate(date.getDate() + 1);
                    break;
                case 'weekly':
                    date.setDate(date.getDate() + 7);
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
            }
            return date.toISOString().split('T')[0];
        }

        // Make functions globally available
        window.editScheduledTask = (id) => showAddSchedule(id);
        window.deleteScheduledTask = deleteScheduledTask;

        // --- CORE FUNCTIONS ---
        
        function checkAPIStatus() {
            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) {
                 console.warn("API Key is missing. Please add your Google AI Gemini API key.");
                 showNotification("API Key is not configured.", "error");
            }
        }

        function showNotification(message, type = 'info') {
            notificationQueue.push({ message, type });
            processNotificationQueue();
        }
        
        function processNotificationQueue() {
            if (isNotificationVisible || notificationQueue.length === 0) return;
            isNotificationVisible = true;
            const { message, type } = notificationQueue.shift();
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            if (type === 'success') {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-success"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            } else if (type === 'error') {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-error"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            } else {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-accent"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>';
            }
            notification.classList.remove('hidden');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                    isNotificationVisible = false;
                    processNotificationQueue();
                }, 300);
            }, 3000);
        }

        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, "artifacts", appId, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                     if (userDoc.exists()) {
                         const userData = userDoc.data();
                         currentUser = { 
                             ...user, 
                             ...userData,
                             displayName: user.displayName || userData.displayName || 'Anonymous User'
                         };
                         
                         // Load user settings and data
                         userSettings = userData.settings || userSettings;
                         userPrompts = userData.prompts || [];
                         scheduledTasks = userData.scheduledTasks || [];
                         
                         // Apply font size setting
                         applyFontSizeSetting(userSettings.fontSize);
                         
                         // Schedule existing tasks
                         scheduledTasks.forEach(task => {
                             const taskDate = new Date(`${task.date}T${task.time}`);
                             if (taskDate > new Date()) {
                                 scheduleTask(task);
                             }
                         });
                         
                    } else {
                         const displayName = user.displayName || signupNameInput.value || "Anonymous";
                         const photoURL = user.photoURL || null;
                         await setDoc(userDocRef, {
                            displayName: displayName,
                            email: user.email,
                            photoURL: photoURL,
                            createdAt: new Date(),
                            settings: userSettings,
                            prompts: [],
                            scheduledTasks: []
                        });
                        currentUser = { ...user, displayName, photoURL };
                    }
                    showChatApp();
                    setupUserProfile(currentUser);
                    await loadChatsFromFirestore();
                    showNotification(`Welcome back, ${currentUser.displayName || 'User'}!`, 'success');
                } else {
                    currentUser = null;
                    showAuthPage();
                }
            });
        }
        
        function showAuthPage() {
            authPage.classList.remove('hidden');
            authPage.classList.add('flex');
            chatApp.classList.add('hidden');
            chatApp.classList.remove('flex');
        }

        function showChatApp() {
            authPage.classList.add('hidden');
            authPage.classList.remove('flex');
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
        }

        function setupUserProfile(user) {
            if (!user) return;
            profileEmail.textContent = user.email || 'No email provided';
            profileName.textContent = user.displayName || 'Anonymous User';

            if (user.photoURL) {
                profileAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full">`;
            } else {
                const initial = (user.displayName || 'A').charAt(0).toUpperCase();
                profileAvatarContainer.innerHTML = initial;
            }
        }

        function showWelcomeContent() {
            const welcomeHtml = `
                <div class="welcome-card rounded-2xl p-8 mb-6 text-center">
                    <div class="w-20 h-20 bg-theme-accent rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                       <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-20 h-20 rounded-full shadow-lg" />
                    </div>
                    <h2 class="text-3xl font-bold text-theme-primary mb-4">Welcome to Chat@AI</h2>
                    <p class="text-theme-secondary text-lg mb-6">Your intelligent AI assistant with enhanced features. Organize chats, save prompts, schedule tasks!</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-theme-primary mb-4">Try these examples:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                           <button class="suggestion-card" data-suggestion="Visualize this python code:\n\nx = 5\nitems = [1, 2, 3]\nfor i in range(x):\n  items.append(i * 2)\nprint(items)">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><circle cx="12" cy="12" r="10"/><path d="m10 8 6 4-6 4z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize Python code</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Create a study schedule for learning JavaScript in 30 days">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                                </div>
                                <span class="text-theme-secondary">Create study schedule</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Help me organize my project tasks and create a productivity system">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2Z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Organize projects</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Generate a JavaScript bar chart showing the population of the 5 largest cities in India.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-rose-500/20 rounded-lg flex items-center justify-center">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-400"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize data</span>
                             </div>
                           </button>
                        </div>
                    </div>
                </div>`;
            chatContainer.innerHTML = welcomeHtml;
            exportBtn.disabled = true;
        }

        function fillSuggestion(text) {
            chatInput.value = text;
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            chatInput.focus();
        };

        async function handleLogin(e) {
            e.preventDefault();
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Login error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            if(!validateForm()) return;

            const submitBtn = signupForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const fullName = signupNameInput.value.trim();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Signup error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                allChats = {};
                currentChatId = null;
                chatContainer.innerHTML = '';
                historyList.innerHTML = '';
                isMedicalMode = false;
                medicalModeIndicator.classList.add('hidden');
                medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
                chatAiBtn.classList.add('hidden');
                if (isTTSActive) {
                    stopTTS();
                }
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error("Logout error", error);
                showNotification('Error logging out', 'error');
            }
        }

        function handleHome() {
            // Navigate to index.html or reload the current page
            window.location.href = 'index.html';
        }

        function getFriendlyAuthError(error) {
            switch(error.code) {
                case 'auth/invalid-email': return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid email or password. Please try again.';
                case 'auth/email-already-in-use': return 'This email is already registered. Please log in.';
                case 'auth/weak-password': return 'Password is too weak. Please use at least 6 characters.';
                default: return 'An unexpected error occurred. Please try again.';
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(`${inputId}-toggle`);
            const icon = button.querySelector('svg');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 013.542-5.45m5.545-2.271A10.02 10.02 0 0112 5c4.478 0 8.268 2.943 9.542 7a10.02 10.02 0 01-1.343 2.596m-3.41-3.41a3 3 0 11-4.243-4.243" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />`;
            } else {
                input.type = 'password';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
            }
        }

        function updatePasswordStrength() {
            const password = signupPasswordInput.value;
            let strength = 0;
            if (password.length > 5) strength++;
            if (password.length > 7) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;

            let color = 'bg-theme-quaternary';
            if (strength <= 2) color = 'bg-theme-error';
            else if (strength <= 4) color = 'bg-theme-warning';
            else color = 'bg-theme-success';

            passwordStrengthBar.className = `rounded-full ${color}`;
            passwordStrengthBar.style.width = `${(strength / 5) * 100}%`;
            validatePassword();
        }

        function validateEmail() {
            const email = signupEmailInput.value;
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (!re.test(String(email).toLowerCase())) {
                emailError.textContent = 'Please enter a valid email address.';
                emailError.classList.remove('hidden');
                return false;
            }
            emailError.classList.add('hidden');
            return true;
        }

        function validatePassword() {
            const password = signupPasswordInput.value;
            if (password.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters long.';
                passwordError.classList.remove('hidden');
                return false;
            }
            passwordError.classList.add('hidden');
            return true;
        }

        function validateForm() {
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            const isNameValid = signupNameInput.value.trim() !== '';
            return isEmailValid && isPasswordValid && isNameValid;
        }

        function toggleButtonLoading(button, isLoading) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.button-loader');
            button.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const extension = '.' + file.name.split('.').pop();
            const language = fileExtensionMap[extension];
            
            if (language) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const codeContent = event.target.result;
                    showCodeVisualizationModal(codeContent, language);
                };
                reader.readAsText(file);
                fileInput.value = '';
                return;
            }

            if (file.type === "text/plain" || file.type === "text/csv") {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const textContent = event.target.result;
                    attachedFile = {
                        base64: btoa(textContent),
                        mimeType: "text/plain",
                        name: file.name
                    };
                    displayFilePreview();
                    updateSendButtonState();
                };
                reader.readAsText(file);
            } else {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64Data = event.target.result.split(',')[1];
                    attachedFile = {
                        base64: base64Data,
                        mimeType: file.type,
                        name: file.name
                    };
                    displayFilePreview();
                    updateSendButtonState();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayFilePreview() {
            if (!attachedFile) return;

            let previewHtml = '';
            if (attachedFile.mimeType.startsWith('image/')) {
                previewHtml = `<img src="data:${attachedFile.mimeType};base64,${attachedFile.base64}" alt="File preview">`;
            } else if (attachedFile.mimeType.startsWith('audio/')) {
                previewHtml = `<audio controls src="data:${attachedFile.mimeType};base64,${attachedFile.base64}"></audio>`;
            } else if (attachedFile.mimeType.startsWith('video/')) {
                previewHtml = `<video controls class="max-w-xs rounded-lg mb-2" src="data:${attachedFile.mimeType};base64,${attachedFile.base64}"></video>`;
            } else {
                previewHtml = `<div class="text-sm text-theme-secondary p-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><span>${attachedFile.name}</span></div>`;
            }

            filePreview.innerHTML = previewHtml;
            filePreviewContainer.style.display = 'block';
        }

        function removeAttachedFile() {
            attachedFile = null;
            fileInput.value = '';
            filePreviewContainer.style.display = 'none';
            filePreview.innerHTML = '';
            updateSendButtonState();
        }

        async function handleSendMessage(e) {
            if(e) e.preventDefault();
            const userInput = chatInput.value.trim();
            
            const vizRegex = /^visualize this (\w+\+*\w*) code:/i;
            const match = userInput.match(vizRegex);
            if (match) {
                const language = match[1].toLowerCase();
                const code = userInput.substring(match[0].length).trim();
                if (vizLanguages.includes(language)){
                    showCodeVisualizationModal(code, language);
                    chatInput.value = '';
                    autoResizeTextarea(chatInput);
                    updateSendButtonState();
                    return;
                }
            }
            
            if ((!userInput && !attachedFile) || !currentUser) return;

            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) {
                appendMessage("`Error`: API Key is missing.\n\nPlease add your Google AI Gemini API key in the script section to enable chat functionality.", 'model-error');
                return;
            }

            if (chatContainer.querySelector('.welcome-card')) {
                chatContainer.innerHTML = '';
            }

            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;
            isGenerating = true;
            updateScrollButton();

            if (!currentChatId) {
                try {
                     const title = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                     const newChatRef = await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"), {
                        title: title || 'Multimedia Chat',
                        createdAt: new Date(),
                        isMedical: isMedicalMode
                    });
                    currentChatId = newChatRef.id;
                    allChats[currentChatId] = { 
                        id: currentChatId, 
                        createdAt: new Date(), 
                        title: title || 'Multimedia Chat', 
                        messages: [],
                        isMedical: isMedicalMode
                    };
                    renderHistorySidebar();
                } catch (error) {
                    console.error("Error creating new chat:", error);
                    appendMessage("Error: Could not start a new chat session.", "model-error");
                    toggleForm(true);
                    generationControls.classList.add('hidden');
                    isGenerating = false;
                    updateScrollButton();
                    return;
                }
            }

            const messageParts = [];
            if (attachedFile) {
                messageParts.push({
                    inlineData: {
                        mimeType: attachedFile.mimeType,
                        data: attachedFile.base64
                    }
                });
            }
            
            let finalUserInput = userInput;
            if (isMedicalMode && userInput) {
                finalUserInput = createMedicalPrompt(userInput);
            }
            
            if (finalUserInput) {
                messageParts.push({ text: finalUserInput });
            }

            appendMessage({ text: userInput, file: attachedFile }, 'user');
            
            const userMessage = { role: 'user', parts: messageParts, timestamp: new Date() };
            allChats[currentChatId].messages.push(userMessage);
            const firestoreMessage = { role: 'user', parts: [{text: userInput || `[Sent a file: ${attachedFile.name}]`}], timestamp: new Date() };
            await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), firestoreMessage);

            if(allChats[currentChatId].messages.length === 1) {
                const newTitle = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                await updateDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId), { title: newTitle || `Chat about ${attachedFile.name}` });
                allChats[currentChatId].title = newTitle || `Chat about ${attachedFile.name}`;
                renderHistorySidebar();
            }

            chatInput.value = '';
            removeAttachedFile();
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            appendLoadingIndicator();
            
            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }

            try {
                let apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: apiMessages }),
                });

                removeLoadingIndicator();
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText) {
                    const messageId = appendMessage({text: ''}, 'model');
                    const messageElement = document.getElementById(messageId);
                    const contentContainer = messageElement.querySelector('.prose');

                    const finalText = await streamResponse(contentContainer, aiResponseText, messageId);
                    
                    enhanceResponseMessage(messageElement, finalText);

                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);

                    // Auto-play TTS if enabled
                    if (userSettings.ttsAutoplay && window.speechSynthesis) {
                        const ttsButton = messageElement.querySelector('.tts-button');
                        if (ttsButton) {
                            setTimeout(() => {
                                handleTTSButtonClick(ttsButton, finalText);
                            }, 500);
                        }
                    }

                } else {
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error generating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
                isGenerating = false;
                updateScrollButton();
            }
        }

        function appendMessage(content, sender) {
            const messageId = `msg-${sender}-${Date.now()}`;
            const { text, file } = typeof content === 'object' ? content : { text: content, file: null };
            
            let fileHtml = '';
            if (file) {
                 if (file.mimeType.startsWith('image/')) {
                    fileHtml = `<img src="data:${file.mimeType};base64,${file.base64}" class="max-w-xs rounded-lg mb-2">`;
                } else if (file.mimeType.startsWith('audio/')) {
                    fileHtml = `<audio controls src="data:${file.mimeType};base64,${file.base64}" class="w-full my-2"></audio>`;
                } else if (file.mimeType.startsWith('video/')) {
                    fileHtml = `<video controls class="max-w-xs rounded-lg mb-2" src="data:${file.mimeType};base64,${file.base64}"></video>`;
                }
            }

            const isModel = sender === 'model' || sender === 'model-error';
            const isUser = sender === 'user';
            
            let userAvatarHtml = '';
            if (isUser && currentUser) {
                if(currentUser.photoURL) {
                    userAvatarHtml = `<img src="${currentUser.photoURL}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full">`;
                } else {
                    const initial = (currentUser.displayName || 'A').charAt(0).toUpperCase();
                    userAvatarHtml = `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-theme-tertiary flex items-center justify-center font-bold text-theme-primary flex-shrink-0">${initial}</div>`;
                }
            }
            
            const isError = sender === 'model-error';
            let modelIconHtml = `<div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full ${isError ? 'bg-theme-error' : 'bg-theme-accent'} flex items-center justify-center shadow-md"><img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full shadow-md" /></div>`;
            
            if (isMedicalMode && !isError) {
                modelIconHtml = `<div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-green-600 flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                        <path d="M12 5L8 21l4-7 4 7-4-16"/>
                    </svg>
                </div>`;
            }
            
            const messageBubbleClasses = isUser ? 'bg-theme-accent text-theme-inverse' : (isError ? 'bg-theme-error/10' : 'bg-theme-secondary');
            const messageHtml = `
            <div id="${messageId}" class="chat-message flex items-start gap-2 sm:gap-3 ${isUser ? 'justify-end user' : ''}">
                ${!isUser ? `<div class="flex-shrink-0">${modelIconHtml}</div>` : ''}
                <div class="rounded-lg p-3 sm:p-4 max-w-3xl shadow-lg min-w-0 ${messageBubbleClasses}">
                    ${fileHtml}
                    <div class="prose max-w-none ${isUser ? 'text-theme-inverse' : 'text-theme-primary'}">
                        ${marked.parse(text || '')}
                    </div>
                </div>
                ${isUser ? `<div class="flex-shrink-0">${userAvatarHtml}</div>` : ''}
                <div class="action-buttons"></div>
            </div>`;

            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            const messageElement = document.getElementById(messageId);

            if (isModel && text) {
                const contentContainer = messageElement.querySelector('.prose');
                makeTablesResponsive(contentContainer);
                enhanceCodeBlocks(messageId);
            }

            if (isUser) {
                addUserActionButtons(messageElement, text);
            }

            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }
            
            return messageId;
        }

        function addUserActionButtons(messageElement, text) {
            const actionContainer = messageElement.querySelector('.action-buttons');
            if (!actionContainer) return;

            const editBtn = document.createElement('button');
            editBtn.title = "Edit message";
            editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
            editBtn.onclick = () => handleEditMessage(messageElement, text);
            actionContainer.appendChild(editBtn);

            const copyBtn = document.createElement('button');
            copyBtn.title = "Copy";
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>`;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text);
                showNotification('Copied to clipboard', 'success');
            };
            actionContainer.appendChild(copyBtn);
        }

        async function handleEditMessage(messageElement, originalText) {
            const messageId = messageElement.id;
            const contentContainer = messageElement.querySelector('.prose');
            const actionContainer = messageElement.querySelector('.action-buttons');
            
            actionContainer.style.display = 'none';
            
            const editContainer = document.createElement('div');
            editContainer.innerHTML = `
                <textarea class="edit-textarea">${originalText}</textarea>
                <div class="edit-buttons">
                    <button class="edit-cancel-btn">Cancel</button>
                    <button class="edit-save-btn">Save & Regenerate</button>
                </div>
            `;
            
            contentContainer.replaceWith(editContainer);
            const textarea = editContainer.querySelector('.edit-textarea');
            const cancelBtn = editContainer.querySelector('.edit-cancel-btn');
            const saveBtn = editContainer.querySelector('.edit-save-btn');
            
            textarea.focus();
            textarea.select();
            
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
            
            cancelBtn.onclick = () => {
                const newContentContainer = document.createElement('div');
                newContentContainer.className = 'prose max-w-none text-theme-inverse';
                newContentContainer.innerHTML = marked.parse(originalText);
                editContainer.replaceWith(newContentContainer);
                actionContainer.style.display = 'flex';
            };
            
            saveBtn.onclick = async () => {
                const newText = textarea.value.trim();
                if (!newText) {
                    showNotification('Message cannot be empty', 'error');
                    return;
                }
                
                if (newText === originalText) {
                    cancelBtn.click();
                    return;
                }
                
                try {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                    
                    await regenerateFromMessage(messageId, newText);
                    showNotification('Message updated and regenerated', 'success');
                } catch (error) {
                    console.error('Error regenerating:', error);
                    showNotification('Error regenerating response', 'error');
                    cancelBtn.click();
                }
            };
        }

        async function regenerateFromMessage(messageId, newText) {
            if (!currentChatId || !currentUser) return;
            
            const currentMessages = allChats[currentChatId].messages || [];
            let messageIndex = -1;
            
            for (let i = 0; i < currentMessages.length; i++) {
                const message = currentMessages[i];
                if (message.role === 'user') {
                    const textPart = message.parts.find(p => p.text);
                    if (textPart && messageId.includes('user')) {
                        messageIndex = i;
                        break;
                    }
                }
            }
            
            if (messageIndex === -1) return;
            
            const messagesToRemove = currentMessages.splice(messageIndex);
            
            const allMessageElements = chatContainer.querySelectorAll('.chat-message');
            let userMessageCount = 0;
            for (let i = 0; i < allMessageElements.length; i++) {
                const element = allMessageElements[i];
                if (element.classList.contains('user')) {
                    userMessageCount++;
                    if (userMessageCount > messageIndex) {
                        for (let j = i; j < allMessageElements.length; j++) {
                            allMessageElements[j].remove();
                        }
                        break;
                    }
                }
            }
            
            let finalUserInput = newText;
            if (isMedicalMode) {
                finalUserInput = createMedicalPrompt(newText);
            }
            
            const messageParts = [{ text: finalUserInput }];
            const userMessage = { role: 'user', parts: messageParts, timestamp: new Date() };
            allChats[currentChatId].messages.push(userMessage);
            
            const messageId_new = appendMessage({ text: newText }, 'user');
            
            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;
            isGenerating = true;
            updateScrollButton();
            
            appendLoadingIndicator();
            
            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }
            
            try {
                const apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));
                
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: apiMessages }),
                });
                
                removeLoadingIndicator();
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiResponseText) {
                    const aiMessageId = appendMessage({text: ''}, 'model');
                    const aiMessageElement = document.getElementById(aiMessageId);
                    const contentContainer = aiMessageElement.querySelector('.prose');
                    
                    const finalText = await streamResponse(contentContainer, aiResponseText, aiMessageId);
                    
                    enhanceResponseMessage(aiMessageElement, finalText);
                    
                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), userMessage);
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);
                } else {
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error generating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
                isGenerating = false;
                updateScrollButton();
            }
        }

        async function streamResponse(contentContainer, fullText, messageId) {
            return new Promise((resolve) => {
                let currentText = '';
                let index = 0;
                const typingSpeed = 10;

                function type() {
                    if (stopGenerationFlag || index >= fullText.length) {
                        const finalHtml = marked.parse(currentText);
                        contentContainer.innerHTML = finalHtml;
                        makeTablesResponsive(contentContainer);
                        enhanceCodeBlocks(messageId);
                        resolve(currentText);
                        return;
                    }

                    currentText += fullText[index];
                    index++;
                    const tempHtml = marked.parse(currentText + '▋');
                    contentContainer.innerHTML = tempHtml;
                    
                    if (!isUserScrolledUp) {
                        scrollToBottomInstant();
                    }
                    
                    setTimeout(type, typingSpeed);
                }
                type();
            });
        }
        
        function enhanceResponseMessage(messageElement, textContent) {
            const actionContainer = messageElement.querySelector('.action-buttons');
            if (!actionContainer) return;

            if (window.speechSynthesis) {
                addTTSButton(actionContainer, textContent);
            }

            addStandardActionButtons(actionContainer, textContent);

            const table = messageElement.querySelector('table');
            if (table) {
                
                addChartButton(actionContainer, table);
            }

            const jsonCodeBlock = messageElement.querySelector('code.language-json');
            if (jsonCodeBlock) {
                addJsonExplorerButton(actionContainer, jsonCodeBlock.innerText);
            }

            const locationKeywords = ['city', 'country', 'location', 'place', 'travel', 'visit', 'destination', 'geography', 'map', 'directions', 'address'];
            const hasLocationContext = locationKeywords.some(keyword => 
                textContent.toLowerCase().includes(keyword)
            );
            
            if (hasLocationContext) {
                const locationMatches = textContent.match(/([A-Z][a-zA-Z\s]+,\s[A-Z][a-zA-Z\s]+)/g);
                if (locationMatches) {
                    addMapButton(actionContainer, locationMatches[0]);
                }
            }
            
            const dateRegex = /(?:schedule|meeting on|deadline for)\s(.*?)(?:\.|at\s\d{1,2}:\d{2}\s[AP]M|next\s\w+)/i;
            const dateMatch = textContent.match(dateRegex);
            if (dateMatch) {
                addCalendarButton(actionContainer, dateMatch[0], textContent);
            }

            addRegenerateButton(actionContainer, messageElement);
        }
        
        function addStandardActionButtons(container, text) {
            const copyBtn = document.createElement('button');
            copyBtn.title = "Copy";
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>`;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text);
                showNotification('Copied to clipboard', 'success');
            };
            container.appendChild(copyBtn);
        }

        function addRegenerateButton(container, messageElement) {
            const regenerateBtn = document.createElement('button');
            regenerateBtn.title = "Regenerate response";
            regenerateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`;
            regenerateBtn.onclick = () => handleRegenerateResponse(messageElement);
            container.appendChild(regenerateBtn);
        }

        async function handleRegenerateResponse(messageElement) {
            if (!currentChatId || !currentUser) return;
            
            const currentMessages = allChats[currentChatId].messages || [];
            let lastUserMessageIndex = -1;
            
            for (let i = currentMessages.length - 1; i >= 0; i--) {
                if (currentMessages[i].role === 'user') {
                    lastUserMessageIndex = i;
                    break;
                }
            }
            
            if (lastUserMessageIndex === -1) return;
            
            const aiMessageIndex = lastUserMessageIndex + 1;
            if (aiMessageIndex < currentMessages.length) {
                currentMessages.splice(aiMessageIndex, 1);
            }
            
            messageElement.remove();
            
            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;
            isGenerating = true;
            updateScrollButton();
            
            appendLoadingIndicator();
            
            if (!isUserScrolledUp) {
                scrollToBottomInstant();
            }
            
            try {
                const apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));
                
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: apiMessages }),
                });
                
                removeLoadingIndicator();
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiResponseText) {
                    const aiMessageId = appendMessage({text: ''}, 'model');
                    const aiMessageElement = document.getElementById(aiMessageId);
                    const contentContainer = aiMessageElement.querySelector('.prose');
                    
                    const finalText = await streamResponse(contentContainer, aiResponseText, aiMessageId);
                    
                    enhanceResponseMessage(aiMessageElement, finalText);
                    
                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);
                    
                    showNotification('Response regenerated', 'success');
                } else {
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error regenerating response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error regenerating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
                isGenerating = false;
                updateScrollButton();
            }
        }

        function addChartButton(container, tableElement) {
             const chartBtn = document.createElement('button');
             chartBtn.title = "Visualize Chart";
             chartBtn.className = "interactive-btn";
             chartBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg><span>Visualize</span>`;
             chartBtn.onclick = () => showChartModal(tableElement);
             container.appendChild(chartBtn);
        }

        function addJsonExplorerButton(container, jsonText) {
            const jsonBtn = document.createElement('button');
            jsonBtn.title = "View JSON";
            jsonBtn.className = "interactive-btn";
            jsonBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span>View JSON</span>`;
            
            jsonBtn.onclick = () => showJsonExplorerModal(jsonText);
            container.appendChild(jsonBtn);
        }
        
        function addMapButton(container, location) {
            const mapBtn = document.createElement('button');
            mapBtn.title = `Show ${location} on Map`;
            mapBtn.className = "interactive-btn";
            mapBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`;
            mapBtn.onclick = () => showMapModal(location);
            container.appendChild(mapBtn);
        }
        
        function addCalendarButton(container, eventText, fullContext) {
            const calendarLink = createGoogleCalendarLink(eventText, fullContext);
            if (!calendarLink) return;

            const calendarBtn = document.createElement('a');
            calendarBtn.href = calendarLink;
            calendarBtn.target = "_blank";
            calendarBtn.rel = "noopener noreferrer";
            calendarBtn.title = "Add to Calendar";
            calendarBtn.className = "interactive-btn";
            calendarBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8"  x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`;
            container.appendChild(calendarBtn);
        }

        function showInteractiveModal(title) {
            interactiveModalTitle.textContent = title;
            interactiveModal.classList.remove('hidden');
            interactiveModal.classList.add('flex');
        }

        function hideInteractiveModal() {
            interactiveModal.classList.add('hidden');
            interactiveModal.classList.remove('flex');
            interactiveModalBody.innerHTML = '';
            interactiveModalFooter.innerHTML = '';
            interactiveModalFooter.classList.add('hidden');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            visualizerSteps = [];
            currentVisStep = 0;
            if (monacoEditor) {
                monacoEditor.dispose();
                monacoEditor = null;
            }
        }
        
        function showChartModal(table) {
            showInteractiveModal("Chart Visualization");
            interactiveModalBody.innerHTML = '<div class="p-4 h-full"><canvas id="chart-canvas"></canvas></div>';
            interactiveModalFooter.classList.remove('hidden');

            const ctx = document.getElementById('chart-canvas').getContext('2d');
            const data = parseTableForChart(table);
            if (!data) {
                hideInteractiveModal();
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: 'rgb(var(--text-primary))' }, grid: { color: 'rgb(var(--border-primary))'} },
                        x: { ticks: { color: 'rgb(var(--text-primary))' }, grid: { color: 'rgb(var(--border-primary))'} }
                    },
                    plugins: { legend: { labels: { color: 'rgb(var(--text-primary))' } } }
                }
            });

            ['bar', 'line', 'pie', 'doughnut'].forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                btn.className = 'px-3 py-1 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors text-theme-primary text-sm';
                btn.onclick = () => {
                    chartInstance.config.type = type;
                    chartInstance.update();
                };
                interactiveModalFooter.appendChild(btn);
            });
        }
        
        function showMapModal(location) {
            showInteractiveModal(`Map: ${location}`);
            interactiveModalBody.innerHTML = `<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(location)}&hl=es;z=14&amp&output=embed" class="w-full h-full border-0" loading="lazy"></iframe>`;
        }

        function showJsonExplorerModal(jsonText) {
             showInteractiveModal("JSON Explorer");
             interactiveModalBody.classList.add('p-4');
            try {
                const jsonObj = JSON.parse(jsonText);
                const formattedHtml = formatJsonToHtml(jsonObj);
                interactiveModalBody.innerHTML = `<div class="json-formatter">${formattedHtml}</div>`;
            } catch (e) {
                interactiveModalBody.innerHTML = `<p class="text-theme-error">Error parsing JSON: ${e.message}</p><pre class="mt-4 text-theme-quaternary">${jsonText}</pre>`;
            }
        }

        function showCodePreviewModal(code, language) {
            showInteractiveModal("Live Code Preview");
            const bodyContent = language === 'javascript' ? `<canvas id="chartCanvas"></canvas><script>${code}<\/script>` : code;
            const fullHtml = `
                <html>
                    <head>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
                        <script src="https://d3js.org/d3.v7.min.js"><\/script>
                        <style>body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; color: #000; overflow: auto; } canvas { display: block; }</style>
                    </head>
                    <body>
                        ${bodyContent}
                    </body>
                </html>`;
            interactiveModalBody.innerHTML = `<iframe srcdoc='${fullHtml.replace(/'/g, "&apos;")}' class="w-full h-full border-0" ></iframe>`;
        }
        
        async function showCodeVisualizationModal(code, language) {
            showInteractiveModal(`${language.charAt(0).toUpperCase() + language.slice(1)} Code Editor & Visualizer`);
            currentLanguage = language;
            
            interactiveModalBody.innerHTML = `<div class="flex items-center justify-center h-full">
                <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 200px; height: 200px;" loop autoplay></dotlottie-player>
            </div>`;

            await renderMonacoVisualizerUI(code, language);
            await generateVisualization(code, language);
        }

        async function renderMonacoVisualizerUI(code, language) {
            interactiveModalBody.innerHTML = `
                <div id="code-visualizer-container">
                    <div id="monaco-editor-container">
                        <div id="editor-toolbar">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-theme-secondary">Language:</span>
                                <select id="language-selector" class="monaco-editor-toolbar-btn">
                                    <option value="javascript" ${language === 'javascript' ? 'selected' : ''}>JavaScript</option>
                                    <option value="python" ${language === 'python' ? 'selected' : ''}>Python</option>
                                    <option value="java" ${language === 'java' ? 'selected' : ''}>Java</option>
                                    <option value="c" ${language === 'c' ? 'selected' : ''}>C</option>
                                    <option value="cpp" ${language === 'cpp' ? 'selected' : ''}>C++</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="run-code-btn" class="monaco-editor-toolbar-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                </button>
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="checkbox" id="auto-run-checkbox" ${isAutoRunEnabled ? 'checked' : ''}>
                                    <span class="text-theme-secondary">Auto-run</span>
                                </label>
                            </div>
                        </div>
                        <div id="monaco-editor"></div>
                    </div>
                    <div id="visualizer-explanation-pane">
                        <h4 class="font-bold text-theme-primary mb-2">Execution Step</h4>
                        <p id="step-explanation" class="text-theme-secondary">Click "Run & Visualize" to see step-by-step execution</p>
                    </div>
                    <div id="visualizer-state-pane">
                        <h4 class="font-bold text-theme-primary mb-2">Variables & Output</h4>
                        <div id="variables-display" class="mb-4">
                            <p class="text-theme-quaternary text-sm">No variables yet</p>
                        </div>
                        <div id="output-panel">
                            <h5 class="font-bold text-theme-tertiary mb-1">Output:</h5>
                            <div id="output-content" class="text-theme-quaternary text-sm">No output yet</div>
                        </div>
                    </div>
                </div>
            `;
            
            const editorContainer = document.getElementById('monaco-editor');
            monacoEditor = await createMonacoEditor(editorContainer, code, language);
            
            interactiveModalFooter.innerHTML = `
                <button id="vis-prev-btn" class="px-4 py-2 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <span id="vis-step-counter" class="text-sm text-theme-quaternary">Step 0/0</span>
                <button id="vis-next-btn" class="px-4 py-2 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                <button id="reset-visualization-btn" class="px-4 py-2 rounded-md bg-theme-accent hover:bg-theme-accent-hover text-theme-inverse transition-colors">Reset</button>
            `;
            interactiveModalFooter.classList.remove('hidden');

            setupMonacoEventListeners();
        }

        function setupMonacoEventListeners() {
            document.getElementById('language-selector').addEventListener('change', async (e) => {
                const newLanguage = e.target.value;
                currentLanguage = newLanguage;
                monaco.editor.setModelLanguage(monacoEditor.getModel(), newLanguage);
                
                if (isAutoRunEnabled) {
                    await generateVisualization(monacoEditor.getValue(), newLanguage);
                }
            });

            document.getElementById('run-code-btn').addEventListener('click', async () => {
                const code = monacoEditor.getValue();
                await generateVisualization(code, currentLanguage);
            });

            document.getElementById('auto-run-checkbox').addEventListener('change', (e) => {
                isAutoRunEnabled = e.target.checked;
                if (isAutoRunEnabled) {
                    let timeout;
                    monacoEditor.onDidChangeModelContent(() => {
                        clearTimeout(timeout);
                        timeout = setTimeout(async () => {
                            const code = monacoEditor.getValue();
                            await generateVisualization(code, currentLanguage);
                        }, 1000);
                    });
                }
            });

            document.getElementById('vis-prev-btn').addEventListener('click', () => {
                if (currentVisStep > 0) {
                    currentVisStep--;
                    updateVisualizerStep();
                }
            });

            document.getElementById('vis-next-btn').addEventListener('click', () => {
                if (currentVisStep < visualizerSteps.length - 1) {
                    currentVisStep++;
                    updateVisualizerStep();
                }
            });

            document.getElementById('reset-visualization-btn').addEventListener('click', () => {
                currentVisStep = 0;
                if (visualizerSteps.length > 0) {
                    updateVisualizerStep();
                }
            });
        }

        async function generateVisualization(code, language) {
            if (!code.trim()) {
                document.getElementById('step-explanation').textContent = 'No code to visualize';
                return;
            }

            document.getElementById('step-explanation').innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-theme-accent"></div>
                    <span>Generating visualization...</span>
                </div>
            `;

            const prompt = `
                Analyze the following ${language} code and generate a step-by-step execution trace.
                For each step, provide the line number being executed, a simple one-sentence explanation of what the line does, the state of global variables as an array of objects (where each object has a 'key' and a stringified 'value'), and any text that is printed to standard output.
                Only include variables that have been initialized.
                The very first step should be "Initial State" on line 0, showing the state before any code runs.
                The very last step should be "Final State", showing the final variable values and the complete output after the script finishes.
            `;
            
            const payload = {
              contents: [{
                role: 'user',
                parts: [
                  { text: prompt },
                  { text: `\`\`\`${language}\n${code}\n\`\`\`` }
                ]
              }],
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    "steps": {
                      type: "ARRAY",
                      items: {
                        type: "OBJECT",
                        properties: {
                          "line": { "type": "INTEGER" },
                          "explanation": { "type": "STRING" },
                          "globals": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "key": { "type": "STRING" },
                                    "value": { "type": "STRING" }
                                }
                            }
                          },
                          "output": { "type": "STRING" }
                        }
                      }
                    }
                  }
                }
              }
            };

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API error during visualization.');
                }
                const data = await response.json();
                const traceText = data.candidates[0].content.parts[0].text;
                const trace = JSON.parse(traceText);
                
                if (trace.steps && trace.steps.length > 0) {
                    visualizerSteps = trace.steps;
                    currentVisStep = 0;
                    updateVisualizerStep();
                    highlightCodeLines();
                } else {
                    throw new Error("AI could not generate a valid visualization trace.");
                }

            } catch (error) {
                console.error("Code visualization error:", error);
                document.getElementById('step-explanation').innerHTML = `<span class="text-theme-error">Error: Could not visualize code. ${error.message}</span>`;
            }
        }

        function highlightCodeLines() {
            if (monacoEditor) {
                monacoEditor.deltaDecorations(monacoEditor.getModel().getAllDecorations().map(d => d.id), []);
            }
        }

        function updateVisualizerStep() {
            const step = visualizerSteps[currentVisStep];
            if (!step) return;

            document.getElementById('step-explanation').textContent = step.explanation;

            const variablesDisplay = document.getElementById('variables-display');
            const globalsArray = step.globals || [];
            if (globalsArray.length > 0) {
                let variablesHtml = '';
                for (const variable of globalsArray) {
                    variablesHtml += `<div class="variable flex justify-between py-1"><span class="var-name font-mono text-theme-accent">${variable.key}</span> <span class="var-value font-mono text-theme-primary">${variable.value}</span></div>`;
                }
                variablesDisplay.innerHTML = variablesHtml;
            } else {
                variablesDisplay.innerHTML = '<p class="text-theme-quaternary text-sm">No variables initialized yet</p>';
            }

            const outputContent = document.getElementById('output-content');
            if (step.output) {
                outputContent.innerHTML = `<div class="output-line success">${step.output}</div>`;
            } else {
                outputContent.innerHTML = '<span class="text-theme-quaternary text-sm">No output yet</span>';
            }

            if (monacoEditor && step.line > 0 && step.explanation !== "Final State") {
                const decorations = [{
                    range: new monaco.Range(step.line, 1, step.line, 1),
                    options: {
                        isWholeLine: true,
                        className: 'highlighted-line',
                        glyphMarginClassName: 'highlighted-line-glyph'
                    }
                }];
                monacoEditor.deltaDecorations([], decorations);
                monacoEditor.revealLineInCenter(step.line);
            }

            document.getElementById('vis-step-counter').textContent = `Step ${currentVisStep + 1} of ${visualizerSteps.length}`;
            document.getElementById('vis-prev-btn').disabled = currentVisStep === 0;
            document.getElementById('vis-next-btn').disabled = currentVisStep === visualizerSteps.length - 1;
        }

        function parseTableForChart(table) {
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            if (headers.length < 2 || rows.length === 0) {
                showNotification("Table not suitable for charting.", "error");
                return null;
            }

            const labels = rows.map(row => row.cells[0].textContent.trim());
            const datasets = [];

            for (let i = 1; i < headers.length; i++) {
                const data = rows.map(row => parseFloat(row.cells[i].textContent.trim().replace(/[^0-9.-]+/g,"")) || 0);
                const colorVal1 = Math.floor(Math.random() * 256);
                const colorVal2 = Math.floor(Math.random() * 256);
                const colorVal3 = Math.floor(Math.random() * 256);
                datasets.push({
                    label: headers[i],
                    data: data,
                    backgroundColor: `rgba(${colorVal1}, ${colorVal2}, ${colorVal3}, 0.5)`,
                    borderColor: `rgba(${colorVal1}, ${colorVal2}, ${colorVal3}, 1)`,
                    borderWidth: 1
                });
            }

            return { labels, datasets };
        }
        
        function formatJsonToHtml(obj) {
            if (obj === null) return `<span class="null">null</span>`;
            if (typeof obj === 'string') return `<span class="string">"${obj.replace(/"/g, '\\"')}"</span>`;
            if (typeof obj === 'number') return `<span class="number">${obj}</span>`;
            if (typeof obj === 'boolean') return `<span class="boolean">${obj}</span>`;

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '[]';
                let content = obj.map(item => `<li>${formatJsonToHtml(item)}</li>`).join('');
                return `<details open><summary class="inline-block">Array(${obj.length}) [</summary><ul class="pl-4">${content}</ul>]</details>`;
            }

            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '{}';
                let content = keys.map(key => `<li><span class="key">"${key}"</span>: ${formatJsonToHtml(obj[key])}</li>`).join('');
                return `<details open><summary class="inline-block">Object {</summary><ul class="pl-4">${content}</ul>}</details>`;
            }
            
            return obj.toString();
        }

        function createGoogleCalendarLink(text, context) {
            let date = new Date();
            let title = "New Event";
            const titleMatch = context.match(/(?:deadline for|meeting on|schedule)\s(.*?)(?=\sfor|\son|\sat)/i);
            if (titleMatch) title = titleMatch[1];

            const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/i);
            if (timeMatch) {
                let hours = parseInt(timeMatch[1]);
                const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                const ampm = timeMatch[3].toLowerCase();
                if (ampm === 'pm' && hours < 12) hours += 12;
                if (ampm === 'am' && hours === 12) hours = 0;
                date.setHours(hours, minutes, 0, 0);
            }

            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayMatch = text.match(new RegExp(`next (${days.join('|')})`, 'i'));
            if (dayMatch) {
                const targetDay = days.indexOf(dayMatch[1].toLowerCase());
                const currentDay = date.getDay();
                let dayDifference = targetDay - currentDay;
                if (dayDifference <= 0) dayDifference += 7;
                date.setDate(date.getDate() + dayDifference);
            }

            const startDate = date.toISOString().replace(/-|:|\.\d{3}/g, '');
            date.setHours(date.getHours() + 1);
            const endDate = date.toISOString().replace(/-|:|\.\d{3}/g, '');

            const details = `Event details: ${context}`;
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
            return url;
        }

        function handleTextareaKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey && !submitButton.disabled) {
                e.preventDefault();
                handleSendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.style.overflowY = textarea.scrollHeight > 200 ? 'auto' : 'hidden';
        }

        function updateSendButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            const hasFile = !!attachedFile;
            const canSend = hasText || hasFile;
            
            submitButton.disabled = !canSend;
            submitButton.classList.toggle('bg-theme-tertiary', !canSend);
            submitButton.classList.toggle('hover:bg-theme-accent', canSend);
            submitButton.classList.toggle('bg-theme-quaternary', canSend);
        }
        
        function makeTablesResponsive(element) {
            if (!element) return;
            element.querySelectorAll('table').forEach(table => {
                if (table.parentElement.classList.contains('table-responsive-wrapper')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'table-responsive-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }

        function enhanceCodeBlocks(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            messageElement.querySelectorAll('pre').forEach(block => {
                const code = block.querySelector('code');
                if (!code || block.querySelector('.code-btn-wrapper')) return;

                const btnWrapper = document.createElement('div');
                btnWrapper.className = 'code-btn-wrapper';
                
                const codeText = code.innerText;
                const language = Array.from(code.classList).find(c => c.startsWith('language-'))?.replace('language-', '');

                if (['html', 'markup', 'xml'].includes(language)) {
                    const previewBtn = document.createElement('button');
                    previewBtn.className = 'code-action-btn';
                    previewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg> <span>Preview</span>`;
                    previewBtn.addEventListener('click', () => showCodePreviewModal(codeText, language));
                    btnWrapper.appendChild(previewBtn);
                }
                
                if (['javascript', 'html'].includes(language) && /(new Chart|d3\.select)/.test(codeText)) {
                     const vizBtn = document.createElement('button');
                    vizBtn.className = 'code-action-btn';
                    vizBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg><span>Visualize</span>`;
                    vizBtn.addEventListener('click', () => showCodePreviewModal(codeText, language));
                    btnWrapper.appendChild(vizBtn);
                }
                
                if (vizLanguages.includes(language)) {
                     const vizBtn = document.createElement('button');
                    vizBtn.className = 'code-action-btn';
                    vizBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m10 8 6 4-6 4z"/></svg><span>Edit & Visualize</span>`;
                    vizBtn.addEventListener('click', () => showCodeVisualizationModal(codeText, language));
                    btnWrapper.appendChild(vizBtn);
                }

                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg> <span>Copy</span>`;
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeText).then(() => {
                        showNotification('Code copied to clipboard', 'success');
                    }).catch(err => {
                        showNotification('Failed to copy code', 'error');
                    });
                });
                btnWrapper.appendChild(copyBtn);

                block.appendChild(btnWrapper);
            });
        }
        
        function renderHistorySidebar() {
            const searchTerm = searchHistoryInput.value.toLowerCase();
            historyList.innerHTML = '';
            
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));

            clearAllBtn.style.display = sortedChats.length > 0 ? 'block' : 'none';

            sortedChats.forEach(chat => {
                const li = document.createElement('li');
                li.dataset.chatId = chat.id;
                const isActive = chat.id === currentChatId;
                
                const titleText = chat.title || 'New Chat';

                if (searchTerm && !titleText.toLowerCase().includes(searchTerm)) {
                    li.classList.add('hidden');
                }
                
                li.className = `history-item-container flex items-center justify-between rounded-md group ${isActive ? 'bg-theme-tertiary' : 'hover:bg-theme-tertiary/50'} ${li.classList.contains('hidden') ? 'hidden' : ''}`;

                const titleContainer = document.createElement('div');
                titleContainer.className = 'flex-1 text-left px-3 py-2 truncate flex items-center gap-2';
                
                let medicalIndicator = '';
                if (chat.isMedical) {
                    medicalIndicator = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500 flex-shrink-0">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                        <path d="M12 5L8 21l4-7 4 7-4-16"/>
                    </svg>`;
                }
                
                titleContainer.innerHTML = `${medicalIndicator}<span class="text-sm ${isActive ? 'text-theme-primary' : 'text-theme-secondary group-hover:text-theme-primary'} truncate">${titleText}</span>`;
                titleContainer.addEventListener('click', () => loadChat(chat.id));
                
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'history-item-actions flex items-center pr-2';
                
                const renameBtn = document.createElement('button');
                renameBtn.className = 'p-1.5 text-theme-quaternary hover:text-theme-primary';
                renameBtn.title = 'Rename chat';
                renameBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
                renameBtn.onclick = (e) => { e.stopPropagation(); handleRename(chat.id, titleContainer); };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'p-1.5 text-theme-quaternary hover:text-theme-error';
                deleteBtn.title = 'Delete chat';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                deleteBtn.onclick = (e) => { e.stopPropagation(); showDeleteModal(chat.id); };

                actionsContainer.appendChild(renameBtn);
                actionsContainer.appendChild(deleteBtn);

                li.appendChild(titleContainer);
                li.appendChild(actionsContainer);
                historyList.appendChild(li);
            });
        }
        
        async function handleRename(chatId, titleContainer) {
            const currentTitle = allChats[chatId].title || 'New Chat';
            const titleSpan = titleContainer.querySelector('span');

            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'w-full bg-theme-quaternary text-theme-primary text-sm rounded px-1 py-0';
            
            titleSpan.style.display = 'none';
            titleContainer.appendChild(input);
            input.focus();
            input.select();
            
            const saveRename = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    await updateDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", chatId), { title: newTitle });
                    allChats[chatId].title = newTitle;
                    showNotification('Chat renamed!', 'success');
                }
                renderHistorySidebar();
            };
            
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveRename();
                } else if (e.key === 'Escape') {
                    renderHistorySidebar();
                }
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
        }

        function toggleForm(isEnabled) {
            chatInput.disabled = !isEnabled;
            micBtn.disabled = !isEnabled;
            attachFileBtn.disabled = !isEnabled;
            if(isEnabled) {
                updateSendButtonState();
                chatInput.focus();
            } else {
                submitButton.disabled = true;
            }
        }

        function startNewChat() {
            currentChatId = null;
            if (isMedicalMode) {
                showMedicalWelcomeContent();
            } else {
                showWelcomeContent();
            }
            renderHistorySidebar();
            removeAttachedFile();
            if (isTTSActive) {
                stopTTS();
            }
            showNotification('Started new chat', 'success');
            exportBtn.disabled = true;

            if (window.innerWidth < 1024) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            }
        }

        async function loadChat(chatId) {
            if (!currentUser || !allChats[chatId]) return;
            currentChatId = chatId;
            chatContainer.innerHTML = '';
            exportBtn.disabled = false;

            if (isTTSActive) {
                stopTTS();
            }

            const chatIsMedical = allChats[chatId].isMedical || false;
            if (chatIsMedical !== isMedicalMode) {
                isMedicalMode = chatIsMedical;
                medicalModeIndicator.classList.toggle('hidden', !isMedicalMode);
                
                if (isMedicalMode) {
                    medicalAiBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    medicalAiBtn.classList.add('bg-green-800', 'hover:bg-green-900');
                    chatAiBtn.classList.remove('hidden');
                    updateInputPlaceholder('Ask about symptoms, medications, health advice...');
                } else {
                    medicalAiBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    medicalAiBtn.classList.remove('bg-green-800', 'hover:bg-green-900');
                    chatAiBtn.classList.add('hidden');
                    updateInputPlaceholder('Enter Your Prompt or paste code to visualize...');
                }
            }

            if (!allChats[chatId].messages || allChats[chatId].messages.length === 0) {
                const messagesQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", chatId, "messages"));
                const messagesSnapshot = await getDocs(messagesQuery);
                const messages = messagesSnapshot.docs.map(doc => doc.data()).sort((a,b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                allChats[chatId].messages = messages;
            }
            
            allChats[chatId].messages.forEach(msg => {
                 const textContent = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';
                 const messageElementId = appendMessage({ text: textContent }, msg.role);
                 const messageElement = document.getElementById(messageElementId);
                 if (msg.role === 'model') {
                     enhanceResponseMessage(messageElement, textContent);
                 }
            });

            renderHistorySidebar();
            scrollToBottomInstant();
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        async function loadChatsFromFirestore() {
            if (!currentUser) return;
            const chatsQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            allChats = {};
            querySnapshot.forEach((doc) => {
                allChats[doc.id] = { id: doc.id, ...doc.data(), messages: [] };
            });

            loadMostRecentChat();
        }

        function loadMostRecentChat() {
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
            if (sortedChats.length > 0) {
                loadChat(sortedChats[0].id);
            } else {
                startNewChat();
            }
        }

        function showDeleteModal(chatId) {
            chatIdToDelete = chatId;
            deleteModalTitle.textContent = chatId ? "Delete Chat?" : "Delete All Chats?";
            deleteModalText.textContent = `This will permanently delete ${chatId ? 'this conversation' : 'all conversations'}. This action cannot be undone.`;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function hideDeleteModal() {
            chatIdToDelete = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }

        function showPreviewModal(htmlCode) {
            const fullHtml = `<html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="https://cdn.tailwindcss.com"><\/script></head><body>${htmlCode}</body></html>`;
            previewIframe.srcdoc = fullHtml;
            previewModal.classList.remove('hidden');
            previewModal.classList.add('flex');
        }

        function hidePreviewModal() {
            previewIframe.srcdoc = '';
            previewModal.classList.add('hidden');
            previewModal.classList.remove('flex');
        }

        async function confirmDeletion() {
            if (chatIdToDelete) {
                await handleSingleDelete();
            } else {
                await handleDeleteAll();
            }
        }

        async function handleSingleDelete() {
            if (!chatIdToDelete || !currentUser) return;
            const idToDelete = chatIdToDelete;
            const wasCurrentChat = idToDelete === currentChatId;
            await deleteDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", idToDelete));
            delete allChats[idToDelete];
            hideDeleteModal();
            renderHistorySidebar();
            if (wasCurrentChat) {
                loadMostRecentChat();
            }
            showNotification('Chat deleted', 'success');
        }

        async function handleDeleteAll() {
            if(!currentUser) return;
            const chatsQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            allChats = {};
            hideDeleteModal();
            renderHistorySidebar();
            startNewChat();
            showNotification('All chats deleted', 'success');
        }

        function toggleVoiceRecognition() {
            if (micIcon.classList.contains('mic-active')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    micIcon.classList.add('mic-active', 'animate-pulse');
                    showNotification('Listening... Speak now', 'info');
                } catch(e) { 
                    console.error("Could not start recognition:", e);
                    showNotification('Voice recognition not available', 'error');
                }
            }
        }

        function handleVoiceResult(event) {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            updateSendButtonState();
            autoResizeTextarea(chatInput);
            showNotification(`Voice input: "${transcript}"`, 'success');
        }
        
        function handleExport(format) {
            if (!currentChatId) {
                showNotification("No active chat to export.", "error");
                return;
            }

            const chat = allChats[currentChatId];
            const title = chat.title || 'chat-export';
            const messages = chat.messages || [];
            let content = '';

            if (format === 'txt') {
                content = messages.map(msg => {
                    const sender = msg.role === 'user' ? 'User' : (chat.isMedical ? 'Medical AI' : 'Chat@AI');
                    const text = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';
                    return `${sender}:\n${text}\n\n--------------------------------\n\n`;
                }).join('');
            } else if (format === 'md') {
                content = `# ${title}\n\n`;
                if (chat.isMedical) {
                    content += `**Medical AI Chat Export**\n\n`;
                    content += `⚠️ **Medical Disclaimer**: This conversation contains AI-generated health information for educational purposes only. Always consult healthcare professionals for medical advice.\n\n---\n\n`;
                }
                content += messages.map(msg => {
                    const sender = msg.role === 'user' ? '> **User**' : (chat.isMedical ? '**Medical AI**' : '**Chat@AI**');
                    const text = msg.parts.find(p => p.text)?.text || '`[Multimedia Content]`';
                    return `${sender}\n\n${text}\n\n---\n\n`;
                }).join('');
            } else if (format === 'pdf') {
                exportToPdf(title, messages, chat.isMedical);
                return;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Chat exported as ${format.toUpperCase()}`, 'success');
        }
        
        function exportToPdf(title, messages, isMedical = false) {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             let y = 15;
             const pageHeight = doc.internal.pageSize.height;
             const margin = 10;
             const maxWidth = doc.internal.pageSize.width - margin * 2;
             
             doc.setFontSize(18);
             doc.text(title, margin, y);
             y += 15;
             
             if (isMedical) {
                 doc.setFontSize(12);
                 doc.text('Medical AI Chat Export', margin, y);
                 y += 10;
                 doc.setFontSize(10);
                 const disclaimer = 'Medical Disclaimer: This conversation contains AI-generated health information for educational purposes only. Always consult healthcare professionals for medical advice.';
                 const disclaimerLines = doc.splitTextToSize(disclaimer, maxWidth);
                 doc.text(disclaimerLines, margin, y);
                 y += (disclaimerLines.length * 4) + 10;
             }
             
             messages.forEach(msg => {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                 
                const sender = msg.role === 'user' ? 'User' : (isMedical ? 'Medical AI' : 'Chat@AI');
                const text = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';

                doc.setFontSize(12).setFont(undefined, 'bold');
                doc.text(sender, margin, y);
                y += 6;
                
                doc.setFontSize(10).setFont(undefined, 'normal');
                const lines = doc.splitTextToSize(text, maxWidth);
                doc.text(lines, margin, y);
                y += (lines.length * 4.5) + 10;
             });
             
             doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
             showNotification('Chat exported as PDF', 'success');
        }

        function appendLoadingIndicator() {
            const loadingHtml = `
                <div id="loading-indicator" class="flex items-center gap-2 sm:gap-3">
                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full ${isMedicalMode ? 'bg-green-600' : 'bg-theme-accent'} flex items-center justify-center shadow-md">
                       ${isMedicalMode ? 
                         `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                            <path d="M12 5L8 21l4-7 4 7-4-16"/>
                          </svg>` :
                         `<img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full shadow-md" />`
                       }
                    </div>
                    <div class="rounded-lg max-w-lg flex items-center justify-center">
                        <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 120px; height: 120px;" loop autoplay></dotlottie-player>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
        }

        function addEventListeners() {
            // Auth form switching
            showSignupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });

            // Auth form submission
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);

            // Password visibility toggle
            document.getElementById('login-password-toggle').addEventListener('click', () => togglePasswordVisibility('login-password'));
            document.getElementById('signup-password-toggle').addEventListener('click', () => togglePasswordVisibility('signup-password'));

            // Advanced Auth UI Listeners
            signupPasswordInput.addEventListener('input', updatePasswordStrength);
            signupEmailInput.addEventListener('input', validateEmail);

            // Profile & Logout
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
                exportDropdown.classList.remove('show');
                themeDropdown.classList.remove('show');
            });
            logoutBtn.addEventListener('click', handleLogout);
            homeBtn.addEventListener('click', handleHome);
            
            // Profile Settings
            profileSettingsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                profileDropdown.classList.remove('show');
                showProfileSettings();
            });
            
            // Theme Selector
            themeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                themeDropdown.classList.toggle('show');
                profileDropdown.classList.remove('show');
                exportDropdown.classList.remove('show');
            });
            themeDropdown.addEventListener('click', (e) => {
                const themeOption = e.target.closest('.theme-option');
                if (themeOption) {
                    handleThemeChange(themeOption.dataset.theme);
                }
            });
            
            // Export Dropdown
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportDropdown.classList.toggle('show');
                profileDropdown.classList.remove('show');
                themeDropdown.classList.remove('show');
            });
            exportDropdown.addEventListener('click', (e) => {
                const format = e.target.closest('.dropdown-item')?.dataset.format;
                if(format) {
                    handleExport(format);
                }
            });

            document.addEventListener('click', (e) => {
                 if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
                 if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('show');
                }
                 if (!themeBtn.contains(e.target) && !themeDropdown.contains(e.target)) {
                    themeDropdown.classList.remove('show');
                }
            });

            // Chat app event listeners
            chatForm.addEventListener('submit', handleSendMessage);
            newChatBtn.addEventListener('click', startNewChat);
            medicalAiBtn.addEventListener('click', toggleMedicalMode);
            chatAiBtn.addEventListener('click', switchToChatAI);
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            searchHistoryInput.addEventListener('input', () => renderHistorySidebar());
            clearAllBtn.addEventListener('click', () => showDeleteModal(null));
            confirmDeleteBtn.addEventListener('click', confirmDeletion);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            closePreviewBtn.addEventListener('click', hidePreviewModal);
            stopGeneratingBtn.addEventListener('click', () => {
                stopGenerationFlag = true;
                if (isTTSActive) {
                    stopTTS();
                }
                showNotification('Generation stopped', 'info');
            });

            chatInput.addEventListener('input', () => {
                autoResizeTextarea(chatInput);
                updateSendButtonState();
            });
            chatInput.addEventListener('keydown', handleTextareaKeydown);

            // Multimedia listeners
            attachFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            removeFileBtn.addEventListener('click', removeAttachedFile);

            if (recognition) {
                micBtn.addEventListener('click', toggleVoiceRecognition);
                recognition.onresult = handleVoiceResult;
                recognition.onend = () => {
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                    showNotification('Voice input ended', 'info');
                };
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                    showNotification('Voice recognition error', 'error');
                };
            } else {
                 micBtn.disabled = true;
            }

            // Delegated Listeners for dynamic content
            chatContainer.addEventListener('click', (e) => {
                const suggestionCard = e.target.closest('.suggestion-card');
                if (suggestionCard) {
                    fillSuggestion(suggestionCard.dataset.suggestion);
                    return;
                }
            });
            
            closeInteractiveModalBtn.addEventListener('click', hideInteractiveModal);

            // Enhanced Features Event Listeners
            promptLibraryBtn.addEventListener('click', showPromptLibrary);
            schedulerBtn.addEventListener('click', showScheduler);

            // Profile Settings Modal
            document.getElementById('close-profile-settings-btn').addEventListener('click', hideProfileSettings);
            document.getElementById('cancel-profile-settings-btn').addEventListener('click', hideProfileSettings);
            document.getElementById('save-profile-settings-btn').addEventListener('click', saveProfileSettings);
            document.getElementById('upload-avatar-btn').addEventListener('click', () => document.getElementById('avatar-upload').click());
            document.getElementById('avatar-upload').addEventListener('change', handleAvatarUpload);

            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                });
            });

            // Prompt Library Modal
            document.getElementById('close-prompt-library-btn').addEventListener('click', hidePromptLibrary);
            document.getElementById('add-prompt-btn').addEventListener('click', () => showAddPrompt());
            document.getElementById('search-prompts').addEventListener('input', renderPromptLibrary);
            document.getElementById('filter-category').addEventListener('change', renderPromptLibrary);

            // Add Prompt Modal
            document.getElementById('close-add-prompt-btn').addEventListener('click', hideAddPrompt);
            document.getElementById('cancel-add-prompt-btn').addEventListener('click', hideAddPrompt);
            document.getElementById('save-prompt-btn').addEventListener('click', savePrompt);

            // Scheduler Modal
            document.getElementById('close-scheduler-btn').addEventListener('click', hideScheduler);
            document.getElementById('add-schedule-btn').addEventListener('click', () => showAddSchedule());

            // Add Schedule Modal
            document.getElementById('close-add-schedule-btn').addEventListener('click', hideAddSchedule);
            document.getElementById('cancel-add-schedule-btn').addEventListener('click', hideAddSchedule);
            document.getElementById('save-schedule-btn').addEventListener('click', saveScheduledTask);
        }

        // --- INITIALIZATION ---
        function init() {
            marked.setOptions({
                gfm: true,
                breaks: true,
                sanitizer: (html) => html,
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            });
            initializeTheme();
            initializeMonaco();
            initializeTTS();
            initializeScrollHandling();
            addEventListeners();
            checkAPIStatus();
            checkAuthState();
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
