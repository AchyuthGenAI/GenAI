<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat-AI</title>
    <link rel="icon" type="image/webp" href="https://i.ibb.co/MCLkk0y/icon-png.webp">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            font-family: Arial, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #2e333f; /* Matches dark theme */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-heartbeat {
            font-size: 100px; /* Size of the icon */
            color: #00c6ff; /* Matches theme colors */
            animation: heartbeat 1.2s infinite ease-in-out;
        }

        @keyframes heartbeat {
            0%, 100% {
                transform: scale(1);
            }
            20% {
                transform: scale(1.2);
            }
            40% {
                transform: scale(1);
            }
            60% {
                transform: scale(1.2);
            }
            80% {
                transform: scale(1);
            }
        }

        /* Dark Theme (Default) */
        body.dark-theme {
            background-color: #2e333f;
            color: #ffffff; /* White text for dark theme */
        }

        body.dark-theme .navbar {
            background-color: #2e333f;
            color: #ffffff; /* White text */
        }

        body.dark-theme .navbar-brand {
            color: transparent; /* Maintain gradient text */
        }

        body.dark-theme .home-button {
            color: #ffffff; /* White text for contrast */
        }

        body.dark-theme .history-panel {
            background-color: rgba(20, 20, 20, 0.95);
            color: #ffffff; /* White text */
        }

        body.dark-theme .history-panel h3 {
            color: #00c6ff; /* Keep accent color */
        }

        body.dark-theme .chat-container,
        body.dark-theme .chat-box,
        body.dark-theme .chat-box::-webkit-scrollbar-track {
            background-color: #2e333f;
            color: #ffffff; /* White text */
        }

        body.dark-theme .input-group,
        body.dark-theme .send-btn,
        body.dark-theme .voice-btn,
        body.dark-theme .stop-btn {
            background-color: #444;
            color: #ffffff; /* White text */
        }

        body.dark-theme .stop-btn {
            background-color: #ff6f61;
            color: #ffffff; /* White text */
        }

        body.dark-theme .newChatBtn {
            color: #ffffff; /* White text */
        }

        body.dark-theme .history-item {
            background-color: #2e333f;
            border: 1px solid #444;
            color: #ffffff; /* White text */
        }

        body.dark-theme .history-item:hover {
            background-color: #3a3f4b;
        }

        body.dark-theme .history-item .content .question {
            color: #ffffff; /* White text */
        }

        body.dark-theme .history-item .content .meta {
            color: #aaaaaa; /* Light gray for meta */
        }

        body.dark-theme .history-item .delete-btn {
            color: #ff6f61; /* Keep accent color */
        }

        body.dark-theme .message.user {
            background-color: #ffffff;
            color: #000000; /* Black text for contrast */
            margin-left: auto;
        }

        body.dark-theme .message.bot {
            background-color: #444;
            color: #ffffff; /* White text */
            margin-right: auto;
        }

        body.dark-theme .markdown-container {
            color: #ffffff; /* White text */
        }

        body.dark-theme .markdown-container pre {
            background: #1e1e1e;
            color: #ffffff; /* White text for code */
        }

        body.dark-theme .markdown-container code {
            color: #ffffff; /* White text for inline code */
        }

        body.dark-theme footer {
            color: #dddddd; /* Light gray text */
        }

        body.dark-theme footer a {
            color: #00adb5; /* Accent color for links */
        }

        body.dark-theme .search-bar {
            background: linear-gradient(135deg, #3a3f4b, #2e333f);
        }

        body.dark-theme .search-bar input {
            color: #ffffff; /* White text */
        }

        body.dark-theme .search-bar input::placeholder {
            color: #bbbbbb; /* Light gray placeholder */
        }

        body.dark-theme .search-bar .search-icon {
            color: #00c6ff; /* Accent color */
        }

        body.dark-theme .search-bar .clear-search {
            color: #aaaaaa; /* Light gray */
        }

        body.dark-theme .search-bar .clear-search:hover {
            color: #ff6f61; /* Accent color on hover */
        }

        body.dark-theme .clear-history-button,
        body.dark-theme .fancy-button {
            color: #ffffff; /* White text */
        }

        body.dark-theme .theme-dropdown .dropdown-menu {
            background-color: #3a3f4b;
            border: 1px solid #444;
            color: #ffffff; /* White text */
        }

        body.dark-theme .theme-dropdown .dropdown-item {
            color: #ffffff; /* White text */
        }

        body.dark-theme .theme-dropdown .dropdown-item:hover {
            background-color: #444;
            color: #ffffff; /* White text */
        }

        /* Light Theme */
        body.light-theme {
            background-color: #f5f5f5;
            color: #333333; /* Dark gray text for light theme */
        }

        body.light-theme .navbar {
            background-color: #ffffff;
            color: #333333; /* Dark gray text */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .navbar-brand {
            color: transparent; /* Maintain gradient text */
        }

        body.light-theme .home-button {
            color: #ffffff; /* White text for contrast */
        }

        body.light-theme .history-panel {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333333; /* Dark gray text */
        }

        body.light-theme .history-panel h3 {
            color: #00c6ff; /* Keep accent color */
        }

        body.light-theme .chat-container,
        body.light-theme .chat-box,
        body.light-theme .chat-box::-webkit-scrollbar-track {
            background-color: #f5f5f5;
            color: #333333; /* Dark gray text */
        }

        body.light-theme .input-group,
        body.light-theme .send-btn,
        body.light-theme .voice-btn,
        body.light-theme .stop-btn {
            background-color: #e0e0e0;
            color: #333333; /* Dark gray text */
        }

        body.light-theme .stop-btn {
            background-color: #dc3545;
            color: #ffffff; /* White text for contrast */
        }

        body.light-theme .newChatBtn {
            color: #ffffff; /* White text */
        }

        body.light-theme .history-item {
            background-color: #ffffff;
            border: 1px solid #cccccc;
            color: #333333; /* Dark gray text */
        }

        body.light-theme .history-item:hover {
            background-color: #e8ecef;
        }

        body.light-theme .history-item .content .question {
            color: #333333; /* Dark gray text */
        }

        body.light-theme .history-item .content .meta {
            color: #666666; /* Medium gray for meta */
        }

        body.light-theme .history-item .delete-btn {
            color: #dc3545; /* Accent color */
        }

        body.light-theme .message.user {
            background-color: #007bff;
            color: #ffffff; /* White text for contrast */
            margin-left: auto;
        }

        body.light-theme .message.bot {
            background-color: #e9ecef;
            color: #333333; /* Dark gray text */
            margin-right: auto;
        }

        body.light-theme .markdown-container {
            color: #333333; /* Dark gray text */
        }

        body.light-theme .markdown-container pre {
            background: #1e1e1e;
            color: #ffffff; /* White text for code (high contrast) */
        }

        body.light-theme .markdown-container code {
            color: #ffffff; /* White text for inline code */
        }

        body.light-theme footer {
            color: #666666; /* Medium gray text */
        }

        body.light-theme footer a {
            color: #007bff; /* Accent color for links */
        }

        body.light-theme .search-bar {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
        }

        body.light-theme .search-bar input {
            color: #333333; /* Dark gray text */
        }

        body.light-theme .search-bar input::placeholder {
            color: #888888; /* Gray placeholder */
        }

        body.light-theme .search-bar .search-icon {
            color: #007bff; /* Accent color */
        }

        body.light-theme .search-bar .clear-search {
            color: #666666; /* Medium gray */
        }

        body.light-theme .search-bar .clear-search:hover {
            color: #dc3545; /* Accent color on hover */
        }

        body.light-theme .clear-history-button,
        body.light-theme .fancy-button {
            color: #ffffff; /* White text */
        }

        body.light-theme .theme-dropdown .dropdown-menu {
            background-color: #ffffff;
            border: 1px solid #cccccc;
            color: #333333; /* Dark gray text */
        }

        body.light-theme .theme-dropdown .dropdown-item {
            color: #333333; /* Dark gray text */
        }

        body.light-theme .theme-dropdown .dropdown-item:hover {
            background-color: #e8ecef;
            color: #333333; /* Dark gray text */
        }

        /* Sepia Theme */
        body.sepia-theme {
            background-color: #f4ecd8;
            color: #5c4b38; /* Dark brown text for sepia theme */
        }

        body.sepia-theme .navbar {
            background-color: #ead9b8;
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .navbar-brand {
            color: transparent; /* Maintain gradient text */
        }

        body.sepia-theme .home-button {
            color: #ffffff; /* White text for contrast */
        }

        body.sepia-theme .history-panel {
            background-color: rgba(234, 217, 184, 0.95);
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .history-panel h3 {
            color: #00c6ff; /* Keep accent color */
        }

        body.sepia-theme .chat-container,
        body.sepia-theme .chat-box,
        body.sepia-theme .chat-box::-webkit-scrollbar-track {
            background-color: #f4ecd8;
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .input-group,
        body.sepia-theme .send-btn,
        body.sepia-theme .voice-btn,
        body.sepia-theme .stop-btn {
            background-color: #d9c8a6;
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .stop-btn {
            background-color: #6b4e31;
            color: #ffffff; /* White text for contrast */
        }

        body.sepia-theme .newChatBtn {
            color: #ffffff; /* White text */
        }

        body.sepia-theme .history-item {
            background-color: #ead9b8;
            border: 1px solid #b8a57b;
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .history-item:hover {
            background-color: #e0cfa0;
        }

        body.sepia-theme .history-item .content .question {
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .history-item .content .meta {
            color: #8b6f47; /* Medium brown for meta */
        }

        body.sepia-theme .history-item .delete-btn {
            color: #6b4e31; /* Accent color */
        }

        body.sepia-theme .message.user {
            background-color: #8b6f47;
            color: #ffffff; /* White text for contrast */
            margin-left: auto;
        }

        body.sepia-theme .message.bot {
            background-color: #ead9b8;
            color: #5c4b38; /* Dark brown text */
            margin-right: auto;
        }

        body.sepia-theme .markdown-container {
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .markdown-container pre {
            background: #1e1e1e;
            color: #ffffff; /* White text for code (high contrast) */
        }

        body.sepia-theme .markdown-container code {
            color: #ffffff; /* White text for inline code */
        }

        body.sepia-theme footer {
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme footer a {
            color: #6b4e31; /* Accent color for links */
        }

        body.sepia-theme .search-bar {
            background: linear-gradient(135deg, #ead9b8, #d9c8a6);
        }

        body.sepia-theme .search-bar input {
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .search-bar input::placeholder {
            color: #8b6f47; /* Medium brown placeholder */
        }

        body.sepia-theme .search-bar .search-icon {
            color: #6b4e31; /* Accent color */
        }

        body.sepia-theme .search-bar .clear-search {
            color: #8b6f47; /* Medium brown */
        }

        body.sepia-theme .search-bar .clear-search:hover {
            color: #6b4e31; /* Accent color on hover */
        }

        body.sepia-theme .clear-history-button,
        body.sepia-theme .fancy-button {
            color: #ffffff; /* White text */
        }

        body.sepia-theme .theme-dropdown .dropdown-menu {
            background-color: #ead9b8;
            border: 1px solid #b8a57b;
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .theme-dropdown .dropdown-item {
            color: #5c4b38; /* Dark brown text */
        }

        body.sepia-theme .theme-dropdown .dropdown-item:hover {
            background-color: #e0cfa0;
            color: #5c4b38; /* Dark brown text */
        }

        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            position: relative;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-center {
            display: flex;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .navbar-brand {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00c6ff, #0072ff, #ff00ff, #ff6f61);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        .history-panel {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 90%;
            max-width: 400px;
            height: calc(100vh - 100px);
            padding: 20px;
            z-index: 1000;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }

        .history-panel.active {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }

        .history-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ff6f61;
            font-size: 18px;
            cursor: pointer;
        }

        .history-panel .close-btn:hover {
            color: #ff3f31;
        }

        .history-panel::-webkit-scrollbar {
            width: 8px;
        }

        .history-panel::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 50px;
        }

        .history-panel::-webkit-scrollbar-track {
            border-radius: 50px;
        }

        body.dark-theme .history-panel::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.7);
        }

        body.light-theme .history-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.7);
        }

        body.sepia-theme .history-panel::-webkit-scrollbar-track {
            background: rgba(234, 217, 184, 0.7);
        }

        .history-panel h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .toggle-history {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #ffffff; /* White icon */
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .toggle-history:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .toggle-history i {
            font-size: 20px;
        }

        .theme-dropdown {
            display: flex;
            align-items: center;
        }

        .theme-dropdown .btn {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #ffffff; /* White icon */
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .theme-dropdown .btn:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .theme-dropdown .btn:active {
            transform: scale(0.95);
        }

        .theme-dropdown .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-width: 120px;
        }

        .theme-dropdown .dropdown-item {
            padding: 8px 16px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .theme-dropdown .dropdown-item:hover {
            cursor: pointer;
        }

        .search-bar {
            position: relative;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            border-radius: 25px;
            padding: 5px 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .search-bar:hover,
        .search-bar.active {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 198, 255, 0.2);
        }

        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: none;
            border-radius: 25px;
            background: transparent;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            background: rgba(69, 75, 91, 0.8);
            box-shadow: inset 0 0 5px rgba(0, 198, 255, 0.5);
        }

        .search-bar input:focus::placeholder {
            opacity: 0;
            transform: translateX(-15px);
        }

        .search-bar .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .search-bar input:focus+.search-icon {
            transform: translateY(-50%) scale(1.1);
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .history-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .history-item .icon {
            margin-right: 10px;
            font-size: 18px;
            color: #00c6ff;
        }

        .history-item .content {
            flex-grow: 1;
            overflow: hidden;
        }

        .history-item .content .question {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .history-item .content .meta {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .history-item .delete-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .history-item .delete-btn:hover {
            color: #ff3f31;
        }

        /* Ensure the container respects navbar and footer heights */
        .container {
            display: flex;
            height: calc(100vh - 70px - 60px); /* Subtract navbar (70px) and footer (60px) heights */
            overflow: hidden;
            flex-direction: column;
        }

        /* Chat container adjustments */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative; /* Ensure relative positioning for child elements */
        }

        .chat-box {
            border-radius: 12px;
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 70px; /* Increased to account for input group height */
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            box-sizing: border-box;
        }

        .chat-box::-webkit-scrollbar {
            width: 8px;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 12px;
        }

        .message {
            margin: 10px 15px;
            padding: 10px 15px;
            border-radius: 10px;
            width: fit-content;
            max-width: 70%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .markdown-container {
            line-height: 1.6;
            font-size: 16px;
        }

        .markdown-container pre {
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .markdown-container code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            font-weight: normal;
            background: none;
        }

        .markdown-container ul, .markdown-container ol {
            padding-left: 20px;
        }

        .markdown-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .markdown-container th, .markdown-container td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #00c6ff;
            color: #ffffff; /* White text */
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: #0072ff;
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .copy-btn.copied::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
        }

        .input-group {
            display: flex;
            position: sticky; /* Changed from relative to sticky for better mobile behavior */
            bottom: 0; /* Stick to the bottom of the chat container */
            top: auto; /* Remove top: -60px */
            border-radius: 50px;
            padding: 10px 20px;
            align-items: center;
            z-index: 100; /* Ensure it stays above other content */
            background-color: inherit; /* Match the theme background */
            margin-bottom: 10px; /* Space above footer */
        }

        .input-group textarea {
            padding: 15px 60px 15px 60px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            resize: none;
            overflow-y: hidden;
            min-height: 50px;
            max-height: 150px;
            width: 100%;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
            scrollbar-width: thin;
            scrollbar-color: #00c6ff #333;
        }

        body.dark-theme .input-group textarea {
            background-color: #444;
            color: #ffffff; /* White text */
        }

        body.light-theme .input-group textarea {
            background-color: #e0e0e0;
            color: #333333; /* Dark gray text */
        }

        body.sepia-theme .input-group textarea {
            background-color: #d9c8a6;
            color: #5c4b38; /* Dark brown text */
        }

        .input-group textarea::-webkit-scrollbar {
            width: 8px;
        }

        .input-group textarea::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }

        .input-group textarea::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .input-group textarea::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #00a6dd, #005fcc);
        }

        .input-group textarea:focus {
            box-shadow: 0 0 5px rgba(0, 198, 255, 0.5);
        }

        .send-btn {
            position: absolute;
            right: 40px;
            bottom: 50%;
            transform: translateY(50%);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .stop-btn {
            position: absolute;
            right: 40px;
            bottom: 50%;
            transform: translateY(50%);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .voice-btn {
            position: absolute;
            left: 30px;
            bottom: 50%;
            transform: translateY(50%);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .send-btn:hover,
        .voice-btn:hover,
        .stop-btn:hover {
            filter: brightness(1.2);
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        .loader div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            border-radius: 50%;
            background-color: #3498db;
            animation: wave 1.5s infinite ease-in-out;
        }

        .loader div:nth-child(1) {
            animation-delay: -0.3s;
        }

        .loader div:nth-child(2) {
            animation-delay: -0.15s;
        }

        .loader div:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes wave {
            50%, 100% {
                transform: scale(0);
            }
            50% {
                transform: scale(1);
            }
        }

        footer {
            text-align: center;
            padding: 15px;
            background-color: transparent;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 14px;
            z-index: 50; /* Lower z-index to stay below input group */
        }

        footer a {
            text-decoration: none;
            transition: all 0.3s ease;
        }

        footer a:hover {
            text-decoration: underline;
        }

        body.dark-theme footer a:hover {
            color: #00bcd4; /* Accent color */
        }

        body.light-theme footer a:hover {
            color: #0056b3; /* Darker accent */
        }

        body.sepia-theme footer a:hover {
            color: #4a3722; /* Darker brown */
        }

        .fancy-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fancy-button:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .fancy-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .clear-history-button {
            background: linear-gradient(135deg, #ff3f31, #ff6f61);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .clear-history-button:hover {
            background: linear-gradient(135deg, #ff6f61, #ff3f31);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .clear-history-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .nav-right {
            display: flex;
            align-items: center;
        }

        .home-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            padding: 8px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .home-button:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
            color: #ffffff; /* White text */
        }

        .home-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .history-item:focus {
            outline: 2px solid #00c6ff;
            outline-offset: 2px;
        }

        @media (max-width: 768px) {
            .container {
                height: calc(100vh - 60px - 60px); /* Adjust for smaller navbar height on mobile */
            }
            .chat-box {
                padding: 10px;
                margin-bottom: 80px; /* Extra space for input group */
            }
            .input-group {
                padding: 8px 15px; /* Slightly smaller padding for mobile */
                margin-bottom: 15px; /* Ensure space above footer */
            }
            .input-group textarea {
                padding: 10px 50px 10px 50px; /* Adjust padding for smaller screens */
                font-size: 14px; /* Smaller font size */
            }

            .send-btn,
            .voice-btn,
            .stop-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            footer {
                padding: 10px;
                font-size: 12px; /* Smaller font for mobile */
            }
            .message {
                max-width: 85%;
            }

            .navbar-brand {
                font-size: 1.5rem;
            }

            .toggle-history {
                width: 36px;
                height: 36px;
            }

            .toggle-history i {
                font-size: 18px;
            }

            .theme-dropdown .btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .navbar-left {
                gap: 8px;
            }

            .navbar-center {
                gap: 8px;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <i class="fas fa-at loading-heartbeat" aria-hidden="true"></i>
    </div>

    <nav class="navbar navbar-dark">
        <div class="navbar-left">
            <button class="toggle-history" id="toggleHistory" aria-label="Toggle history panel">
                <i class="fas fa-clock"></i>
            </button>
            <div class="theme-dropdown">
                <button class="btn dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-adjust"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                    <li><a class="dropdown-item" href="#" data-theme="dark-theme">Dark</a></li>
                    <li><a class="dropdown-item" href="#" data-theme="light-theme">Light</a></li>
                    <li><a class="dropdown-item" href="#" data-theme="sepia-theme">Sepia</a></li>
                </ul>
            </div>
        </div>
        <div class="navbar-center">
            <a class="navbar-brand"><i class="fas fa-comments"></i> Chat@AI</a>
        </div>
        <div class="nav-right">
            <a href="index.html" class="home-button">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </nav>

    <div class="container">
        <aside class="history-panel" id="historyPanel">
            <button class="close-btn" id="closeHistoryBtn" aria-label="Close history panel">
                <i class="fas fa-times"></i>
            </button>
            <div class="search-bar">
                <input type="text" id="searchBar" placeholder="Search chat history..." aria-label="Search chat history">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <span class="clear-search" id="clearSearch"><i class="fas fa-times"></i></span>
            </div>
            <button class="clear-history-button" id="clearHistoryBtn">Clear All History</button>
            <button class="fancy-button" id="exportHistoryBtn">Export History</button>
            <button class="fancy-button" id="importHistoryBtn">Import History</button>
            <h3>Chat History</h3>
            <div id="chatHistory"></div>
        </aside>

        <div class="chat-container">
            <div id="controls" style="text-align: left; margin: 20px;">
                <button id="newChatBtn" class="fancy-button">New Chat</button>
            </div>
            <div class="chat-box" id="chatBox"></div>
            <div class="input-group">
                <textarea id="userInput" placeholder="Ask Anything..." rows="1" aria-label="Enter your message"></textarea>
                <button class="send-btn" id="sendBtn" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
                <button class="stop-btn" id="stopBtn" style="display: none;" aria-label="Stop generation"><i class="fas fa-stop"></i></button>
                <button class="voice-btn" id="voiceBtn" aria-label="Toggle voice input"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2025 AI Chatbot | <a href="#" class="footer-link">Privacy Policy</a> | <a href="#" class="footer-link">Terms of Service</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script>
        // UUID generator
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // Constants
        const baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        const apiKey = 'AIzaSyDirhQ899FnmcWCuwfHfzS05TEenhZntwA'; // Replace with your actual Gemini API key
        const maxContextMessages = 5;
        const typingSpeed = 20; // Milliseconds per character (faster)
        const elements = {
            chatBox: document.getElementById('chatBox'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            stopBtn: document.getElementById('stopBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            chatHistory: document.getElementById('chatHistory'),
            searchBar: document.getElementById('searchBar'),
            clearSearch: document.getElementById('clearSearch'),
            newChatBtn: document.getElementById('newChatBtn'),
            historyPanel: document.getElementById('historyPanel'),
            toggleHistory: document.getElementById('toggleHistory'),
            closeHistoryBtn: document.getElementById('closeHistoryBtn'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            exportHistoryBtn: document.getElementById('exportHistoryBtn'),
            importHistoryBtn: document.getElementById('importHistoryBtn'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };
        let recognizing = false;
        let abortController = null;
        let isTypingStopped = false;

        // Theme Management
        function setTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('theme', theme);
        }

        document.querySelectorAll('.theme-dropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault();
                setTheme(item.getAttribute('data-theme'));
            });
        });

        const savedTheme = localStorage.getItem('theme') || 'dark-theme';
        setTheme(savedTheme);

        // History Panel Toggle
        function toggleHistoryPanel() {
            elements.historyPanel.classList.toggle('active');
        }

        elements.toggleHistory.addEventListener('click', toggleHistoryPanel);
        elements.closeHistoryBtn.addEventListener('click', toggleHistoryPanel);

        // Chat History Management
        class ChatHistory {
            static load() {
                const compressed = localStorage.getItem('chatHistory');
                const history = compressed ? JSON.parse(LZString.decompress(compressed) || '[]') : [];
                elements.chatHistory.innerHTML = '';
                history.forEach(item => this.renderHistoryItem(item));
            }

            static save(history) {
                const compressed = LZString.compress(JSON.stringify(history));
                localStorage.setItem('chatHistory', compressed);
            }

            static add(question, response, sender) {
                const sessionId = generateUUID();
                const timestamp = new Date().toISOString();
                const keyword = this.summarizeResponse(response);
                const item = { sessionId, timestamp, question, response, sender, keyword };
                const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                history.push(item);
                this.save(history);
                this.renderHistoryItem(item);
            }

            static summarizeResponse(response) {
                return response.split(' ').slice(0, 5).join(' ') + '...';
            }

            static renderHistoryItem({ sessionId, timestamp, question, response, keyword }) {
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item');
                historyItem.tabIndex = 0;
                historyItem.setAttribute('aria-label', `Chat from ${question}`);

                const isImage = question.startsWith('/generate_image');
                const icon = document.createElement('i');
                icon.className = isImage ? 'fas fa-image icon' : 'fas fa-comment icon';

                const content = document.createElement('div');
                content.className = 'content';

                const date = new Date(timestamp);
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const formattedDate = date.toLocaleDateString();

                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.textContent = question;
                questionDiv.title = question;

                const metaDiv = document.createElement('div');
                metaDiv.className = 'meta';
                metaDiv.textContent = `${formattedDate} ${formattedTime} | ${keyword}`;
                metaDiv.title = `${formattedDate} ${formattedTime} | ${keyword}`;

                content.appendChild(questionDiv);
                content.appendChild(metaDiv);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.setAttribute('aria-label', 'Delete chat history item');
                deleteBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    elements.chatHistory.removeChild(historyItem);
                    const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                    const updatedHistory = history.filter(item => item.sessionId !== sessionId);
                    this.save(updatedHistory);
                });

                historyItem.appendChild(icon);
                historyItem.appendChild(content);
                historyItem.appendChild(deleteBtn);

                historyItem.addEventListener('click', () => {
                    appendMessage(`**Previous:** ${question}\n${response}`, 'bot', sessionId, timestamp);
                    toggleHistoryPanel();
                });

                elements.chatHistory.appendChild(historyItem);
            }

            static clear() {
                if (confirm('Are you sure you want to permanently delete all chat history? This action cannot be undone.')) {
                    elements.chatHistory.innerHTML = '';
                    localStorage.removeItem('chatHistory');
                    appendMessage('All chat history has been permanently deleted.', 'bot');
                }
            }

            static export() {
                const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'chat_history.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            static import() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const history = JSON.parse(event.target.result);
                            this.save(history);
                            this.load();
                            appendMessage('Chat history imported successfully.', 'bot');
                        } catch (error) {
                            appendMessage(`Error importing history: ${error.message}`, 'bot');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }

        // Response Formatting
        function formatResponse(response) {
            const html = marked.parse(response, {
                gfm: true,
                breaks: true,
                sanitize: false
            });
            return `<div class="markdown-container">${html}</div>`;
        }

        // Typing Effect with Stop Capability
        function typeMessage(element, html, callback) {
            element.innerHTML = '<div class="markdown-container"></div>';
            const container = element.querySelector('.markdown-container');
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const nodes = Array.from(doc.querySelector('.markdown-container').childNodes);

            let nodeIndex = 0;
            let charIndex = 0;
            let currentElement = null;

            function typeNext() {
                if (isTypingStopped) {
                    addCopyButtons(container);
                    callback();
                    return;
                }

                if (nodeIndex >= nodes.length) {
                    addCopyButtons(container);
                    callback();
                    return;
                }

                const node = nodes[nodeIndex];
                if (node.nodeType === Node.ELEMENT_NODE) {
                    if (!currentElement) {
                        currentElement = node.cloneNode(false);
                        container.appendChild(currentElement);
                    }

                    if (node.childNodes.length > 0) {
                        nodes.splice(nodeIndex, 1, ...node.childNodes);
                    } else {
                        nodeIndex++;
                        currentElement = null;
                    }
                } else if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    if (charIndex < text.length) {
                        if (!currentElement) {
                            currentElement = document.createTextNode('');
                            container.appendChild(currentElement);
                        }
                        currentElement.textContent = text.slice(0, charIndex + 1);
                        charIndex++;
                        elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
                    } else {
                        nodeIndex++;
                        charIndex = 0;
                        currentElement = null;
                    }
                } else {
                    nodeIndex++;
                }

                setTimeout(typeNext, typingSpeed);
            }

            typeNext();
        }

        // Add Copy Buttons to Code Blocks
        function addCopyButtons(container) {
            container.querySelectorAll('pre').forEach(pre => {
                let codeText = pre.textContent;
                if (pre.querySelector('code')) {
                    codeText = pre.querySelector('code').textContent;
                }

                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.innerHTML = '<i class="fas fa-copy"></i>';
                button.setAttribute('aria-label', 'Copy code');
                button.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeText).then(() => {
                        button.classList.add('copied');
                        setTimeout(() => button.classList.remove('copied'), 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                    });
                });

                pre.appendChild(button);
            });
        }

        function appendMessage(content, sender, sessionId = null, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);

            if (sender === 'bot') {
                const iconImg = document.createElement('img');
                iconImg.src = 'https://i.ibb.co/MCLkk0y/icon-png.webp';
                iconImg.alt = 'Chat @AI Bot';
                iconImg.style.width = '50px';
                iconImg.style.height = '40px';
                iconImg.style.marginRight = '10px';
                iconImg.style.borderRadius = '50%';
                iconImg.style.objectFit = 'cover';

                const messageContainer = document.createElement('div');
                messageContainer.style.display = 'flex';
                messageContainer.style.alignItems = 'flex-start';

                const messageContent = document.createElement('div');
                messageContent.style.minWidth = '100px';

                messageContainer.appendChild(iconImg);
                messageContainer.appendChild(messageContent);
                messageDiv.appendChild(messageContainer);

                if (sessionId && timestamp) {
                    // Skip typing for history recall
                    messageContent.innerHTML = formatResponse(content);
                    addCopyButtons(messageContent);
                    elements.chatBox.appendChild(messageDiv);
                    elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
                } else {
                    typeMessage(messageContent, formatResponse(content), () => {
                        elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
                        resetButtons();
                    });
                }
            } else {
                messageDiv.innerHTML = content;
                elements.chatBox.appendChild(messageDiv);
                elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
            }

            elements.chatBox.appendChild(messageDiv);

            if (!sessionId && !timestamp) {
                ChatHistory.add(content, content, sender);
            }
        }

        // Chat Functions
        function resetChat() {
            elements.chatBox.innerHTML = '';
            elements.userInput.value = '';
            appendMessage('Welcome to Chat @AI! How can I assist you today?', 'bot');
        }

        function sendMessage() {
            const question = elements.userInput.value.trim();
            if (!question) return;

            appendMessage(question, 'user');
            elements.userInput.value = '';
            elements.userInput.style.height = 'auto';
            elements.userInput.focus();

            const loader = document.createElement('div');
            loader.classList.add('loader');
            for (let i = 0; i < 3; i++) {
                loader.appendChild(document.createElement('div'));
            }
            elements.chatBox.appendChild(loader);

            // Disable send button and show stop button
            elements.sendBtn.disabled = true;
            elements.sendBtn.style.opacity = '0.5';
            elements.stopBtn.style.display = 'flex';

            abortController = new AbortController();
            isTypingStopped = false;

            if (question.startsWith('/generate_image ')) {
                const prompt = question.substring('/generate_image '.length).trim();
                generateImage(prompt, loader);
            } else {
                const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                const contextMessages = history.slice(-maxContextMessages).map(item => [
                    { role: 'user', parts: [{ text: item.question }] },
                    { role: 'model', parts: [{ text: item.response }] }
                ]).flat();

                contextMessages.push({ role: 'user', parts: [{ text: question }] });

                fetch(`${baseUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contextMessages,
                        generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
                    }),
                    signal: abortController.signal
                })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        elements.chatBox.removeChild(loader);
                        if (data?.candidates?.length) {
                            const botResponse = data.candidates[0].content.parts[0].text;
                            appendMessage(botResponse, 'bot');
                        } else {
                            appendMessage('No response from the API. Please try again later.', 'bot');
                            resetButtons();
                        }
                    })
                    .catch(error => {
                        elements.chatBox.removeChild(loader);
                        if (error.name === 'AbortError') {
                            appendMessage('Response generation stopped.', 'bot');
                        } else {
                            appendMessage(`Error: ${error.message}. Please check your connection or try again.`, 'bot');
                        }
                        resetButtons();
                    });
            }
        }

        function generateImage(prompt, loader) {
            const imageUrl = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=' + apiKey;
            fetch(imageUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: { text: prompt },
                    generationConfig: { sampleCount: 1 }
                }),
                signal: abortController.signal
            })
                .then(response => response.json())
                .then(data => {
                    elements.chatBox.removeChild(loader);
                    if (data?.predictions?.length) {
                        const imageData = data.predictions[0].image;
                        const imgHtml = `![Generated image](${imageData})`;
                        appendMessage(imgHtml, 'bot');
                    } else {
                        appendMessage('No image generated. Try a different prompt.', 'bot');
                        resetButtons();
                    }
                })
                .catch(error => {
                    elements.chatBox.removeChild(loader);
                    if (error.name === 'AbortError') {
                        appendMessage('Image generation stopped.', 'bot');
                    } else {
                        appendMessage(`Error generating image: ${error.message}. Please try again.`, 'bot');
                    }
                    resetButtons();
                });
        }

        function resetButtons() {
            elements.sendBtn.disabled = false;
            elements.sendBtn.style.opacity = '1';
            elements.stopBtn.style.display = 'none';
            abortController = null;
            isTypingStopped = false;
        }

        // Event Listeners
        elements.newChatBtn.addEventListener('click', resetChat);
        elements.clearHistoryBtn.addEventListener('click', () => ChatHistory.clear());
        elements.exportHistoryBtn.addEventListener('click', () => ChatHistory.export());
        elements.importHistoryBtn.addEventListener('click', () => ChatHistory.import());

        elements.stopBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
                isTypingStopped = true;
            }
        });

        elements.userInput.addEventListener('input', () => {
            elements.userInput.style.height = 'auto';
            elements.userInput.style.height = `${elements.userInput.scrollHeight}px`;
        });

        elements.userInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!elements.sendBtn.disabled) {
                    sendMessage();
                }
            }
        });

        elements.sendBtn.addEventListener('click', () => {
            if (!elements.sendBtn.disabled) {
                sendMessage();
            }
        });

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            recognizing = true;
            elements.voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>'; // Keep microphone icon
        };

        recognition.onresult = event => {
            elements.userInput.value = event.results[0][0].transcript;
            sendMessage();
        };

        recognition.onend = () => {
            recognizing = false;
            elements.voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>'; // Show slash after completion
        };

        recognition.onerror = event => {
            appendMessage(`Speech recognition error: ${event.error}. Please try again.`, 'bot');
            recognizing = false;
            elements.voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
        };

        elements.voiceBtn.addEventListener('click', () => {
            if (!recognizing) {
                recognition.start();
            } else {
                recognition.stop();
            }
        });

        // Debounced search
        let searchTimeout;
        elements.searchBar.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchText = elements.searchBar.value.toLowerCase();
                const items = document.querySelectorAll('.history-item');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchText) ? '' : 'none';
                });
                elements.clearSearch.style.display = searchText ? 'block' : 'none';
                elements.searchBar.parentElement.classList.toggle('active', searchText.length > 0);
            }, 300);
        });

        elements.clearSearch.addEventListener('click', () => {
            elements.searchBar.value = '';
            document.querySelectorAll('.history-item').forEach(item => item.style.display = '');
            elements.clearSearch.style.display = 'none';
            elements.searchBar.parentElement.classList.remove('active');
            elements.searchBar.focus();
        });

        // Initialize with loading effect
        document.addEventListener('DOMContentLoaded', () => {
            // Simulate loading delay
            setTimeout(() => {
                elements.loadingOverlay.classList.add('hidden');
                ChatHistory.load();
                resetChat();
            }, 2000);
        });
    </script>
</body>
</html>
