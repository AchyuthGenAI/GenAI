<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat-AI</title>
    <link rel="icon" type="image/webp" href="https://i.ibb.co/MCLkk0y/icon-png.webp">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            font-family: Arial, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #1e2a44;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-heartbeat {
            font-size: 100px;
            color: #00c6ff;
            animation: heartbeat 1.2s infinite ease-in-out;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            20% { transform: scale(1.2); }
            40% { transform: scale(1); }
            60% { transform: scale(1.2); }
            80% { transform: scale(1); }
        }

        /* Light Theme (Default) */
        body[data-theme="light"] {
            background-color: #f5f5f5;
            color: #333333;
        }

        body[data-theme="light"] .navbar {
            background-color: #ffffff;
            color: #333333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="light"] .navbar-brand {
            color: transparent;
        }

        body[data-theme="light"] .home-button {
            color: #ffffff;
        }

        body[data-theme="light"] .history-panel {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333333;
        }

        body[data-theme="light"] .history-panel h3 {
            color: #007bff;
        }

        body[data-theme="light"] .chat-container,
        body[data-theme="light"] .chat-box,
        body[data-theme="light"] .chat-box::-webkit-scrollbar-track {
            background-color: #f5f5f5;
            color: #333333;
        }

        body[data-theme="light"] .input-group,
        body[data-theme="light"] .send-btn,
        body[data-theme="light"] .voice-btn,
        body[data-theme="light"] .stop-btn {
            background-color: #e0e0e0;
            color: #333333;
        }

        body[data-theme="light"] .stop-btn {
            background-color: #dc3545;
            color: #ffffff;
        }

        body[data-theme="light"] .newChatBtn {
            color: #ffffff;
        }

        body[data-theme="light"] .history-item {
            background-color: #ffffff;
            border: 1px solid #cccccc;
            color: #333333;
        }

        body[data-theme="light"] .history-item:hover {
            background-color: #e8ecef;
        }

        body[data-theme="light"] .history-item .content .question {
            color: #333333;
        }

        body[data-theme="light"] .history-item .content .meta {
            color: #555555; /* Improved contrast */
        }

        body[data-theme="light"] .history-item .delete-btn {
            color: #dc3545;
        }

        body[data-theme="light"] .message.user {
            background-color: #e9ecef;
            color: #ffffff;
            margin-left: auto;
        }

        body[data-theme="light"] .message.bot {
            background-color: #e9ecef;
            color: #333333;
            margin-right: auto;
        }

        body[data-theme="light"] .markdown-container {
            color: #333333;
        }

        body[data-theme="light"] .markdown-container pre {
            background: #1e1e1e;
            color: 
            #ffffff;
        }

        body[data-theme="light"] .markdown-container code {
            color: #000000;
        }

        body[data-theme="light"] footer {
            color: #555555; /* Improved contrast */
        }

        body[data-theme="light"] footer a {
            color: #007bff;
        }

        body[data-theme="light"] .search-bar {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
        }

        body[data-theme="light"] .search-bar input {
            color: #333333;
        }

        body[data-theme="light"] .search-bar input::placeholder {
            color: #888888;
        }

        body[data-theme="light"] .search-bar .search-icon {
            color: #007bff;
        }

        body[data-theme="light"] .search-bar .clear-search {
            color: #666666;
        }

        body[data-theme="light"] .search-bar .clear-search:hover {
            color: #dc3545;
        }

        body[data-theme="light"] .clear-history-button,
        body[data-theme="light"] .fancy-button {
            color: #ffffff;
        }

        body[data-theme="light"] .theme-dropdown .dropdown-menu {
            background-color: #ffffff;
            border: 1px solid #cccccc;
            color: #333333;
        }

        body[data-theme="light"] .theme-dropdown .dropdown-item {
            color: #333333;
        }

        body[data-theme="light"] .theme-dropdown .dropdown-item:hover {
            background-color: #e8ecef;
            color: #333333;
        }

        /* Dark Theme */
        body[data-theme="dark"] {
            background-color: #1e2a44;
            color: #ffffff;
        }

        body[data-theme="dark"] .navbar {
            background-color: #1e2a44;
            color: #ffffff;
        }

        body[data-theme="dark"] .navbar-brand {
            color: transparent;
        }

        body[data-theme="dark"] .home-button {
            color: #ffffff;
        }

        body[data-theme="dark"] .history-panel {
            background-color: rgba(0, 0, 0, 0.95);
            color: #ffffff;
        }

        body[data-theme="dark"] .history-panel h3 {
            color: #00c6ff;
        }

        body[data-theme="dark"] .chat-container,
        body[data-theme="dark"] .chat-box,
        body[data-theme="dark"] .chat-box::-webkit-scrollbar-track {
            background-color: #1e2a44;
            color: #ffffff;
        }

        body[data-theme="dark"] .input-group,
        body[data-theme="dark"] .send-btn,
        body[data-theme="dark"] .voice-btn,
        body[data-theme="dark"] .stop-btn {
            background-color: #3a3f4b;
            color: #ffffff;
        }

        body[data-theme="dark"] .stop-btn {
            background-color: #ff6f61;
            color: #ffffff;
        }

        body[data-theme="dark"] .newChatBtn {
            color: #ffffff;
        }

        body[data-theme="dark"] .history-item {
            background-color: #1e2a44;
            border: 1px solid #3a3f4b;
            color: #ffffff;
        }

        body[data-theme="dark"] .history-item:hover {
            background-color: #2e333f;
        }

        body[data-theme="dark"] .history-item .content .question {
            color: #ffffff;
        }

        body[data-theme="dark"] .history-item .content .meta {
            color: #aaaaaa;
        }

        body[data-theme="dark"] .history-item .delete-btn {
            color: #ff6f61;
        }

        body[data-theme="dark"] .message.user {
            background-color: #3a3f4b;
            color: #ffffff;
            margin-left: auto;
        }

        body[data-theme="dark"] .message.bot {
            background-color: #3a3f4b;
            color: #ffffff;
            margin-right: auto;
        }

        body[data-theme="dark"] .markdown-container {
            color: #ffffff;
        }

        body[data-theme="dark"] .markdown-container pre {
            background: #1e1e1e;
            color: #ffffff;
        }

        body[data-theme="dark"] .markdown-container code {
            color: #ffffff;
        }

        body[data-theme="dark"] footer {
            color: #dddddd;
        }

        body[data-theme="dark"] footer a {
            color: #00adb5;
        }

        body[data-theme="dark"] .search-bar {
            background: linear-gradient(135deg, #2e333f, #1e2a44);
        }

        body[data-theme="dark"] .search-bar input {
            color: #ffffff;
        }

        body[data-theme="dark"] .search-bar input::placeholder {
            color: #bbbbbb;
        }

        body[data-theme="dark"] .search-bar .search-icon {
            color: #00c6ff;
        }

        body[data-theme="dark"] .search-bar .clear-search {
            color: #aaaaaa;
        }

        body[data-theme="dark"] .search-bar .clear-search:hover {
            color: #ff6f61;
        }

        body[data-theme="dark"] .clear-history-button,
        body[data-theme="dark"] .fancy-button {
            color: #ffffff;
        }

        body[data-theme="dark"] .theme-dropdown .dropdown-menu {
            background-color: #2e333f;
            border: 1px solid #3a3f4b;
            color: #ffffff;
        }

        body[data-theme="dark"] .theme-dropdown .dropdown-item {
            color: #ffffff;
        }

        body[data-theme="dark"] .theme-dropdown .dropdown-item:hover {
            background-color: #3a3f4b;
            color: #ffffff;
        }



        /* Ocean Theme */
        body[data-theme="ocean"] {
            background-color: #e0f7fa;
            color: #003087;
        }

        body[data-theme="ocean"] .navbar {
            background-color: #b3e5fc;
            color: #003087;
        }

        body[data-theme="ocean"] .navbar-brand {
            color: transparent;
        }

        body[data-theme="ocean"] .home-button {
            color: #ffffff;
        }

        body[data-theme="ocean"] .history-panel {
            background-color: rgba(179, 229, 252, 0.95);
            color: #003087;
        }

        body[data-theme="ocean"] .history-panel h3 {
            color: #0288d1;
        }

        body[data-theme="ocean"] .chat-container,
        body[data-theme="ocean"] .chat-box,
        body[data-theme="ocean"] .chat-box::-webkit-scrollbar-track {
            background-color: #e0f7fa;
            color: #003087;
        }

        body[data-theme="ocean"] .input-group,
        body[data-theme="ocean"] .send-btn,
        body[data-theme="ocean"] .voice-btn,
        body[data-theme="ocean"] .stop-btn {
            background-color: #81d4fa;
            color: #003087;
        }

        body[data-theme="ocean"] .stop-btn {
            background-color: #d81b60;
            color: #ffffff;
        }

        body[data-theme="ocean"] .newChatBtn {
            color: #ffffff;
        }

        body[data-theme="ocean"] .history-item {
            background-color: #b3e5fc;
            border: 1px solid #4fc3f7;
            color: #003087;
        }

        body[data-theme="ocean"] .history-item:hover {
            background-color: #4fc3f7;
        }

        body[data-theme="ocean"] .history-item .content .question {
            color: #003087;
        }

        body[data-theme="ocean"] .history-item .content .meta {
            color: #0288d1;
        }

        body[data-theme="ocean"] .history-item .delete-btn {
            color: #d81b60;
        }

        body[data-theme="ocean"] .message.user {
            background-color: #b3e5fc;
            color: #ffffff;
            margin-left: auto;
        }

        body[data-theme="ocean"] .message.bot {
            background-color: #b3e5fc;
            color: #003087;
            margin-right: auto;
        }

        body[data-theme="ocean"] .markdown-container {
            color: #003087;
        }

        body[data-theme="ocean"] .markdown-container pre {
            background: #1e1e1e;
            color: #003087;
        }

        body[data-theme="ocean"] .markdown-container code {
            color: #003087;
        }

        body[data-theme="ocean"] footer {
            color: #003087;
        }

        body[data-theme="ocean"] footer a {
            color: #0288d1;
        }

        body[data-theme="ocean"] .search-bar {
            background: linear-gradient(135deg, #b3e5fc, #81d4fa);
        }

        body[data-theme="ocean"] .search-bar input {
            color: #003087;
        }

        body[data-theme="ocean"] .search-bar input::placeholder {
            color: #0288d1;
        }

        body[data-theme="ocean"] .search-bar .search-icon {
            color: #0288d1;
        }

        body[data-theme="ocean"] .search-bar .clear-search {
            color: #0288d1;
        }

        body[data-theme="ocean"] .search-bar .clear-search:hover {
            color: #d81b60;
        }

        body[data-theme="ocean"] .clear-history-button,
        body[data-theme="ocean"] .fancy-button {
            color: #ffffff;
        }

        body[data-theme="ocean"] .theme-dropdown .dropdown-menu {
            background-color: #b3e5fc;
            border: 1px solid #4fc3f7;
            color: #003087;
        }

        body[data-theme="ocean"] .theme-dropdown .dropdown-item {
            color: #003087;
        }

        body[data-theme="ocean"] .theme-dropdown .dropdown-item:hover {
            background-color: #4fc3f7;
            color: #003087;
        }

        /* Forest Theme */
        body[data-theme="forest"] {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        body[data-theme="forest"] .navbar {
            background-color: #c8e6c9;
            color: #1b5e20;
        }

        body[data-theme="forest"] .navbar-brand {
            color: transparent;
        }

        body[data-theme="forest"] .home-button {
            color: #ffffff;
        }

        body[data-theme="forest"] .history-panel {
            background-color: rgba(200, 230, 201, 0.95);
            color: #1b5e20;
        }

        body[data-theme="forest"] .history-panel h3 {
            color: #388e3c;
        }

        body[data-theme="forest"] .chat-container,
        body[data-theme="forest"] .chat-box,
        body[data-theme="forest"] .chat-box::-webkit-scrollbar-track {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        body[data-theme="forest"] .input-group,
        body[data-theme="forest"] .send-btn,
        body[data-theme="forest"] .voice-btn,
        body[data-theme="forest"] .stop-btn {
            background-color: #a5d6a7;
            color: #1b5e20;
        }

        body[data-theme="forest"] .stop-btn {
            background-color: #d32f2f;
            color: #ffffff;
        }

        body[data-theme="forest"] .newChatBtn {
            color: #ffffff;
        }

        body[data-theme="forest"] .history-item {
            background-color: #c8e6c9;
            border: 1px solid #81c784;
            color: #1b5e20;
        }

        body[data-theme="forest"] .history-item:hover {
            background-color: #81c784;
        }

        body[data-theme="forest"] .history-item .content .question {
            color: #1b5e20;
        }

        body[data-theme="forest"] .history-item .content .meta {
            color: #388e3c;
        }

        body[data-theme="forest"] .history-item .delete-btn {
            color: #d32f2f;
        }

        body[data-theme="forest"] .message.user {
            background-color: #388e3c;
            color: #ffffff;
            margin-left: auto;
        }

        body[data-theme="forest"] .message.bot {
            background-color: #c8e6c9;
            color: #1b5e20;
            margin-right: auto;
        }

        body[data-theme="forest"] .markdown-container {
            color: #1b5e20;
        }

        body[data-theme="forest"] .markdown-container pre {
            background: #1e1e1e;
            color: #1b5e20;
        }

        body[data-theme="forest"] .markdown-container code {
            color: #1b5e20;
        }

        body[data-theme="forest"] footer {
            color: #1b5e20;
        }

        body[data-theme="forest"] footer a {
            color: #388e3c;
        }

        body[data-theme="forest"] .search-bar {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        }

        body[data-theme="forest"] .search-bar input {
            color: #1b5e20;
        }

        body[data-theme="forest"] .search-bar input::placeholder {
            color: #388e3c;
        }

        body[data-theme="forest"] .search-bar .search-icon {
            color: #388e3c;
        }

        body[data-theme="forest"] .search-bar .clear-search {
            color: #388e3c;
        }

        body[data-theme="forest"] .search-bar .clear-search:hover {
            color: #d32f2f;
        }

        body[data-theme="forest"] .clear-history-button,
        body[data-theme="forest"] .fancy-button {
            color: #ffffff;
        }

        body[data-theme="forest"] .theme-dropdown .dropdown-menu {
            background-color: #c8e6c9;
            border: 1px solid #81c784;
            color: #1b5e20;
        }

        body[data-theme="forest"] .theme-dropdown .dropdown-item {
            color: #1b5e20;
        }

        body[data-theme="forest"] .theme-dropdown .dropdown-item:hover {
            background-color: #81c784;
            color: #1b5e20;
        }

        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            position: relative;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-center {
            display: flex;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .navbar-brand {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00c6ff, #0072ff, #ff00ff, #ff6f61);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        .history-panel {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 90%;
            max-width: 400px;
            height: calc(100vh - 100px);
            padding: 20px;
            z-index: 1000;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }

        .history-panel.active {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }

        .history-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .history-panel .close-btn:hover {
            color: #ff3f31;
        }

        .history-panel::-webkit-scrollbar {
            width: 8px;
        }

        .history-panel::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 50px;
        }

        .history-panel::-webkit-scrollbar-track {
            border-radius: 50px;
        }

        body[data-theme="light"] .history-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.7);
        }

        body[data-theme="dark"] .history-panel::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.7);
        }

        body[data-theme="high-contrast"] .history-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.7);
        }

        body[data-theme="ocean"] .history-panel::-webkit-scrollbar-track {
            background: rgba(179, 229, 252, 0.7);
        }

        body[data-theme="forest"] .history-panel::-webkit-scrollbar-track {
            background: rgba(200, 230, 201, 0.7);
        }

        .history-panel h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .toggle-history {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .toggle-history:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .toggle-history i {
            font-size: 20px;
        }

        .theme-dropdown {
            display: flex;
            align-items: center;
        }

        .theme-dropdown .btn {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .theme-dropdown .btn:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .theme-dropdown .btn:active {
            transform: scale(0.95);
        }

        .theme-dropdown .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-width: 120px;
        }

        .theme-dropdown .dropdown-item {
            padding: 8px 16px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .theme-dropdown .dropdown-item:hover {
            cursor: pointer;
        }

        .search-bar {
            position: relative;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            border-radius: 25px;
            padding: 5px 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .search-bar:hover,
        .search-bar.active {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 198, 255, 0.2);
        }

        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: none;
            border-radius: 25px;
            background: transparent;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            box-shadow: inset 0 0 5px rgba(0, 198, 255, 0.5);
        }

        .search-bar input:focus::placeholder {
            opacity: 0;
            transform: translateX(-15px);
        }

        .search-bar .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .search-bar input:focus+.search-icon {
            transform: translateY(-50%) scale(1.1);
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .history-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .history-item .icon {
            margin-right: 10px;
            font-size: 18px;
            color: #00c6ff;
        }

        .history-item .content {
            flex-grow: 1;
            overflow: hidden;
        }

        .history-item .content .question {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .history-item .content .meta {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .history-item .delete-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .history-item .delete-btn:hover {
            color: #ff3f31;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px - 60px);
            overflow: hidden;
            flex-direction: column;
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .chat-box {
            border-radius: 12px;
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 70px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            box-sizing: border-box;
        }

        .chat-box::-webkit-scrollbar {
            width: 8px;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 12px;
        }

        .message {
            margin: 10px 15px;
            padding: 10px 15px;
            border-radius: 10px;
            width: fit-content;
            max-width: 70%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .markdown-container {
            line-height: 1.6;
            font-size: 16px;
        }

        .markdown-container pre {
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .markdown-container code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            font-weight: normal;
            background: none;
        }

        .markdown-container ul, .markdown-container ol {
            padding-left: 20px;
        }

        .markdown-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .markdown-container th, .markdown-container td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #00c6ff;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: #0072ff;
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .copy-btn.copied::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
        }

        .input-group {
            display: flex;
            position: sticky;
            bottom: 0;
            border-radius: 50px;
            padding: 10px 20px;
            align-items: center;
            z-index: 100;
            background-color: inherit;
            margin-bottom: 10px;
        }

        .input-group textarea {
            padding: 15px 60px 15px 60px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            resize: none;
            overflow-y: hidden;
            min-height: 50px;
            max-height: 150px;
            width: 100%;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
            scrollbar-width: thin;
            scrollbar-color: #00c6ff #333;
        }

        body[data-theme="light"] .input-group textarea {
            background-color: #e0e0e0;
            color: #333333;
        }

        body[data-theme="dark"] .input-group textarea {
            background-color: #3a3f4b;
            color: #ffffff;
        }

        body[data-theme="high-contrast"] .input-group textarea {
            background-color: #333333;
            color: #ffffff;
        }

        body[data-theme="ocean"] .input-group textarea {
            background-color: #81d4fa;
            color: #003087;
        }

        body[data-theme="forest"] .input-group textarea {
            background-color: #a5d6a7;
            color: #1b5e20;
        }

        .input-group textarea::-webkit-scrollbar {
            width: 8px;
        }

        .input-group textarea::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }

        .input-group textarea::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .input-group textarea::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #00a6dd, #005fcc);
        }

        .input-group textarea:focus {
            box-shadow: 0 0 5px rgba(0, 198, 255, 0.5);
        }

        .send-btn {
            position: absolute;
            right: 40px;
            bottom: 50%;
            transform: translateY(50%);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .stop-btn {
            position: absolute;
            right: 40px;
            bottom: 50%;
            transform: translateY(50%);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
        }

        .voice-btn {
            position: absolute;
            left: 30px;
            bottom: 50%;
            transform: translateY(50%);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            border-radius:50%;
            font-size: 18px;
            cursor: pointer;
        }

        .send-btn:hover,
        .voice-btn:hover,
        .stop-btn:hover {
            filter: brightness(1.2);
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        .loader div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            border-radius: 50%;
            background-color: #3498db;
            animation: wave 1.5s infinite ease-in-out;
        }

        .loader div:nth-child(1) {
            animation-delay: -0.3s;
        }

        .loader div:nth-child(2) {
            animation-delay: -0.15s;
        }

        .loader div:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes wave {
            50%, 100% { transform: scale(0); }
            50% { transform: scale(1); }
        }

        footer {
            text-align: center;
            padding: 15px;
            background-color: transparent;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 14px;
            z-index: 50;
        }

        footer a {
            text-decoration: none;
            transition: all 0.3s ease;
        }

        footer a:hover {
            text-decoration: underline;
        }

        body[data-theme="light"] footer a:hover {
            color: #0056b3;
        }

        body[data-theme="dark"] footer a:hover {
            color: #00bcd4;
        }

        body[data-theme="high-contrast"] footer a:hover {
            color: #00cc00;
        }

        body[data-theme="ocean"] footer a:hover {
            color: #01579b;
        }

        body[data-theme="forest"] footer a:hover {
            color: #2e7d32;
        }

        .fancy-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fancy-button:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .fancy-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .clear-history-button {
            background: linear-gradient(135deg, #ff3f31, #ff6f61);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .clear-history-button:hover {
            background: linear-gradient(135deg, #ff6f61, #ff3f31);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .clear-history-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .nav-right {
            display: flex;
            align-items: center;
        }

        .home-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            padding: 8px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .home-button:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
            color: #ffffff;
        }

        .home-button:active {
            transform: scale(0.95);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .history-item:focus {
            outline: 2px solid #00c6ff;
            outline-offset: 2px;
        }

        @media (max-width: 768px) {
            .container {
                height: calc(100vh - 60px - 60px);
            }
            .chat-box {
                padding: 10px;
                margin-bottom: 80px;
            }
            .input-group {
                padding: 8px 15px;
                margin-bottom: 15px;
            }
            .input-group textarea {
                padding: 10px 50px 10px 50px;
                font-size: 14px;
            }

            .send-btn,
            .voice-btn,
            .stop-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            footer {
                padding: 10px;
                font-size: 12px;
            }
            .message {
                max-width: 85%;
            }

            .navbar-brand {
                font-size: 1.5rem;
            }

            .toggle-history {
                width: 36px;
                height: 36px;
            }

            .toggle-history i {
                font-size: 18px;
            }

            .theme-dropdown .btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .navbar-left {
                gap: 8px;
            }

            .navbar-center {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <i class="fas fa-at loading-heartbeat" aria-hidden="true"></i>
    </div>

    <nav class="navbar navbar-dark">
        <div class="navbar-left">
            <button class="toggle-history" id="toggleHistory" aria-label="Toggle history panel">
                <i class="fas fa-clock"></i>
            </button>
            <div class="theme-dropdown">
                <button class="btn dropdown-toggle theme-toggle-btn" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-adjust"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                    <li><a class="dropdown-item" href="#" data-theme="light">Light</a></li>
                    <li><a class="dropdown-item" href="#" data-theme="dark">Dark</a></li>
                    
                    <li><a class="dropdown-item" href="#" data-theme="ocean">Ocean</a></li>
                    <li><a class="dropdown-item" href="#" data-theme="forest">Forest</a></li>
                </ul>
            </div>
        </div>
        <div class="navbar-center">
            <a class="navbar-brand"><i class="fas fa-comments"></i> Chat@AI</a>
        </div>
        <div class="nav-right">
            <a href="index.html" class="home-button">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </nav>

    <div class="container">
        <aside class="history-panel" id="historyPanel">
            <button class="close-btn" id="closeHistoryBtn" aria-label="Close history panel">
                <i class="fas fa-times"></i>
            </button>
            <div class="search-bar">
                <input type="text" id="searchBar" placeholder="Search or enter code..." aria-label="Search chat history or enter code">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <span class="clear-search" id="clearSearch"><i class="fas fa-times"></i></span>
            </div>
            <button class="clear-history-button" id="clearHistoryBtn">Clear All History</button>
            <button class="fancy-button" id="exportHistoryBtn">Export History</button>
            <button class="fancy-button" id="importHistoryBtn">Import History</button>
            <h3>Chat History</h3>
            <div id="chatHistory"></div>
        </aside>

        <div class="chat-container">
            <div id="controls" style="text-align: left; margin: 20px;">
                <button id="newChatBtn" class="fancy-button newChatBtn">New Chat</button>
            </div>
            <div class="chat-box" id="chatBox"></div>
            <div class="input-group">
                <textarea id="userInput" placeholder="Ask Anything or Enter Code..." rows="1" aria-label="Enter your message or code"></textarea>
                <button class="send-btn" id="sendBtn" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
                <button class="stop-btn" id="stopBtn" style="display: none;" aria-label="Stop generation"><i class="fas fa-stop"></i></button>
                <button class="voice-btn" id="voiceBtn" aria-label="Toggle voice input"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 AI Chatbot | <a href="#" class="footer-link">Privacy Policy</a> | <a href="#" class="footer-link">Terms of Service</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script>
        // UUID generator
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // Constants
        const baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const apiKey = 'AIzaSyDirhQ899FnmcWCuwfHfzS05TEenhZntwA'; // Replace with your actual Gemini API key
        const maxContextMessages = 5;
        const typingSpeed = 20; // Milliseconds per character
        const elements = {
            chatBox: document.getElementById('chatBox'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            stopBtn: document.getElementById('stopBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            chatHistory: document.getElementById('chatHistory'),
            searchBar: document.getElementById('searchBar'),
            clearSearch: document.getElementById('clearSearch'),
            newChatBtn: document.getElementById('newChatBtn'),
            historyPanel: document.getElementById('historyPanel'),
            toggleHistory: document.getElementById('toggleHistory'),
            closeHistoryBtn: document.getElementById('closeHistoryBtn'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            exportHistoryBtn: document.getElementById('exportHistoryBtn'),
            importHistoryBtn: document.getElementById('importHistoryBtn'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };
        let recognizing = false;
        let abortController = null;
        let isTypingStopped = false;

        // Theme Management
        function setTheme(theme) {
            const validThemes = ['light', 'dark', 'high-contrast', 'ocean', 'forest'];
            if (!validThemes.includes(theme)) {
                theme = 'light';
                localStorage.setItem('theme', 'light');
            }

            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            const themeBtn = document.querySelector('.theme-toggle-btn');
            themeBtn.textContent = theme === 'light' ? 'â˜€ï¸' :
                                  theme === 'dark' ? 'ðŸŒ™' :
                                  theme === 'high-contrast' ? 'âšª' :
                                  theme === 'ocean' ? 'ðŸŒŠ' : 'ðŸŒ²';

            updateTextColor(); // Update text color when theme changes
        }

        // Function to update text color based on the current theme
        function updateTextColor() {
            const currentTheme = document.body.getAttribute('data-theme');
            let textColor;

            switch (currentTheme) {
                case 'light':
                    textColor = '#333333';
                    break;
                case 'dark':
                    textColor = '#ffffff';
                    break;
                case 'high-contrast':
                    textColor = '#ffffff';
                    break;
                case 'ocean':
                    textColor = '#003087';
                    break;
                case 'forest':
                    textColor = '#1b5e20';
                    break;
                default:
                    textColor = '#333333';
            }

            document.body.style.color = textColor;
            document.querySelectorAll('.message.user').forEach(element => {
                element.style.color = currentTheme === 'dark' || currentTheme === 'high-contrast' ? '#000000' : '#ffffff';
            });
            document.querySelectorAll('.message.bot').forEach(element => {
                element.style.color = textColor;
            });
            document.querySelectorAll('.markdown-container').forEach(element => {
                element.style.color = textColor;
            });
            document.querySelectorAll('.markdown-container code').forEach(element => {
                element.style.color = textColor;
            });
        }

        document.querySelectorAll('.theme-dropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault();
                setTheme(item.getAttribute('data-theme'));
            });
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // History Panel Toggle
        function toggleHistoryPanel() {
            elements.historyPanel.classList.toggle('active');
        }

        elements.toggleHistory.addEventListener('click', toggleHistoryPanel);
        elements.closeHistoryBtn.addEventListener('click', toggleHistoryPanel);

        // Chat History Management
        class ChatHistory {
            static load() {
                const compressed = localStorage.getItem('chatHistory');
                const history = compressed ? JSON.parse(LZString.decompress(compressed) || '[]') : [];
                elements.chatHistory.innerHTML = '';
                history.forEach(item => this.renderHistoryItem(item));
            }

            static save(history) {
                const compressed = LZString.compress(JSON.stringify(history));
                localStorage.setItem('chatHistory', compressed);
            }

            static add(question, response, sender) {
                const sessionId = generateUUID();
                const timestamp = new Date().toISOString();
                const keyword = this.summarizeResponse(response);
                const item = { sessionId, timestamp, question, response, sender, keyword };
                const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                history.push(item);
                this.save(history);
                this.renderHistoryItem(item);
            }

            static summarizeResponse(response) {
                return response.split(' ').slice(0, 5).join(' ') + '...';
            }

            static renderHistoryItem({ sessionId, timestamp, question, response, keyword }) {
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item');
                historyItem.tabIndex = 0;
                historyItem.setAttribute('aria-label', `Chat from ${question}`);

                const isImage = question.startsWith('/generate_image');
                const isCode = question.startsWith('```javascript');
                const icon = document.createElement('i');
                icon.className = isImage ? 'fas fa-image icon' : isCode ? 'fas fa-code icon' : 'fas fa-comment icon';

                const content = document.createElement('div');
                content.className = 'content';

                const date = new Date(timestamp);
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const formattedDate = date.toLocaleDateString();

                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.textContent = question;
                questionDiv.title = question;

                const metaDiv = document.createElement('div');
                metaDiv.className = 'meta';
                metaDiv.textContent = `${formattedDate} ${formattedTime} | ${keyword}`;
                metaDiv.title = `${formattedDate} ${formattedTime} | ${keyword}`;

                content.appendChild(questionDiv);
                content.appendChild(metaDiv);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.setAttribute('aria-label', 'Delete chat history item');
                deleteBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    elements.chatHistory.removeChild(historyItem);
                    const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                    const updatedHistory = history.filter(item => item.sessionId !== sessionId);
                    this.save(updatedHistory);
                });

                historyItem.appendChild(icon);
                historyItem.appendChild(content);
                historyItem.appendChild(deleteBtn);

                historyItem.addEventListener('click', () => {
                    appendMessage(`**Previous:** ${question}\n${response}`, 'bot', sessionId, timestamp);
                    toggleHistoryPanel();
                });

                elements.chatHistory.appendChild(historyItem);
            }

            static clear() {
                if (confirm('Are you sure you want to permanently delete all chat history? This action cannot be undone.')) {
                    elements.chatHistory.innerHTML = '';
                    localStorage.removeItem('chatHistory');
                    appendMessage('All chat history has been permanently deleted.', 'bot');
                }
            }

            static export() {
                const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
                const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'chat_history.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            static import() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const history = JSON.parse(event.target.result);
                            this.save(history);
                            this.load();
                            appendMessage('Chat history imported successfully.', 'bot');
                        } catch (error) {
                            appendMessage(`Error importing history: ${error.message}`, 'bot');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }

        // Response Formatting
        function formatResponse(response) {
            const html = marked.parse(response, {
                gfm: true,
                breaks: true,
                sanitize: false
            });
            return `<div class="markdown-container">${html}</div>`;
        }

        // Typing Effect with Stop Capability
        function typeMessage(element, html, callback) {
            element.innerHTML = '<div class="markdown-container"></div>';
            const container = element.querySelector('.markdown-container');
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const nodes = Array.from(doc.querySelector('.markdown-container').childNodes);

            let nodeIndex = 0;
            let charIndex = 0;
            let currentElement = null;

            function typeNext() {
                if (isTypingStopped) {
                    addCopyButtons(container);
                    callback();
                    return;
                }

                if (nodeIndex >= nodes.length) {
                    addCopyButtons(container);
                    callback();
                    return;
                }

                const node = nodes[nodeIndex];
                if (node.nodeType === Node.ELEMENT_NODE) {
                    if (!currentElement) {
                        currentElement = node.cloneNode(false);
                        container.appendChild(currentElement);
                    }

                    if (node.childNodes.length > 0) {
                        nodes.splice(nodeIndex, 1, ...node.childNodes);
                    } else {
                        nodeIndex++;
                        currentElement = null;
                    }
                } else if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    if (charIndex < text.length) {
                        if (!currentElement) {
                            currentElement = document.createTextNode('');
                            container.appendChild(currentElement);
                        }
                        currentElement.textContent = text.slice(0, charIndex + 1);
                        charIndex++;
                        elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
                    } else {
                        nodeIndex++;
                        charIndex = 0;
                        currentElement = null;
                    }
                } else {
                    nodeIndex++;
                }

                setTimeout(typeNext, typingSpeed);
            }

            typeNext();
        }

        // Add Copy Buttons to Code Blocks
        function addCopyButtons(container) {
            container.querySelectorAll('pre').forEach(pre => {
                let codeText = pre.textContent;
                if (pre.querySelector('code')) {
                    codeText = pre.querySelector('code').textContent;
                }

                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.innerHTML = '<i class="fas fa-copy"></i>';
                button.setAttribute('aria-label', 'Copy code');
                button.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeText).then(() => {
                        button.classList.add('copied');
                        setTimeout(() => button.classList.remove('copied'), 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                    });
                });

                pre.appendChild(button);
            });
        }

        // Append Message to Chat Box
        function appendMessage(content, sender, sessionId = null, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);

            if (sender === 'bot') {
                const iconImg = document.createElement('img');
                iconImg.src = 'https://i.ibb.co/MCLkk0y/icon-png.webp';
                iconImg.alt = 'Chat @AI Bot';
                iconImg.style.width = '50px';
                iconImg.style.height = '40px';
                iconImg.style.marginRight = '10px';
                iconImg.style.borderRadius = '50%';
                iconImg.style.objectFit = 'cover';

                const messageContainer = document.createElement('div');
                messageContainer.style.display = 'flex';
                messageContainer.style.alignItems = 'flex-start';

                const messageContent = document.createElement('div');
                messageContent.style.minWidth = '100px';

                messageContainer.appendChild(iconImg);
                messageContainer.appendChild(messageContent);
                messageDiv.appendChild(messageContainer);

                if (sessionId && timestamp) {
                    messageContent.innerHTML = formatResponse(content);
                    addCopyButtons(messageContent);
                    elements.chatBox.appendChild(messageDiv);
                    elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
                } else {
                    typeMessage(messageContent, formatResponse(content), () => {
                        elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
                        resetButtons();
                    });
                }
            } else {
                messageDiv.innerHTML = formatResponse(content);
                elements.chatBox.appendChild(messageDiv);
                elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
            }

            elements.chatBox.appendChild(messageDiv);

            if (!sessionId && !timestamp) {
                ChatHistory.add(content, content, sender);
            }

            updateTextColor();
        }

        // Execute JavaScript Code
        function executeCode(code) {
            try {
                const logs = [];
                const customConsole = {
                    log(...args) {
                        logs.push(args.map(item => String(item)).join(' '));
                    },
                    error(...args) {
                        logs.push('Error: ' + args.map(item => String(item)).join(' '));
                    }
                };

                const fn = new Function('console', code);
                fn(customConsole);

                return logs.length > 0 ? '```javascript\n' + logs.join('\n') + '\n```' : 'Code executed successfully with no output.';
            } catch (error) {
                return '```javascript\nError: ' + error.message + '\n```';
            }
        }

        // Reset Buttons
        function resetButtons() {
            elements.sendBtn.disabled = false;
            elements.sendBtn.style.opacity = '1';
            elements.stopBtn.style.display = 'none';
        }

        // Chat Functions
        function resetChat() {
            elements.chatBox.innerHTML = '';
            elements.userInput.value = '';
            appendMessage('Welcome to Chat @AI!  How can I assist you today?');
        }

        function sendMessage(input = elements.userInput.value.trim(), fromSearchBar = false) {
            if (!input) return;

            appendMessage(input, 'user');
            elements.userInput.value = '';
            elements.userInput.style.height = 'auto';
            elements.userInput.focus();
            if (fromSearchBar) {
                elements.searchBar.value = '';
                elements.clearSearch.style.display = 'none';
                elements.searchBar.parentElement.classList.remove('active');
            }

            const loader = document.createElement('div');
            loader.classList.add('loader');
            for (let i = 0; i < 3; i++) {
                loader.appendChild(document.createElement('div'));
            }
            elements.chatBox.appendChild(loader);

            elements.sendBtn.disabled = true;
            elements.sendBtn.style.opacity = '0.5';
            elements.stopBtn.style.display = 'flex';

            abortController = new AbortController();
            isTypingStopped = false;

            const codeRegex = /```javascript\n([\s\S]*?)\n```/;
            const match = input.match(codeRegex);
            if (match) {
                const code = match[1].trim();
                elements.chatBox.removeChild(loader);
                const output = executeCode(code);
                appendMessage(output, 'bot');
                resetButtons();
                return;
            }

            if (input.startsWith('/generate_image ')) {
                const prompt = input.substring('/generate_image '.length).trim();
                generateImage(prompt, loader);
                return;
            }

            const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
            const contextMessages = history.slice(-maxContextMessages).map(item => [
                { role: 'user', parts: [{ text: item.question }] },
                { role: 'model', parts: [{ text: item.response }] }
            ]).flat();

            contextMessages.push({ role: 'user', parts: [{ text: input }] });

            fetch(`${baseUrl}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contextMessages,
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1000
                    }
                }),
                signal: abortController.signal
            })
                .then(response => response.json())
                .then(data => {
                    elements.chatBox.removeChild(loader);
                    if (data.candidates && data.candidates[0].content) {
                        const responseText = data.candidates[0].content.parts[0].text;
                        appendMessage(responseText, 'bot');
                    } else {
                        appendMessage('Error: No response from AI.', 'bot');
                    }
                })
                .catch(error => {
                    elements.chatBox.removeChild(loader);
                    if (error.name === 'AbortError') {
                        appendMessage('Request was cancelled.', 'bot');
                    } else {
                        appendMessage(`Error: ${error.message}`, 'bot');
                    }
                    resetButtons();
                });
        }

        // Image Generation (Placeholder)
        function generateImage(prompt, loader) {
            elements.chatBox.removeChild(loader);
            appendMessage('Image generation is not supported in this version.', 'bot');
            resetButtons();
        }

        // Event Listeners
        elements.sendBtn.addEventListener('click', () => sendMessage());
        elements.userInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        elements.stopBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
                isTypingStopped = true;
                resetButtons();
            }
        });

        elements.newChatBtn.addEventListener('click', resetChat);

        elements.clearHistoryBtn.addEventListener('click', () => ChatHistory.clear());
        elements.exportHistoryBtn.addEventListener('click', () => ChatHistory.export());
        elements.importHistoryBtn.addEventListener('click', () => ChatHistory.import());

        // Search Bar Functionality
        elements.searchBar.addEventListener('input', () => {
            const query = elements.searchBar.value.trim().toLowerCase();
            elements.clearSearch.style.display = query ? 'block' : 'none';
            elements.searchBar.parentElement.classList.toggle('active', !!query);

            const history = JSON.parse(LZString.decompress(localStorage.getItem('chatHistory') || '[]') || '[]');
            elements.chatHistory.innerHTML = '';
            history
                .filter(item => item.question.toLowerCase().includes(query) || item.keyword.toLowerCase().includes(query))
                .forEach(item => ChatHistory.renderHistoryItem(item));
        });

        elements.searchBar.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const input = elements.searchBar.value.trim();
                if (input) {
                    sendMessage(input, true);
                }
            }
        });

        elements.clearSearch.addEventListener('click', () => {
            elements.searchBar.value = '';
            elements.clearSearch.style.display = 'none';
            elements.searchBar.parentElement.classList.remove('active');
            ChatHistory.load();
        });

        // Voice Input
        const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (recognition) {
            const speech = new recognition();
            speech.continuous = false;
            speech.interimResults = false;

            speech.onresult = event => {
                const transcript = event.results[0][0].transcript;
                elements.userInput.value = transcript;
                sendMessage(transcript);
            };

            speech.onend = () => {
                recognizing = false;
                elements.voiceBtn.classList.remove('active');
                elements.voiceBtn.style.backgroundColor = '';
            };

            elements.voiceBtn.addEventListener('click', () => {
                if (!recognizing) {
                    recognizing = true;
                    elements.voiceBtn.classList.add('active');
                    elements.voiceBtn.style.backgroundColor = '#ff6f61';
                    speech.start();
                } else {
                    recognizing = false;
                    speech.stop();
                }
            });
        } else {
            elements.voiceBtn.style.display = 'none';
        }

        // Auto-resize Textarea
        elements.userInput.addEventListener('input', () => {
            elements.userInput.style.height = 'auto';
            elements.userInput.style.height = `${elements.userInput.scrollHeight}px`;
        });

        // Initialize
        function showSection() {}
        function initSlideshow() {}

        window.addEventListener('load', () => {
            setTimeout(() => {
                elements.loadingOverlay.classList.add('hidden');
                resetChat();
                ChatHistory.load();
                updateTextColor();
            }, 1000);
        });
    </script>
</body>
</html>
