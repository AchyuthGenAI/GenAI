<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat@AI - Authentication</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        html, body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .mic-active { color: #f43f5e; } /* rose-500 */
        #chat-input {
            max-height: 200px; /* Set max height for the textarea */
            resize: none; /* Disable manual resizing by user */
        }
        /* Styles for Markdown content */
        .prose {
            color: #d1d5db; /* gray-300 */
        }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            color: #f1f5f9; /* slate-100 */
        }
        .prose a {
            color: #22d3ee; /* cyan-400 */
        }
        .prose strong {
            color: #f8fafc; /* slate-50 */
        }
        .prose ul > li::marker {
            color: #64748b; /* slate-500 */
        }
        .prose pre {
            background-color: #0f172a; /* slate-900 */
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            overflow-x: auto; /* Add horizontal scroll for long code lines */
        }
        .prose code {
            font-size: 0.9rem;
        }
        .code-btn-wrapper {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .prose pre:hover .code-btn-wrapper {
            opacity: 1;
        }
        .code-action-btn {
            background-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .history-item-container:hover .delete-chat-btn {
            opacity: 1;
        }
        /* Table Styles */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
            table-layout: auto;
        }
        .prose th, .prose td {
            border: 1px solid #334155; /* slate-700 */
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .prose th {
            background-color: #1e293b; /* slate-800 */
            font-weight: 600;
            color: #f1f5f9; /* slate-100 */
        }
        .prose tbody tr:nth-child(even) {
            background-color: rgba(30, 41, 59, 0.5);
        }
        /* Blinking cursor for typing animation */
        .typing-cursor {
            animation: blink 1s step-end infinite;
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background-color: #94a3b8; /* slate-400 */
            vertical-align: sub;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #94a3b8; } /* slate-400 */
        }
        .auth-container {
            background: #0f172a;
        }
        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: #1e293b; /* slate-800 */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #334155; /* slate-700 */
            width: 200px;
            z-index: 50;
            display: none;
        }
        .profile-dropdown.show {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-full flex overflow-hidden">
    <!-- Auth Page -->
    <div id="auth-page" class="w-full h-full flex items-center justify-center auth-container p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-cyan-400 mb-2">Welcome to Chat@AI</h1>
                <p class="text-slate-400">Your intelligent chat companion, inspired by Gemini.</p>
            </div>
            <div id="auth-error" class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6 hidden"></div>
            <!-- Login Form -->
            <form id="login-form" class="bg-slate-800 p-8 rounded-2xl shadow-2xl space-y-6">
                <h2 class="text-2xl font-semibold text-center text-white">Log In</h2>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">Log In</button>
                <p class="text-center text-slate-400">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-cyan-400 hover:text-cyan-300">Sign up</a>
                </p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="bg-slate-800 p-8 rounded-2xl shadow-2xl space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center text-white">Sign Up</h2>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                    <input type="email" id="signup-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <input type="password" id="signup-password" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                </div>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">Sign Up</button>
                <p class="text-center text-slate-400">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-cyan-400 hover:text-cyan-300">Log in</a>
                </p>
            </form>
        </div>
    </div>
    
    <div id="chat-app" class="hidden w-full h-full flex">
        <!-- Sidebar for Chat History -->
        <aside id="sidebar" class="sidebar bg-slate-800 w-72 flex-shrink-0 flex flex-col p-4 absolute lg:relative h-full z-30 -translate-x-full lg:translate-x-0">
            <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg px-4 py-3 transition duration-300 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>New Chat</span>
            </button>
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-slate-300">History</h2>
                <button id="clear-all-btn" class="p-1 text-slate-500 hover:text-red-500" title="Clear all chats">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto pr-2">
                <ul id="history-list" class="space-y-2">
                    <!-- Chat history items will be injected here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full relative z-10">
            <!-- Header -->
            <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 shadow-lg sticky top-0">
                <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
                    <button id="menu-btn" class="lg:hidden p-2 -ml-2 text-slate-300 hover:bg-slate-700 rounded-md">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-200">Chat@AI</h1>
                     <div class="relative">
                        <button id="profile-btn" class="flex items-center gap-2 text-slate-300 hover:bg-slate-700 rounded-full p-1 transition-colors">
                            <div id="profile-initial" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white"></div>
                        </button>
                        <div id="profile-dropdown" class="profile-dropdown">
                            <div class="p-4 border-b border-slate-700">
                                <p class="font-semibold text-white" id="profile-email"></p>
                            </div>
                            <button id="logout-btn" class="w-full text-left px-4 py-3 hover:bg-slate-700/50 text-red-400 font-medium">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Chat Area -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                <div id="chat-container" class="max-w-4xl mx-auto space-y-6">
                    <!-- Chat messages will be injected here -->
                </div>
            </main>

            <!-- Message Input Form & Controls -->
            <footer class="bg-slate-900/50 backdrop-blur-sm sticky bottom-0">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                     <!-- Stop Generating Button Container -->
                    <div id="generation-controls" class="text-center pb-2 hidden">
                        <button id="stop-generating-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg px-4 py-2 transition duration-300 flex items-center mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="mr-2"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 18h12V6H6v12zM8 8h8v8H8V8z"/></svg>
                            Stop Generating
                        </button>
                    </div>
                    <form id="chat-form">
                        <div class="flex items-end bg-slate-800 border border-slate-700 rounded-2xl p-2 transition-all duration-300 focus-within:ring-2 focus-within:ring-cyan-500">
                            <textarea id="chat-input" placeholder="Enter a prompt here..." autocomplete="off" rows="1" class="flex-1 bg-transparent px-4 py-2 text-white placeholder-slate-400 focus:outline-none disabled:bg-transparent disabled:cursor-not-allowed"></textarea>
                            
                            <button id="mic-btn" type="button" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 transition-colors duration-200 disabled:opacity-50">
                                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                            </button>
                            
                            <button type="submit" class="bg-slate-600 text-white rounded-full p-2 ml-1 transition-colors duration-300 flex items-center justify-center disabled:bg-slate-700 disabled:cursor-not-allowed w-10 h-10">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                            </button>
                        </div>
                    </form>
                </div>
            </footer>
        </div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-20 hidden lg:hidden"></div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-40 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="delete-modal-title" class="text-xl font-bold text-white mb-4">Delete Chat?</h3>
            <p id="delete-modal-text" class="text-slate-400 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 transition-colors">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors font-semibold">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Code Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full h-full max-w-4xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h3 class="text-xl font-bold text-white">Live Preview</h3>
                <button id="close-preview-btn" class="p-2 rounded-full hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div class="flex-1 p-1 bg-white">
                <iframe id="preview-iframe" class="w-full h-full border-0 rounded-md"></iframe>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            collection,
            addDoc,
            query,
            getDocs,
            deleteDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element References ---
        const authPage = document.getElementById('auth-page');
        const chatApp = document.getElementById('chat-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileInitial = document.getElementById('profile-initial');
        const profileEmail = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const submitButton = chatForm.querySelector('button[type="submit"]');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const previewModal = document.getElementById('preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const previewIframe = document.getElementById('preview-iframe');
        const generationControls = document.getElementById('generation-controls');
        const stopGeneratingBtn = document.getElementById('stop-generating-btn');
        
        // --- API & Firebase Configuration ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const API_KEY = 'AIzaSyDirhQ899FnmcWCuwfHfzS05TEenhZntwA'; // IMPORTANT: Replace with your actual API key
        
        const firebaseConfig = {
            apiKey: "AIzaSyAMqtiL99s78TnDyHEi8VlBbzMzZh8Jqh8",
            authDomain: "login-90932.firebaseapp.com",
            projectId: "login-90932",
            storageBucket: "login-90932.firebasestorage.app",
            messagingSenderId: "574568827002",
            appId: "1:574568827002:web:7ed038c10c3fe0bc3953c3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);


        // --- State Management ---
        let currentChatId = null;
        let allChats = {};
        let chatIdToDelete = null;
        let stopGenerationFlag = false;
        let currentUser = null;
        
        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
             // Configure Marked.js
            marked.setOptions({
                gfm: true,
                breaks: true,
                sanitizer: (html) => html,
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            });
            addEventListeners();
            checkAuthState();
        });
        
        function checkAuthState() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    showChatApp();
                    setupUserProfile(user);
                    loadChatsFromFirestore();
                } else {
                    currentUser = null;
                    showAuthPage();
                }
            });
        }

        function showAuthPage() {
            authPage.classList.remove('hidden');
            chatApp.classList.add('hidden');
        }

        function showChatApp() {
            authPage.classList.add('hidden');
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
        }
        
        function setupUserProfile(user) {
            profileEmail.textContent = user.email;
            profileInitial.textContent = user.email.charAt(0).toUpperCase();
        }

        function addEventListeners() {
            // Auth form switching
            showSignupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });

             // Auth form submission
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);

            // Profile & Logout
            profileBtn.addEventListener('click', () => {
                profileDropdown.classList.toggle('show');
            });
            logoutBtn.addEventListener('click', handleLogout);
            document.addEventListener('click', (e) => {
                 if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            });


            // Chat app event listeners
            chatForm.addEventListener('submit', handleSendMessage);
            newChatBtn.addEventListener('click', startNewChat);
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            clearAllBtn.addEventListener('click', () => showDeleteModal(null));
            confirmDeleteBtn.addEventListener('click', confirmDeletion);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            closePreviewBtn.addEventListener('click', hidePreviewModal);
            stopGeneratingBtn.addEventListener('click', () => {
                stopGenerationFlag = true;
            });


            chatInput.addEventListener('input', () => {
                autoResizeTextarea(chatInput);
                updateSendButtonState();
            });
            chatInput.addEventListener('keydown', handleTextareaKeydown);

            if (recognition) {
                micBtn.addEventListener('click', toggleVoiceRecognition);
                recognition.onresult = handleVoiceResult;
                recognition.onend = () => micIcon.classList.remove('mic-active', 'animate-pulse');
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                };
            } else {
                 micBtn.disabled = true;
            }
        }
        
        // --- AUTHENTICATION LOGIC ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Login error", error);
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                 console.error("Signup error", error);
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
                // Clear state
                allChats = {};
                currentChatId = null;
                chatContainer.innerHTML = '';
                historyList.innerHTML = '';
            } catch (error) {
                console.error("Logout error", error);
            }
        }

        // --- CHAT LOGIC ---
        async function handleSendMessage(e) {
            if(e) e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput || !currentUser) return;

            // --- Change UI to "generating" state ---
            toggleForm(false); 
            generationControls.classList.remove('hidden'); 
            stopGenerationFlag = false; 
            
            // If this is the first message in a new chat, create the chat document first
            if (!currentChatId) {
                try {
                     const newChatRef = await addDoc(collection(db, "users", currentUser.uid, "chats"), {
                        title: userInput.substring(0, 40) + (userInput.length > 40 ? '...' : ''),
                        createdAt: new Date()
                    });
                    currentChatId = newChatRef.id;
                    allChats[currentChatId] = { id: currentChatId, title: userInput.substring(0, 40) + (userInput.length > 40 ? '...' : ''), messages: [] };
                    renderHistorySidebar();
                } catch (error) {
                    console.error("Error creating new chat:", error);
                    toggleForm(true);
                    generationControls.classList.add('hidden');
                    return;
                }
            }
            
            appendMessage(userInput, 'user');

            // Save user message to history
            const userMessage = { role: 'user', parts: [{ text: userInput }] };
            allChats[currentChatId].messages.push(userMessage);
            await addDoc(collection(db, "users", currentUser.uid, "chats", currentChatId, "messages"), userMessage);
            
            // Update sidebar if it's a new chat title
            if(allChats[currentChatId].messages.length === 1) {
                 await updateDoc(doc(db, "users", currentUser.uid, "chats", currentChatId), {
                    title: userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '')
                });
                allChats[currentChatId].title = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                renderHistorySidebar();
            }


            // Clear input and show loading state
            chatInput.value = '';
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            appendLoadingIndicator();
            scrollToBottom();

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: allChats[currentChatId].messages }),
                });

                removeLoadingIndicator();
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText) {
                    // Append an empty container for the AI message first
                    const messageId = appendMessage('', 'model'); 
                    const messageElement = document.getElementById(messageId);
                    const contentContainer = messageElement.querySelector('.prose');

                    // Start streaming and wait for it to finish or be stopped
                    const finalText = await streamResponse(contentContainer, aiResponseText, messageId);
                    
                    const aiMessage = { role: 'model', parts: [{ text: finalText }] };
                    allChats[currentChatId].messages.push(aiMessage);
                    await addDoc(collection(db, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);

                } else {
                    appendMessage("I couldn't generate a response.", 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage(`Error: ${error.message}`, 'model-error');
            } finally {
                // --- Restore UI to normal state ---
                generationControls.classList.add('hidden'); // Hide stop button
                toggleForm(true); // Re-enable form controls
            }
        }
        
        // --- UI & DOM MANIPULATION ---
        function handleTextareaKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey && !submitButton.disabled) {
                e.preventDefault();
                handleSendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.style.overflowY = textarea.scrollHeight > 200 ? 'auto' : 'hidden';
        }

        function appendMessage(text, sender, stream = false, customId = null) {
            const messageId = customId || `msg-${sender}-${Date.now()}`;
            let messageContentHtml = '';
            const isModel = sender === 'model' || sender === 'model-error';

            if (isModel) {
                messageContentHtml = `<div class="prose max-w-none"></div>`;
            } else { // For user
                const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                messageContentHtml = `<p class="text-white whitespace-pre-wrap">${sanitizedText}</p>`;
            }

            const isError = sender === 'model-error';
            const userIconHtml = `<div class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`;
            const modelIconHtml = `<div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br ${isError ? 'from-red-500 to-orange-600' : 'from-cyan-500 to-blue-600'} flex items-center justify-center shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m12 14 4-4"/><path d="m12 14 4 4"/><path d="M12 14H2.5"/><path d="M12 14v7.5"/><path d="m20 10-4-4"/><path d="m20 10-4 4"/><path d="M20 10h-7.5"/><path d="M4 14v-2.5"/><path d="M4 14H2.5"/><path d="M4 14l-1.5-1.5L4 11l1.5 1.5L4 14Z"/><path d="m12 6-2-2-2 2-2-2-2 2-2-2-2 2"/><path d="M12 6V2.5"/></svg></div>`;

            const messageHtml = sender === 'user' ? 
                `<div id="${messageId}" class="flex items-start gap-3 justify-end"><div class="bg-cyan-600 rounded-lg p-4 max-w-lg shadow-lg">${messageContentHtml}</div>${userIconHtml}</div>` :
                `<div id="${messageId}" class="flex items-start gap-3"><div class="flex-shrink-0">${modelIconHtml}</div><div class="${isError ? 'bg-red-800' : 'bg-slate-800'} rounded-lg p-4 max-w-lg shadow-lg">${messageContentHtml}</div></div>`;

            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            const messageElement = document.getElementById(messageId);
            const contentContainer = messageElement.querySelector('.prose');
            
            if (isModel && contentContainer && !stream) {
                 contentContainer.innerHTML = marked.parse(text);
                 enhanceCodeBlocks(messageId);
            }
             if (!isModel) {
                // For user messages, no special handling needed after insertion.
            }

            scrollToBottom();
            return messageId; // Return the ID for reference
        }

        function streamResponse(contentContainer, fullText, messageId) {
            return new Promise((resolve) => {
                const finalHtml = marked.parse(fullText);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = finalHtml;

                const textNodesToAnimate = [];
                function findTextNodes(node) {
                    if (node.nodeType === Node.TEXT_NODE && node.nodeValue.trim().length > 0) {
                        textNodesToAnimate.push({ node, originalText: node.nodeValue });
                        node.nodeValue = '';
                    }
                    for (const child of node.childNodes) {
                        findTextNodes(child);
                    }
                }
                findTextNodes(tempDiv);
                
                while (tempDiv.firstChild) {
                    contentContainer.appendChild(tempDiv.firstChild);
                }

                let nodeIndex = 0;
                function animateNextNode() {
                    // Check for completion or user interruption
                    if (nodeIndex >= textNodesToAnimate.length || stopGenerationFlag) {
                        const cursor = contentContainer.querySelector('.typing-cursor');
                        if (cursor) cursor.remove();
                        enhanceCodeBlocks(messageId);
                        
                        // Resolve promise with final text (full or partial)
                        if (stopGenerationFlag) {
                            resolve(contentContainer.innerText);
                        } else {
                            resolve(fullText);
                        }
                        return;
                    }

                    const { node, originalText } = textNodesToAnimate[nodeIndex];
                    const characters = originalText.split('');
                    let charIndex = 0;

                    const cursor = document.createElement('span');
                    cursor.className = 'typing-cursor';
                    if(node.nextSibling) {
                        node.parentNode.insertBefore(cursor, node.nextSibling);
                    } else {
                        node.parentNode.appendChild(cursor);
                    }

                    function typeCharacter() {
                         // Check for user interruption within the character loop
                        if (stopGenerationFlag) {
                            animateNextNode(); // Jump to the end logic
                            return;
                        }
                        if (charIndex < characters.length) {
                            node.nodeValue += characters[charIndex];
                            charIndex++;
                            scrollToBottom();
                            const delay = Math.random() * 12 + 4;
                            setTimeout(typeCharacter, delay);
                        } else {
                            cursor.remove();
                            nodeIndex++;
                            animateNextNode();
                        }
                    }
                    typeCharacter();
                }
                animateNextNode();
            });
        }


        function enhanceCodeBlocks(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            const codeBlocks = messageElement.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                const code = block.querySelector('code');
                if (!code) return;
                
                if(block.querySelector('.code-btn-wrapper')) return;

                const btnWrapper = document.createElement('div');
                btnWrapper.className = 'code-btn-wrapper';

                if (code.classList.contains('language-html') || code.classList.contains('language-markup')) {
                    const previewBtn = document.createElement('button');
                    previewBtn.className = 'code-action-btn';
                    previewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg> <span>Preview</span>`;
                    previewBtn.addEventListener('click', () => {
                        showPreviewModal(code.innerText);
                    });
                    btnWrapper.appendChild(previewBtn);
                }

                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg> <span>Copy</span>`;
                copyBtn.addEventListener('click', () => {
                    const originalContent = copyBtn.innerHTML;
                    const textarea = document.createElement('textarea');
                    textarea.value = code.innerText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        copyBtn.innerHTML = `<span>Copied!</span>`;
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        copyBtn.innerHTML = `<span>Error</span>`;
                    }
                    document.body.removeChild(textarea);
                    setTimeout(() => { copyBtn.innerHTML = originalContent; }, 2000);
                });
                btnWrapper.appendChild(copyBtn);

                block.appendChild(btnWrapper);
            });
        }
        
        function updateSendButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            submitButton.disabled = !hasText;
            if (hasText) {
                submitButton.classList.remove('bg-slate-600');
                submitButton.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
            } else {
                submitButton.classList.add('bg-slate-600');
                submitButton.classList.remove('bg-cyan-600', 'hover:bg-cyan-700');
            }
        }
        
        function renderHistorySidebar() {
            historyList.innerHTML = '';
            const sortedChats = Object.values(allChats).sort((a, b) => {
                if (!a.createdAt || !b.createdAt) return 0;
                 return b.createdAt.toDate() - a.createdAt.toDate();
            });
            
            clearAllBtn.style.display = sortedChats.length > 0 ? 'block' : 'none';

            sortedChats.forEach(chat => {
                const li = document.createElement('li');
                const isActive = chat.id === currentChatId;
                const activeBg = isActive ? 'bg-slate-700' : 'hover:bg-slate-700/50';
                li.className = `history-item-container flex items-center justify-between rounded-md ${activeBg}`;
                
                const titleBtn = document.createElement('button');
                titleBtn.className = `flex-1 text-left px-3 py-2 truncate ${isActive ? 'text-white' : 'text-slate-400 hover:text-slate-200'}`;
                titleBtn.textContent = chat.title || 'New Chat';
                titleBtn.addEventListener('click', () => loadChat(chat.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-chat-btn p-2 text-slate-500 hover:text-red-500 transition-opacity duration-200 opacity-0';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteModal(chat.id);
                });

                li.appendChild(titleBtn);
                li.appendChild(deleteBtn);
                historyList.appendChild(li);
            });
        }
        
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        function toggleForm(isEnabled) {
            chatInput.disabled = !isEnabled;
            micBtn.disabled = !isEnabled;
            if(isEnabled) {
                updateSendButtonState();
                chatInput.focus();
            } else {
                submitButton.disabled = true;
            }
        }

        function scrollToBottom() {
            chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;
        }

        // --- HISTORY & STATE MANAGEMENT (FIRESTORE) ---
        function startNewChat() {
            currentChatId = null;
            chatContainer.innerHTML = '';
            appendMessage("Hello! I'm your AI assistant. How can I help you today?", 'model', true);
            renderHistorySidebar();
            if (window.innerWidth < 1024) {
                 sidebar.classList.add('-translate-x-full');
                 sidebarOverlay.classList.add('hidden');
            }
        }
        
        async function loadChat(chatId) {
            if (!currentUser || !allChats[chatId]) return;
            currentChatId = chatId;
            chatContainer.innerHTML = '';
            
            // Load messages from subcollection
            const messagesQuery = query(collection(db, "users", currentUser.uid, "chats", chatId, "messages"));
            const messagesSnapshot = await getDocs(messagesQuery);
            const messages = messagesSnapshot.docs.map(doc => doc.data());
            // You might want to sort messages by a timestamp if you add one
            allChats[chatId].messages = messages;

            messages.forEach(msg => appendMessage(msg.parts[0].text, msg.role, false));
            
            renderHistorySidebar();
            scrollToBottom();
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        async function loadChatsFromFirestore() {
            if (!currentUser) return;
            const chatsQuery = query(collection(db, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            const chats = {};
            querySnapshot.forEach((doc) => {
                chats[doc.id] = { id: doc.id, ...doc.data(), messages: [] };
            });
            allChats = chats;
            
             const lastChatId = Object.keys(allChats).length > 0 ? Object.keys(allChats).sort((a, b) => {
                 if (!allChats[a].createdAt || !allChats[b].createdAt) return 0;
                 return allChats[b].createdAt.toDate() - allChats[a].createdAt.toDate();
            })[0] : null;

            if (lastChatId) {
                loadChat(lastChatId);
            } else {
                startNewChat();
            }
            renderHistorySidebar();
        }

        function showDeleteModal(chatId) {
            chatIdToDelete = chatId;
            if (chatId) {
                 deleteModalTitle.textContent = "Delete Chat?";
                 deleteModalText.textContent = "Are you sure you want to delete this chat? This action cannot be undone.";
            } else {
                 deleteModalTitle.textContent = "Delete All Chats?";
                 deleteModalText.textContent = "This will permanently delete all conversations. This action cannot be undone.";
            }
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function hideDeleteModal() {
            chatIdToDelete = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }
        
        function showPreviewModal(htmlCode) {
            previewIframe.srcdoc = htmlCode;
            previewModal.classList.remove('hidden');
            previewModal.classList.add('flex');
        }

        function hidePreviewModal() {
            previewIframe.srcdoc = '';
            previewModal.classList.add('hidden');
            previewModal.classList.remove('flex');
        }

        async function confirmDeletion() {
            if (chatIdToDelete) {
                await handleSingleDelete();
            } else {
                await handleDeleteAll();
            }
        }

        async function handleSingleDelete() {
            if (!chatIdToDelete || !currentUser) return;
            
            const wasCurrentChat = chatIdToDelete === currentChatId;
            
            // Delete from Firestore
            await deleteDoc(doc(db, "users", currentUser.uid, "chats", chatIdToDelete));
            // You might also want to delete the messages subcollection, which is more complex.
            // For now, we'll just delete the chat document itself.
            
            delete allChats[chatIdToDelete];
            
            renderHistorySidebar();
            
            if (wasCurrentChat) {
                const lastChatId = Object.keys(allChats).length > 0 ? Object.keys(allChats).sort((a,b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1]))[0] : null;
                if(lastChatId){
                    loadChat(lastChatId);
                } else {
                    startNewChat();
                }
            }
            hideDeleteModal();
        }

        async function handleDeleteAll() {
            if(!currentUser) return;

            const chatsQuery = query(collection(db, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            const deletePromises = [];
            querySnapshot.forEach((doc) => {
                deletePromises.push(deleteDoc(doc.ref));
            });
            await Promise.all(deletePromises);

            allChats = {};
            renderHistorySidebar();
            startNewChat();
            hideDeleteModal();
        }
        
        // --- VOICE INPUT ---
        function toggleVoiceRecognition() {
            if (micIcon.classList.contains('mic-active')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    micIcon.classList.add('mic-active', 'animate-pulse');
                } catch(e) { console.error("Could not start recognition:", e) }
            }
        }

        function handleVoiceResult(event) {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            updateSendButtonState();
            autoResizeTextarea(chatInput);
        }

        function appendLoadingIndicator() {
            const loadingHtml = `<div id="loading-indicator" class="flex items-start gap-3"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m12 14 4-4"/><path d="m12 14 4 4"/><path d="M12 14H2.5"/><path d="M12 14v7.5"/><path d="m20 10-4-4"/><path d="m20 10-4 4"/><path d'M20 10h-7.5'/><path d="M4 14v-2.5"/><path d="M4 14H2.5"/><path d="M4 14l-1.5-1.5L4 11l1.5 1.5L4 14Z"/><path d="m12 6-2-2-2 2-2-2-2 2-2-2-2 2"/><path d="M12 6V2.5"/></svg></div><div class="bg-slate-800 rounded-lg p-4 max-w-lg shadow-lg flex items-center space-x-2"><span class="text-slate-400">Thinking</span><div class="w-2 h-2 bg-slate-500 rounded-full animate-pulse [animation-delay:-0.3s]"></div><div class="w-2 h-2 bg-slate-500 rounded-full animate-pulse [animation-delay:-0.15s]"></div><div class="w-2 h-2 bg-slate-500 rounded-full animate-pulse"></div></div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
        }
        
        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    </script>
</body>
</html>
