<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat@AI - Your Intelligent Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Lottie Player Script -->
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Theme CSS Variables */
        :root {
            /* Light Theme */
            --bg-primary: 255, 255, 255;
            --bg-secondary: 248, 250, 252;
            --bg-tertiary: 241, 245, 249;
            --bg-quaternary: 226, 232, 240;
            --bg-accent: 37, 99, 235;
            --bg-accent-hover: 29, 78, 216;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 15, 23, 42;
            --text-secondary: 51, 65, 85;
            --text-tertiary: 100, 116, 139;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 255, 255, 255;
            --text-accent: 37, 99, 235;
            --text-success: 22, 163, 74;
            --text-error: 220, 38, 38;
            --text-warning: 217, 119, 6;
            
            --border-primary: 226, 232, 240;
            --border-secondary: 203, 213, 225;
            --border-accent: 37, 99, 235;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-primary: 15, 23, 42;
            --bg-secondary: 30, 41, 59;
            --bg-tertiary: 51, 65, 85;
            --bg-quaternary: 71, 85, 105;
            --bg-accent: 6, 182, 212;
            --bg-accent-hover: 8, 145, 178;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 248, 250, 252;
            --text-secondary: 226, 232, 240;
            --text-tertiary: 203, 213, 225;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 15, 23, 42;
            --text-accent: 34, 211, 238;
            --text-success: 74, 222, 128;
            --text-error: 248, 113, 113;
            --text-warning: 251, 191, 36;
            
            --border-primary: 51, 65, 85;
            --border-secondary: 71, 85, 105;
            --border-accent: 6, 182, 212;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        [data-theme="midnight"] {
            /* Midnight Dark Theme */
            --bg-primary: 3, 7, 18;
            --bg-secondary: 15, 23, 42;
            --bg-tertiary: 30, 41, 59;
            --bg-quaternary: 51, 65, 85;
            --bg-accent: 139, 92, 246;
            --bg-accent-hover: 124, 58, 237;
            --bg-success: 34, 197, 94;
            --bg-error: 239, 68, 68;
            --bg-warning: 245, 158, 11;
            
            --text-primary: 255, 255, 255;
            --text-secondary: 241, 245, 249;
            --text-tertiary: 226, 232, 240;
            --text-quaternary: 148, 163, 184;
            --text-inverse: 3, 7, 18;
            --text-accent: 196, 181, 253;
            --text-success: 74, 222, 128;
            --text-error: 248, 113, 113;
            --text-warning: 251, 191, 36;
            
            --border-primary: 30, 41, 59;
            --border-secondary: 51, 65, 85;
            --border-accent: 139, 92, 246;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        /* Theme-aware classes */
        .bg-theme-primary { background-color: rgb(var(--bg-primary)); }
        .bg-theme-secondary { background-color: rgb(var(--bg-secondary)); }
        .bg-theme-tertiary { background-color: rgb(var(--bg-tertiary)); }
        .bg-theme-quaternary { background-color: rgb(var(--bg-quaternary)); }
        .bg-theme-accent { background-color: rgb(var(--bg-accent)); }
        .bg-theme-success { background-color: rgb(var(--bg-success)); }
        .bg-theme-error { background-color: rgb(var(--bg-error)); }
        .bg-theme-warning { background-color: rgb(var(--bg-warning)); }

        .text-theme-primary { color: rgb(var(--text-primary)); }
        .text-theme-secondary { color: rgb(var(--text-secondary)); }
        .text-theme-tertiary { color: rgb(var(--text-tertiary)); }
        .text-theme-quaternary { color: rgb(var(--text-quaternary)); }
        .text-theme-inverse { color: rgb(var(--text-inverse)); }
        .text-theme-accent { color: rgb(var(--text-accent)); }
        .text-theme-success { color: rgb(var(--text-success)); }
        .text-theme-error { color: rgb(var(--text-error)); }
        .text-theme-warning { color: rgb(var(--text-warning)); }

        .border-theme-primary { border-color: rgb(var(--border-primary)); }
        .border-theme-secondary { border-color: rgb(var(--border-secondary)); }
        .border-theme-accent { border-color: rgb(var(--border-accent)); }

        .hover\:bg-theme-accent:hover { background-color: rgb(var(--bg-accent-hover)); }
        .hover\:bg-theme-tertiary:hover { background-color: rgb(var(--bg-tertiary)); }
        .hover\:bg-theme-quaternary:hover { background-color: rgb(var(--bg-quaternary)); }

        /* Theme selector styles */
        .theme-selector {
            position: relative;
        }

        .theme-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            width: 150px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .theme-dropdown.show { display: block; }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: rgb(var(--text-secondary));
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .theme-option:hover {
            background-color: rgb(var(--bg-tertiary));
        }
        .theme-option.active {
            background-color: rgb(var(--bg-accent));
            color: rgb(var(--text-inverse));
        }

        /* Custom scrollbar for themed appearance */
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: rgb(var(--bg-secondary)); }
        ::-webkit-scrollbar-thumb { background: rgb(var(--bg-quaternary)); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(var(--border-secondary)); }

        html, body { font-family: 'Inter', sans-serif; }
        
        .main-content {
            min-width: 0;
        }
        
        .sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        .mic-active { color: rgb(var(--text-error)); }
        #chat-input {
            max-height: 200px;
            resize: none;
        }

        .prose { 
            color: rgb(var(--text-secondary));
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: rgb(var(--text-primary)); }
        .prose a { color: rgb(var(--text-accent)); }
        .prose strong { color: rgb(var(--text-primary)); }
        .prose ul > li::marker { color: rgb(var(--text-quaternary)); }
        .prose pre {
            background-color: rgb(var(--bg-quaternary));
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            overflow-x: auto; 
        }
        .prose code { 
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem; 
        }

        .code-btn-wrapper {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .prose pre:hover .code-btn-wrapper { opacity: 1; }
        .code-action-btn {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .history-item-container:hover .history-item-actions { opacity: 1; }
        .history-item-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
            table-layout: auto;
        }
        .prose th, .prose td {
            border: 1px solid rgb(var(--border-primary));
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .prose th {
            background-color: rgb(var(--bg-tertiary));
            font-weight: 600;
            color: rgb(var(--text-primary));
        }
        .prose tbody tr:nth-child(even) { background-color: rgba(var(--bg-tertiary), 0.5); }
        .table-responsive-wrapper {
            overflow-x: auto;
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.375rem;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        .table-responsive-wrapper table {
            margin: 0 !important;
        }

        .typing-cursor {
            animation: blink 1s step-end infinite;
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background-color: rgb(var(--text-tertiary));
            vertical-align: sub;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: rgb(var(--text-tertiary)); }
        }

        .auth-container { background: rgb(var(--bg-primary)); }
        
        .profile-dropdown, .export-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: rgb(var(--bg-secondary));
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgb(var(--border-primary));
            width: 200px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .profile-dropdown.show, .export-dropdown.show { display: block; }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: rgb(var(--text-secondary));
            transition: background-color 0.2s;
        }
        .dropdown-item:hover {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-primary));
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: rgb(var(--text-quaternary));
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgb(var(--border-primary));
        }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        #password-strength-bar {
            height: 5px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }

        .chat-message {
            position: relative;
            padding-bottom: 2.5rem;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            position: absolute;
            bottom: 0.5rem;
            left: 56px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .chat-message.user .action-buttons {
            right: 56px;
            left: auto;
        }

        .chat-message:hover .action-buttons {
            opacity: 1;
        }

        .action-buttons button, .action-buttons a {
            background-color: rgb(var(--bg-tertiary));
            color: rgb(var(--text-secondary));
            border: none;
            padding: 0;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
            text-decoration: none;
        }
        .action-buttons button:hover, .action-buttons a:hover {
            background-color: rgb(var(--bg-quaternary));
            color: rgb(var(--text-primary));
        }
        .action-buttons button:active, .action-buttons a:active {
            transform: scale(0.95);
        }
        .action-buttons .active-like {
            background-color: rgb(var(--bg-secondary));
            color: rgb(var(--text-success));
        }
        .action-buttons .active-dislike {
            background-color: rgb(var(--bg-secondary));
            color: rgb(var(--text-error));
        }
        .action-buttons .interactive-btn {
            width: auto;
            padding: 0 0.5rem;
        }
         .action-buttons .interactive-btn span {
            font-size: 0.75rem;
            line-height: 1rem;
            margin-left: 0.25rem;
         }

        .sidebar-overlay {
            z-index: 40;
        }

        .welcome-card {
            background: linear-gradient(135deg, rgb(var(--bg-secondary)) 0%, rgb(var(--bg-tertiary)) 100%);
            border: 1px solid rgb(var(--border-secondary));
        }

        .feature-card {
            background: rgba(var(--bg-tertiary), 0.5);
            border: 1px solid rgb(var(--border-primary));
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            background: rgba(var(--bg-tertiary), 0.8);
            border-color: rgb(var(--border-secondary));
            transform: translateY(-2px);
        }
        
        .suggestion-card {
            background-color: rgba(var(--bg-tertiary), 0.5);
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            text-align: left;
            width: 100%;
        }
        .suggestion-card:hover {
            background-color: rgba(var(--bg-tertiary), 0.8);
            border-color: rgb(var(--border-secondary));
            transform: translateY(-2px);
        }

        .help-tooltip {
            position: relative;
        }
        .help-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgb(var(--bg-secondary));
            color: rgb(var(--text-primary));
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            border: 1px solid rgb(var(--border-primary));
        }

        @media (max-width: 1023px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            border-radius: 0.5rem;
            padding: 1rem;
            color: rgb(var(--text-primary));
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            border-color: rgb(var(--text-success));
        }
        .notification.error {
            border-color: rgb(var(--text-error));
        }
        
        /* Multimedia upload */
        #file-preview-container {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: none;
            position: relative;
            background: rgb(var(--bg-tertiary));
            border-radius: 0.5rem;
        }
        #file-preview-container img, #file-preview-container video {
            max-height: 100px;
            border-radius: 0.25rem;
        }
        #file-preview-container audio {
            width: 100%;
        }
        #remove-file-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background: rgb(var(--bg-error));
            color: rgb(var(--text-inverse));
            border-radius: 9999px;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgb(var(--bg-secondary));
        }

        /* JSON Explorer Styles */
        .json-formatter { font-family: 'Fira Code', monospace; white-space: pre-wrap; font-size: 0.9rem; }
        .json-formatter .string { color: rgb(var(--text-accent)); }
        .json-formatter .number { color: rgb(var(--text-warning)); }
        .json-formatter .boolean { color: rgb(var(--text-error)); }
        .json-formatter .null { color: rgb(var(--text-quaternary)); }
        .json-formatter .key { color: rgb(var(--text-accent)); }
        .json-formatter details { padding-left: 1.5rem; border-left: 1px solid rgb(var(--border-secondary)); }
        .json-formatter summary { cursor: pointer; list-style: none; }
        .json-formatter summary::-webkit-details-marker { display: none; }
        .json-formatter summary::before {
            content: '►';
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.1s;
        }
        .json-formatter details[open] > summary::before {
            transform: rotate(90deg);
        }

        /* Code Visualizer Styles */
        #code-visualizer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            height: 100%;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
        }
        #visualizer-code-pane {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            background: rgb(var(--bg-primary));
            border-radius: 0.5rem;
            overflow: auto;
            padding: 0.5rem;
            border: 1px solid rgb(var(--border-primary));
        }
        #visualizer-code-pane .line {
            padding: 0 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.3s;
        }
        #visualizer-code-pane .line.highlighted {
            background-color: rgb(var(--bg-tertiary));
        }
        #visualizer-explanation-pane {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgb(var(--text-secondary));
        }
        #visualizer-state-pane {
            background: rgb(var(--bg-secondary));
            border: 1px solid rgb(var(--border-primary));
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-y: auto;
        }
        #visualizer-state-pane h4 {
            font-weight: bold;
            color: rgb(var(--text-tertiary));
            margin-bottom: 0.5rem;
        }
        #visualizer-state-pane .variable {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        #visualizer-state-pane .var-name {
            color: rgb(var(--text-accent));
        }
        #visualizer-state-pane .var-value {
            color: rgb(var(--text-accent));
        }
    </style>
</head>
<body class="bg-theme-primary text-theme-primary h-full overflow-hidden">
    <!-- Notification Container -->
    <div id="notification" class="notification hidden">
        <div class="flex items-center gap-2">
            <div id="notification-icon"></div>
            <span id="notification-text"></span>
        </div>
    </div>

    <!-- Auth Page -->
    <div id="auth-page" class="w-full h-full flex items-center justify-center auth-container p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 bg-theme-accent rounded-full flex items-center justify-center shadow-lg">
                        <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-16 h-16 rounded-full shadow-lg"/>
                    </div>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-cyan-400 mb-2">Welcome to Chat@AI</h1>
                <p class="text-theme-quaternary text-sm sm:text-base">Your intelligent AI-chat companion.</p>
                <div class="mt-4 text-xs text-theme-quaternary">
                    <p>✨ Advanced AI conversations • 🔒 Secure authentication • 💾 Chat history</p>
                </div>
            </div>
            <div id="auth-error" class="bg-theme-error/20 border border-theme-error text-theme-error px-4 py-3 rounded-lg mb-6 hidden"></div>
            
            <!-- Login Form -->
            <form id="login-form" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Log In</h2>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-theme-secondary mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition">
                </div>
                <div class="relative">
                    <label for="login-password" class="block text-sm font-medium text-theme-secondary mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition pr-10">
                    <button type="button" id="login-password-toggle" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-theme-quaternary hover:text-theme-primary">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <button type="submit" class="w-full bg-theme-accent hover:bg-theme-accent text-theme-inverse font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Log In</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <div class="divider">OR</div>
                <button type="button" id="google-login-btn" class="w-full bg-white text-slate-700 font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center hover:bg-slate-200">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Continue with Google
                </button>
                <p class="text-center text-theme-quaternary">
                    Don't have an account? <a href="#" id="show-signup" class="font-semibold text-theme-accent hover:text-theme-accent">Sign up</a>
                </p>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="bg-theme-secondary p-6 sm:p-8 rounded-2xl shadow-2xl space-y-4 sm:space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center text-theme-primary">Sign Up</h2>
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-theme-secondary mb-2">Full Name</label>
                    <input type="text" id="signup-name" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-theme-secondary mb-2">Email</label>
                    <input type="email" id="signup-email" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition">
                    <p id="email-error" class="text-theme-error text-sm mt-1 hidden"></p>
                </div>
                <div class="relative">
                    <label for="signup-password" class="block text-sm font-medium text-theme-secondary mb-2">Password</label>
                    <input type="password" id="signup-password" required class="w-full bg-theme-tertiary border border-theme-primary rounded-lg px-4 py-3 text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-accent transition pr-10">
                     <button type="button" id="signup-password-toggle" class="absolute inset-y-0 right-0 top-7 flex items-center pr-3 text-theme-quaternary hover:text-theme-primary">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                 <div class="w-full bg-theme-tertiary rounded-full h-[5px]">
                    <div id="password-strength-bar" class="rounded-full"></div>
                </div>
                <p id="password-error" class="text-theme-error text-sm -mt-3 hidden"></p>

                <button type="submit" class="w-full bg-theme-accent hover:bg-theme-accent text-theme-inverse font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Sign Up</span>
                    <svg class="animate-spin h-5 w-5 ml-3 hidden button-loader" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <div class="divider">OR</div>
                 <button type="button" id="google-signup-btn" class="w-full bg-white text-slate-700 font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center hover:bg-slate-200">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Continue with Google
                </button>
                <p class="text-center text-theme-quaternary">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-theme-accent hover:text-theme-accent">Log in</a>
                </p>
            </form>
        </div>
    </div>

    <div id="chat-app" class="hidden w-full h-full flex relative">
        <!-- Sidebar for Chat History -->
        <aside id="sidebar" class="sidebar bg-theme-secondary w-72 flex-shrink-0 flex flex-col p-4 lg:relative lg:translate-x-0">
            <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full bg-theme-accent hover:bg-theme-accent text-theme-inverse font-semibold rounded-lg px-4 py-3 transition duration-300 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>New Chat</span>
            </button>
            
            <div class="relative mb-4">
                <input type="text" id="search-history-input" placeholder="Search history..." class="w-full bg-theme-tertiary/50 border border-theme-primary rounded-md pl-10 pr-4 py-2 text-sm text-theme-primary placeholder-theme-quaternary focus:outline-none focus:ring-2 focus:ring-theme-accent">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
            </div>

            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-theme-secondary">History</h2>
                <button id="clear-all-btn" class="p-1 text-theme-quaternary hover:text-theme-error" title="Clear all chats">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto pr-2">
                <ul id="history-list" class="space-y-2">
                    <!-- Chat history items will be injected here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 flex flex-col h-full relative z-10 bg-theme-primary">
            <!-- Header -->
            <header class="bg-theme-secondary/50 backdrop-blur-sm border-b border-theme-primary shadow-lg sticky top-0 z-30">
                 <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
                     <div class="flex items-center gap-4">
                        <button id="menu-btn" class="lg:hidden p-2 -ml-2 text-theme-secondary hover:bg-theme-tertiary rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                        <div class="w-8 h-8 bg-theme-accent rounded-full flex items-center justify-center shadow">
                           <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 rounded-full shadow" />
                        </div>
                        <h1 class="text-xl sm:text-2xl font-bold text-theme-primary">Chat@AI</h1>
                     </div>
                     <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Theme Selector -->
                        <div class="theme-selector relative">
                            <button id="theme-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-md px-3 py-1.5 transition-colors">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                               <span class="hidden sm:inline">Theme</span>
                            </button>
                            <div id="theme-dropdown" class="theme-dropdown">
                                <div class="theme-option" data-theme="light">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                                     <span>Light</span>
                                </div>
                                <div class="theme-option" data-theme="dark">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                                    <span>Dark</span>
                                </div>
                                <div class="theme-option" data-theme="midnight">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6.364 6.364 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                                    <span>Midnight</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <button id="export-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-md px-3 py-1.5 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                               <span class="hidden sm:inline">Export</span>
                            </button>
                            <div id="export-dropdown" class="export-dropdown">
                                <button class="dropdown-item" data-format="txt">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                                     <span>As TXT</span>
                                </button>
                                <button class="dropdown-item" data-format="md">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M7 15v-4.5a1.5 1.5 0 0 1 3 0V15"></path><path d="M7 12h3"></path><path d="M12 15l2-2.5 2 2.5"></path><path d="M17 15v-5"></path></svg>
                                    <span>As Markdown</span>
                                </button>
                                <button class="dropdown-item" data-format="pdf">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-quaternary"><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M12.25 15.75a1 1 0 0 0 1.5 0v-2.5a1 1 0 0 0-1.5 0Z"/><path d="M10 12h1a2 2 0 1 1 0 4h-1v-4Z"/><path d="M15 12h1a2 2 0 0 1 0 4h-1"/></svg>
                                    <span>As PDF</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <button id="profile-btn" class="flex items-center gap-2 text-theme-secondary hover:bg-theme-tertiary rounded-full p-1 transition-colors">
                                <div id="profile-avatar" class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white overflow-hidden"></div>
                            </button>
                            <div id="profile-dropdown" class="profile-dropdown">
                                <div class="p-4 border-b border-theme-primary">
                                    <p class="font-bold text-theme-primary truncate" id="profile-name"></p>
                                    <p class="text-sm text-theme-quaternary truncate" id="profile-email"></p>
                                </div>
                                <button id="logout-btn" class="dropdown-item w-full text-theme-error font-medium">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Chat Area -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                <div id="chat-container" class="max-w-4xl mx-auto space-y-6">
                    <!-- Welcome content will be shown here initially -->
                </div>
            </main>

            <!-- Message Input Form & Controls -->
            <footer class="bg-theme-primary/50 backdrop-blur-sm sticky bottom-0">
                 <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
                    <div id="generation-controls" class="text-center pb-2 hidden">
                        <button id="stop-generating-btn" class="bg-theme-tertiary hover:bg-theme-quaternary text-theme-primary font-semibold rounded-lg px-4 py-2 transition duration-300 flex items-center mx-auto">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                             <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                           </svg>
                            Stop Generating
                        </button>
                    </div>
                    <form id="chat-form">
                        <div id="file-preview-container">
                            <div id="file-preview"></div>
                            <button type="button" id="remove-file-btn" title="Remove file">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="flex items-end bg-theme-secondary border border-theme-primary rounded-2xl p-2 transition-all duration-300 focus-within:ring-2 focus-within:ring-theme-accent">
                            <div class="help-tooltip">
                                <button id="attach-file-btn" type="button" class="text-theme-quaternary hover:text-theme-primary p-2 rounded-full hover:bg-theme-tertiary transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                </button>
                                <div class="tooltip-content">Attach File</div>
                            </div>
                             <input type="file" id="file-input" class="hidden" accept="image/*,audio/*,video/*,.csv,.txt,.py,.js,.java,.c,.cpp">
                             
                            <textarea id="chat-input" placeholder="Enter Your Prompt or paste code to visualize..." autocomplete="off" rows="1" class="flex-1 bg-transparent px-4 py-2 text-theme-primary placeholder-theme-quaternary focus:outline-none disabled:bg-transparent disabled:cursor-not-allowed"></textarea>

                            <div class="help-tooltip">
                                <button id="mic-btn" type="button" class="text-theme-quaternary hover:text-theme-primary p-2 rounded-full hover:bg-theme-tertiary transition-colors duration-200 disabled:opacity-50">
                                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
                                </button>
                                <div class="tooltip-content">
                                    Voice input (click to start)
                                </div>
                            </div>

                            <button type="submit" class="bg-theme-quaternary text-theme-primary rounded-full p-2 ml-1 transition-colors duration-300 flex items-center justify-center disabled:bg-theme-tertiary disabled:cursor-not-allowed w-10 h-10 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                            </button>
                        </div>
                    </form>
                    
                </div>
            </footer>
        </div>
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/50 backdrop-blur-sm hidden lg:hidden"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-theme-secondary rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="delete-modal-title" class="text-xl font-bold text-theme-primary mb-4">Delete Chat?</h3>
            <p id="delete-modal-text" class="text-theme-quaternary mb-6">Are you sure?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-theme-tertiary hover:bg-theme-quaternary transition-colors">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-theme-error hover:bg-theme-error transition-colors font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Code Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
         <div class="bg-theme-secondary rounded-lg shadow-xl w-full h-full max-w-4xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-theme-primary flex-shrink-0">
                <h3 class="text-xl font-bold text-theme-primary">Live Preview</h3>
                <button id="close-preview-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div class="flex-1 p-1 bg-white">
                <iframe id="preview-iframe" class="w-full h-full border-0 rounded-md"></iframe>
            </div>
        </div>
    </div>

    <!-- Interactive Feature Modal -->
    <div id="interactive-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
        <div class="bg-theme-secondary border border-theme-primary rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-theme-primary flex-shrink-0">
                <h3 id="interactive-modal-title" class="text-xl font-bold text-theme-primary"></h3>
                <button id="close-interactive-modal-btn" class="p-2 rounded-full hover:bg-theme-tertiary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div id="interactive-modal-body" class="flex-1 p-0 overflow-auto bg-theme-primary">
                <!-- Content will be injected here -->
            </div>
            <footer id="interactive-modal-footer" class="p-2 border-t border-theme-primary flex-shrink-0 hidden justify-center items-center gap-2">
                <!-- Footer content like buttons will be injected here -->
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            updateProfile,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            addDoc,
            query,
            getDocs,
            deleteDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element References ---
        const authPage = document.getElementById('auth-page');
        const chatApp = document.getElementById('chat-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleSignupBtn = document.getElementById('google-signup-btn');
        const signupNameInput = document.getElementById('signup-name');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const emailError = document.getElementById('email-error');
        const passwordError = document.getElementById('password-error');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileAvatarContainer = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');
        const exportBtn = document.getElementById('export-btn');
        const exportDropdown = document.getElementById('export-dropdown');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationText = document.getElementById('notification-text');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const submitButton = chatForm.querySelector('button[type="submit"]');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const searchHistoryInput = document.getElementById('search-history-input');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const previewModal = document.getElementById('preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const previewIframe = document.getElementById('preview-iframe');
        const generationControls = document.getElementById('generation-controls');
        const stopGeneratingBtn = document.getElementById('stop-generating-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreview = document.getElementById('file-preview');
        const removeFileBtn = document.getElementById('remove-file-btn');
        const interactiveModal = document.getElementById('interactive-modal');
        const interactiveModalTitle = document.getElementById('interactive-modal-title');
        const interactiveModalBody = document.getElementById('interactive-modal-body');
        const interactiveModalFooter = document.getElementById('interactive-modal-footer');
        const closeInteractiveModalBtn = document.getElementById('close-interactive-modal-btn');
        const themeBtn = document.getElementById('theme-btn');
        const themeDropdown = document.getElementById('theme-dropdown');
        
        // --- API & Firebase Configuration ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        const API_KEY = 'AIzaSyDirhQ899FnmcWCuwfHfzS05TEenhZntwA'; // IMPORTANT: Replace with your actual Gemini API key

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyAMqtiL99s78TnDyHEi8VlBbzMzZh8Jqh8",
            authDomain: "login-90932.firebaseapp.com",
            projectId: "login-90932",
            storageBucket: "login-90932.firebasestorage.app",
            messagingSenderId: "574568827002",
            appId: "1:574568827002:web:7ed038c10c3fe0bc3953c3"
        };
        
        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        let currentChatId = null;
        let allChats = {};
        let chatIdToDelete = null;
        let stopGenerationFlag = false;
        let currentUser = null;
        let notificationQueue = [];
        let isNotificationVisible = false;
        let attachedFile = null;
        let chartInstance = null;
        // Code visualizer state
        let visualizerSteps = [];
        let currentVisStep = 0;
        const vizLanguages = ['python', 'javascript', 'java', 'c', 'c++'];
        const fileExtensionMap = {
            '.py': 'python',
            '.js': 'javascript',
            '.java': 'java',
            '.c': 'c',
            '.cpp': 'c++'
        };

        // Theme Management
        let currentTheme = 'light';

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // --- THEME FUNCTIONS ---
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeDropdown();
        }

        function updateThemeDropdown() {
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.classList.toggle('active', option.dataset.theme === currentTheme);
            });
        }

        function handleThemeChange(newTheme) {
            setTheme(newTheme);
            themeDropdown.classList.remove('show');
            showNotification(`Theme changed to ${newTheme}`, 'success');
        }

        // --- FUNCTION DEFINITIONS ---
        
        function checkAPIStatus() {
            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) {
                 console.warn("API Key is missing. Please add your Google AI Gemini API key.");
                 showNotification("API Key is not configured.", "error");
            }
        }

        function showNotification(message, type = 'info') {
            notificationQueue.push({ message, type });
            processNotificationQueue();
        }
        
        function processNotificationQueue() {
            if (isNotificationVisible || notificationQueue.length === 0) return;
            isNotificationVisible = true;
            const { message, type } = notificationQueue.shift();
            notificationText.textContent = message;
            notification.className = `notification ${type}`;
            if (type === 'success') {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-success"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            } else if (type === 'error') {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-error"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            } else {
                notificationIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-theme-accent"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>';
            }
            notification.classList.remove('hidden');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                    isNotificationVisible = false;
                    processNotificationQueue();
                }, 300);
            }, 3000);
        }

        function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, "artifacts", appId, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                     if (userDoc.exists()) {
                         const userData = userDoc.data();
                         currentUser = { 
                             ...user, 
                             ...userData,
                             displayName: user.displayName || userData.displayName || 'Anonymous User'
                         };
                    } else {
                         const displayName = user.displayName || signupNameInput.value || "Anonymous";
                         const photoURL = user.photoURL || null;
                         await setDoc(userDocRef, {
                            displayName: displayName,
                            email: user.email,
                            photoURL: photoURL,
                            createdAt: new Date()
                        });
                        currentUser = { ...user, displayName, photoURL };
                    }
                    showChatApp();
                    setupUserProfile(currentUser);
                    await loadChatsFromFirestore();
                    showNotification(`Welcome back, ${currentUser.displayName || 'User'}!`, 'success');
                } else {
                    currentUser = null;
                    showAuthPage();
                }
            });
        }
        
        function showAuthPage() {
            authPage.classList.remove('hidden');
            authPage.classList.add('flex');
            chatApp.classList.add('hidden');
            chatApp.classList.remove('flex');
        }

        function showChatApp() {
            authPage.classList.add('hidden');
            authPage.classList.remove('flex');
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
        }

        function setupUserProfile(user) {
            if (!user) return;
            profileEmail.textContent = user.email || 'No email provided';
            profileName.textContent = user.displayName || 'Anonymous User';

            if (user.photoURL) {
                profileAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full">`;
            } else {
                const initial = (user.displayName || 'A').charAt(0).toUpperCase();
                profileAvatarContainer.innerHTML = initial;
            }
        }

        function showWelcomeContent() {
            const welcomeHtml = `
                <div class="welcome-card rounded-2xl p-8 mb-6 text-center">
                    <div class="w-20 h-20 bg-theme-accent rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                       <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-20 h-20 rounded-full shadow-lg" />
                    </div>
                    <h2 class="text-3xl font-bold text-theme-primary mb-4">Welcome to Chat@AI</h2>
                    <p class="text-theme-secondary text-lg mb-6">Your intelligent AI assistant. Ask me anything, upload a file, or paste code to visualize!</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-theme-primary mb-4">Try these examples:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                           <button class="suggestion-card" data-suggestion="Visualize this python code:\n\nx = 5\nitems = [1, 2, 3]\nfor i in range(x):\n  items.append(i * 2)\nprint(items)">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><circle cx="12" cy="12" r="10"/><path d="m10 8 6 4-6 4z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize Python code</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Visualize this javascript code:\n\nlet message = 'Hello';\nfor (let i = 0; i < 3; i++) {\n  console.log(message[i]);\n}">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><circle cx="12" cy="12" r="10"/><path d="m10 8 6 4-6 4z"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize JS code</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Plan a 7-day trip to Japan, focusing on cultural experiences in Kyoto and Tokyo.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                </div>
                                <span class="text-theme-secondary">Plan a trip to Japan</span>
                             </div>
                           </button>
                           <button class="suggestion-card" data-suggestion="Generate a JavaScript bar chart showing the population of the 5 largest cities in India.">
                             <div class="flex items-center gap-3">
                                <div class="w-8 h-8 flex-shrink-0 bg-rose-500/20 rounded-lg flex items-center justify-center">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-400"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                                </div>
                                <span class="text-theme-secondary">Visualize population data</span>
                             </div>
                           </button>
                        </div>
                    </div>
                </div>`;
            chatContainer.innerHTML = welcomeHtml;
            exportBtn.disabled = true;
        }

        function fillSuggestion(text) {
            chatInput.value = text;
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            chatInput.focus();
        };

        async function handleLogin(e) {
            e.preventDefault();
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Login error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            if(!validateForm()) return;

            const submitBtn = signupForm.querySelector('button[type="submit"]');
            toggleButtonLoading(submitBtn, true);

            const fullName = signupNameInput.value.trim();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Signup error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            } finally {
                toggleButtonLoading(submitBtn, false);
            }
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                authError.classList.add('hidden');
            } catch (error) {
                console.error("Google Sign-in error", error);
                authError.textContent = getFriendlyAuthError(error);
                authError.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                allChats = {};
                currentChatId = null;
                chatContainer.innerHTML = '';
                historyList.innerHTML = '';
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error("Logout error", error);
                showNotification('Error logging out', 'error');
            }
        }

        function getFriendlyAuthError(error) {
            switch(error.code) {
                case 'auth/invalid-email': return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Invalid email or password. Please try again.';
                case 'auth/email-already-in-use': return 'This email is already registered. Please log in.';
                case 'auth/weak-password': return 'Password is too weak. Please use at least 6 characters.';
                default: return 'An unexpected error occurred. Please try again.';
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(`${inputId}-toggle`);
            const icon = button.querySelector('svg');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 013.542-5.45m5.545-2.271A10.02 10.02 0 0112 5c4.478 0 8.268 2.943 9.542 7a10.02 10.02 0 01-1.343 2.596m-3.41-3.41a3 3 0 11-4.243-4.243" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />`;
            } else {
                input.type = 'password';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path  stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
            }
        }

        function updatePasswordStrength() {
            const password = signupPasswordInput.value;
            let strength = 0;
            if (password.length > 5) strength++;
            if (password.length > 7) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;

            let color = 'bg-theme-quaternary';
            if (strength <= 2) color = 'bg-theme-error';
            else if (strength <= 4) color = 'bg-theme-warning';
            else color = 'bg-theme-success';

            passwordStrengthBar.className = `rounded-full ${color}`;
            passwordStrengthBar.style.width = `${(strength / 5) * 100}%`;
            validatePassword();
        }

        function validateEmail() {
            const email = signupEmailInput.value;
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (!re.test(String(email).toLowerCase())) {
                emailError.textContent = 'Please enter a valid email address.';
                emailError.classList.remove('hidden');
                return false;
            }
            emailError.classList.add('hidden');
            return true;
        }

        function validatePassword() {
            const password = signupPasswordInput.value;
            if (password.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters long.';
                passwordError.classList.remove('hidden');
                return false;
            }
            passwordError.classList.add('hidden');
            return true;
        }

        function validateForm() {
            const isEmailValid = validateEmail();
            const isPasswordValid = validatePassword();
            const isNameValid = signupNameInput.value.trim() !== '';
            return isEmailValid && isPasswordValid && isNameValid;
        }

        function toggleButtonLoading(button, isLoading) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.button-loader');
            button.disabled = isLoading;
            if (isLoading) {
                buttonText.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check if it's a code file for visualization
            const extension = '.' + file.name.split('.').pop();
            const language = fileExtensionMap[extension];
            
            if (language) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const codeContent = event.target.result;
                    showCodeVisualizationModal(codeContent, language);
                };
                reader.readAsText(file);
                fileInput.value = ''; // Reset file input
                return;
            }

            // Handle other file types
            if (file.type === "text/plain" || file.type === "text/csv") {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const textContent = event.target.result;
                    attachedFile = {
                        base64: btoa(textContent), // Base64 encode the text content
                        mimeType: "text/plain", // Treat as plain text
                        name: file.name
                    };
                    displayFilePreview();
                    updateSendButtonState();
                };
                reader.readAsText(file);
            } else {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64Data = event.target.result.split(',')[1];
                    attachedFile = {
                        base64: base64Data,
                        mimeType: file.type,
                        name: file.name
                    };
                    displayFilePreview();
                    updateSendButtonState();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayFilePreview() {
            if (!attachedFile) return;

            let previewHtml = '';
            if (attachedFile.mimeType.startsWith('image/')) {
                previewHtml = `<img src="data:${attachedFile.mimeType};base64,${attachedFile.base64}" alt="File preview">`;
            } else if (attachedFile.mimeType.startsWith('audio/')) {
                previewHtml = `<audio controls src="data:${attachedFile.mimeType};base64,${attachedFile.base64}"></audio>`;
            } else if (attachedFile.mimeType.startsWith('video/')) {
                previewHtml = `<video controls class="max-w-xs rounded-lg mb-2" src="data:${attachedFile.mimeType};base64,${attachedFile.base64}"></video>`;
            } else {
                previewHtml = `<div class="text-sm text-theme-secondary p-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><span>${attachedFile.name}</span></div>`;
            }

            filePreview.innerHTML = previewHtml;
            filePreviewContainer.style.display = 'block';
        }

        function removeAttachedFile() {
            attachedFile = null;
            fileInput.value = '';
            filePreviewContainer.style.display = 'none';
            filePreview.innerHTML = '';
            updateSendButtonState();
        }

        async function handleSendMessage(e) {
            if(e) e.preventDefault();
            const userInput = chatInput.value.trim();
            
            // Check for Python visualization command
            const vizRegex = /^visualize this (\w+\+*\w*) code:/i;
            const match = userInput.match(vizRegex);
            if (match) {
                const language = match[1].toLowerCase();
                const code = userInput.substring(match[0].length).trim();
                if (vizLanguages.includes(language)){
                    showCodeVisualizationModal(code, language);
                    chatInput.value = '';
                    autoResizeTextarea(chatInput);
                    updateSendButtonState();
                    return;
                }
            }
            
            if ((!userInput && !attachedFile) || !currentUser) return;

            if (!API_KEY || API_KEY.includes('YOUR_API_KEY')) {
                appendMessage("`Error`: API Key is missing.\n\nPlease add your Google AI Gemini API key in the script section to enable chat functionality.", 'model-error');
                return;
            }

            if (chatContainer.querySelector('.welcome-card')) {
                chatContainer.innerHTML = '';
            }

            toggleForm(false);
            generationControls.classList.remove('hidden');
            stopGenerationFlag = false;

            if (!currentChatId) {
                try {
                     const title = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                     const newChatRef = await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"), {
                        title: title || 'Multimedia Chat',
                        createdAt: new Date()
                    });
                    currentChatId = newChatRef.id;
                    allChats[currentChatId] = { id: currentChatId, createdAt: new Date(), title: title || 'Multimedia Chat', messages: [] };
                    renderHistorySidebar();
                } catch (error) {
                    console.error("Error creating new chat:", error);
                    appendMessage("Error: Could not start a new chat session.", "model-error");
                    toggleForm(true);
                    generationControls.classList.add('hidden');
                    return;
                }
            }

            const messageParts = [];
            if (attachedFile) {
                messageParts.push({
                    inlineData: {
                        mimeType: attachedFile.mimeType,
                        data: attachedFile.base64
                    }
                });
            }
            if (userInput) {
                messageParts.push({ text: userInput });
            }

            appendMessage({ text: userInput, file: attachedFile }, 'user');
            
            const userMessage = { role: 'user', parts: messageParts, timestamp: new Date() };
            allChats[currentChatId].messages.push(userMessage);
            const firestoreMessage = { role: 'user', parts: [{text: userInput || `[Sent a file: ${attachedFile.name}]`}], timestamp: new Date() };
            await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), firestoreMessage);

            if(allChats[currentChatId].messages.length === 1) {
                const newTitle = userInput.substring(0, 40) + (userInput.length > 40 ? '...' : '');
                await updateDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId), { title: newTitle || `Chat about ${attachedFile.name}` });
                allChats[currentChatId].title = newTitle || `Chat about ${attachedFile.name}`;
                renderHistorySidebar();
            }

            chatInput.value = '';
            removeAttachedFile();
            autoResizeTextarea(chatInput);
            updateSendButtonState();
            appendLoadingIndicator();
            scrollToBottom();

            try {
                let apiMessages = allChats[currentChatId].messages.map(({ role, parts }) => ({ role, parts }));

                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: apiMessages }),
                });

                removeLoadingIndicator();
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                }
                const data = await response.json();
                const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiResponseText) {
                    const messageId = appendMessage({text: ''}, 'model');
                    const messageElement = document.getElementById(messageId);
                    const contentContainer = messageElement.querySelector('.prose');

                    const finalText = await streamResponse(contentContainer, aiResponseText, messageId);
                    
                    enhanceResponseMessage(messageElement, finalText);

                    const aiMessage = { role: 'model', parts: [{ text: finalText }], timestamp: new Date() };
                    allChats[currentChatId].messages.push(aiMessage);
                    await addDoc(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", currentChatId, "messages"), aiMessage);

                } else {
                    appendMessage({text: "I couldn't generate a response. The response was empty."}, 'model-error');
                }
            } catch (error) {
                console.error("Error fetching AI response:", error);
                removeLoadingIndicator();
                appendMessage({text: `Error: ${error.message}`}, 'model-error');
                showNotification('Error generating response', 'error');
            } finally {
                generationControls.classList.add('hidden');
                toggleForm(true);
            }
        }

        function appendMessage(content, sender) {
            const messageId = `msg-${sender}-${Date.now()}`;
            const { text, file } = typeof content === 'object' ? content : { text: content, file: null };
            
            let fileHtml = '';
            if (file) {
                 if (file.mimeType.startsWith('image/')) {
                    fileHtml = `<img src="data:${file.mimeType};base64,${file.base64}" class="max-w-xs rounded-lg mb-2">`;
                } else if (file.mimeType.startsWith('audio/')) {
                    fileHtml = `<audio controls src="data:${file.mimeType};base64,${file.base64}" class="w-full my-2"></audio>`;
                } else if (file.mimeType.startsWith('video/')) {
                    fileHtml = `<video controls class="max-w-xs rounded-lg mb-2" src="data:${file.mimeType};base64,${file.base64}"></video>`;
                }
            }

            const isModel = sender === 'model' || sender === 'model-error';
            
            let userAvatarHtml = '';
            if (sender === 'user' && currentUser) {
                if(currentUser.photoURL) {
                    userAvatarHtml = `<img src="${currentUser.photoURL}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full">`;
                } else {
                    const initial = (currentUser.displayName || 'A').charAt(0).toUpperCase();
                    userAvatarHtml = `<div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-theme-tertiary flex items-center justify-center font-bold text-theme-primary flex-shrink-0">${initial}</div>`;
                }
            }
            
            const isError = sender === 'model-error';
            const modelIconHtml = `<div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full ${isError ? 'bg-theme-error' : 'bg-theme-accent'} flex items-center justify-center shadow-md"><img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full shadow-md" /></div>`;
            
            const messageBubbleClasses = sender === 'user' ? 'bg-theme-accent text-theme-inverse' : (isError ? 'bg-theme-error/10' : 'bg-theme-secondary');
            const messageHtml = `
            <div id="${messageId}" class="chat-message flex items-start gap-2 sm:gap-3 ${sender === 'user' ? 'justify-end' : ''}">
                ${sender !== 'user' ? `<div class="flex-shrink-0">${modelIconHtml}</div>` : ''}
                <div class="rounded-lg p-3 sm:p-4 max-w-3xl shadow-lg min-w-0 ${messageBubbleClasses}">
                    ${fileHtml}
                    <div class="prose max-w-none ${sender === 'user' ? 'text-theme-inverse' : 'text-theme-primary'}">
                        ${marked.parse(text || '')}
                    </div>
                </div>
                ${sender === 'user' ? `<div class="flex-shrink-0">${userAvatarHtml}</div>` : ''}
                ${isModel ? '<div class="action-buttons"></div>' : ''}
            </div>`;

            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            const messageElement = document.getElementById(messageId);

            if (isModel && text) {
                const contentContainer = messageElement.querySelector('.prose');
                makeTablesResponsive(contentContainer);
                enhanceCodeBlocks(messageId);
            }

            scrollToBottom();
            return messageId;
        }

        async function streamResponse(contentContainer, fullText, messageId) {
            return new Promise((resolve) => {
                let currentText = '';
                let index = 0;
                const typingSpeed = 10;

                function type() {
                    if (stopGenerationFlag || index >= fullText.length) {
                        const finalHtml = marked.parse(currentText);
                        contentContainer.innerHTML = finalHtml;
                        makeTablesResponsive(contentContainer);
                        enhanceCodeBlocks(messageId);
                        resolve(currentText);
                        return;
                    }

                    currentText += fullText[index];
                    index++;
                    const tempHtml = marked.parse(currentText + '▋');
                    contentContainer.innerHTML = tempHtml;
                    scrollToBottom();
                    setTimeout(type, typingSpeed);
                }
                type();
            });
        }
        
        function enhanceResponseMessage(messageElement, textContent) {
            const actionContainer = messageElement.querySelector('.action-buttons');
            if (!actionContainer) return;

            addStandardActionButtons(actionContainer, textContent);

            const table = messageElement.querySelector('table');
            if (table) {
                addChartButton(actionContainer, table);
            }

            const jsonCodeBlock = messageElement.querySelector('code.language-json');
            if (jsonCodeBlock) {
                addJsonExplorerButton(actionContainer, jsonCodeBlock.innerText);
            }

            const locationMatches = textContent.match(/([A-Z][a-zA-Z\s]+,\s[A-Z][a-zA-Z\s]+)/g);
            if (locationMatches) {
                addMapButton(actionContainer, locationMatches[0]);
            }
            
            const dateRegex = /(?:schedule|meeting on|deadline for)\s(.*?)(?:\.|at\s\d{1,2}:\d{2}\s[AP]M|next\s\w+)/i;
            const dateMatch = textContent.match(dateRegex);
            if (dateMatch) {
                addCalendarButton(actionContainer, dateMatch[0], textContent);
            }
        }
        
        function addStandardActionButtons(container, text) {
            const copyBtn = document.createElement('button');
            copyBtn.title = "Copy";
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>`;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text);
                showNotification('Copied to clipboard', 'success');
            };
            container.appendChild(copyBtn);
        }

        function addChartButton(container, tableElement) {
             const chartBtn = document.createElement('button');
             chartBtn.title = "Visualize Chart";
             chartBtn.className = "interactive-btn";
             chartBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg><span>Visualize</span>`;
             chartBtn.onclick = () => showChartModal(tableElement);
             container.appendChild(chartBtn);
        }

        function addJsonExplorerButton(container, jsonText) {
            const jsonBtn = document.createElement('button');
            jsonBtn.title = "View JSON";
            jsonBtn.className = "interactive-btn";
            jsonBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg><span>View JSON</span>`;
            jsonBtn.onclick = () => showJsonExplorerModal(jsonText);
            container.appendChild(jsonBtn);
        }
        
        function addMapButton(container, location) {
            const mapBtn = document.createElement('button');
            mapBtn.title = `Show ${location} on Map`;
            mapBtn.className = "interactive-btn";
            mapBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg><span>Show Map</span>`;
            mapBtn.onclick = () => showMapModal(location);
            container.appendChild(mapBtn);
        }
        
        function addCalendarButton(container, eventText, fullContext) {
            const calendarLink = createGoogleCalendarLink(eventText, fullContext);
            if (!calendarLink) return;

            const calendarBtn = document.createElement('a');
            calendarBtn.href = calendarLink;
            calendarBtn.target = "_blank";
            calendarBtn.rel = "noopener noreferrer";
            calendarBtn.title = "Add to Calendar";
            calendarBtn.className = "interactive-btn";
            calendarBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg><span>Add to Calendar</span>`;
            container.appendChild(calendarBtn);
        }

        function showInteractiveModal(title) {
            interactiveModalTitle.textContent = title;
            interactiveModal.classList.remove('hidden');
            interactiveModal.classList.add('flex');
        }

        function hideInteractiveModal() {
            interactiveModal.classList.add('hidden');
            interactiveModal.classList.remove('flex');
            interactiveModalBody.innerHTML = '';
            interactiveModalFooter.innerHTML = '';
            interactiveModalFooter.classList.add('hidden');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            // Reset visualizer state
            visualizerSteps = [];
            currentVisStep = 0;
        }
        
        function showChartModal(table) {
            showInteractiveModal("Chart Visualization");
            interactiveModalBody.innerHTML = '<div class="p-4 h-full"><canvas id="chart-canvas"></canvas></div>';
            interactiveModalFooter.classList.remove('hidden');

            const ctx = document.getElementById('chart-canvas').getContext('2d');
            const data = parseTableForChart(table);
            if (!data) {
                hideInteractiveModal();
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: 'rgb(var(--text-primary))' }, grid: { color: 'rgb(var(--border-primary))'} },
                        x: { ticks: { color: 'rgb(var(--text-primary))' }, grid: { color: 'rgb(var(--border-primary))'} }
                    },
                    plugins: { legend: { labels: { color: 'rgb(var(--text-primary))' } } }
                }
            });

            ['bar', 'line', 'pie', 'doughnut'].forEach(type => {
                const btn = document.createElement('button');
                btn.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                btn.className = 'px-3 py-1 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors text-theme-primary text-sm';
                btn.onclick = () => {
                    chartInstance.config.type = type;
                    chartInstance.update();
                };
                interactiveModalFooter.appendChild(btn);
            });
        }
        
        function showMapModal(location) {
            showInteractiveModal(`Map: ${location}`);
            interactiveModalBody.innerHTML = `<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(location)}&hl=es;z=14&amp&output=embed" class="w-full h-full border-0" loading="lazy"></iframe>`;
        }

        function showJsonExplorerModal(jsonText) {
             showInteractiveModal("JSON Explorer");
             interactiveModalBody.classList.add('p-4');
            try {
                const jsonObj = JSON.parse(jsonText);
                const formattedHtml = formatJsonToHtml(jsonObj);
                interactiveModalBody.innerHTML = `<div class="json-formatter">${formattedHtml}</div>`;
            } catch (e) {
                interactiveModalBody.innerHTML = `<p class="text-theme-error">Error parsing JSON: ${e.message}</p><pre class="mt-4 text-theme-quaternary">${jsonText}</pre>`;
            }
        }

        function showCodePreviewModal(code, language) {
            showInteractiveModal("Live Code Preview");
            const bodyContent = language === 'javascript' ? `<canvas id="chartCanvas"></canvas><script>${code}<\/script>` : code;
            const fullHtml = `
                <html>
                    <head>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
                        <script src="https://d3js.org/d3.v7.min.js"><\/script>
                        <style>body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; color: #000; overflow: auto; } canvas { display: block; }</style>
                    </head>
                    <body>
                        ${bodyContent}
                    </body>
                </html>`;
            interactiveModalBody.innerHTML = `<iframe srcdoc='${fullHtml.replace(/'/g, "&apos;")}' class="w-full h-full border-0" ></iframe>`;
        }
        
        // --- START: New Code Visualizer Functions ---
        
        async function showCodeVisualizationModal(code, language) {
            showInteractiveModal(`${language.charAt(0).toUpperCase() + language.slice(1)} Code Visualizer`);
            interactiveModalBody.innerHTML = `<div class="flex items-center justify-center h-full">
                <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 200px; height: 200px;" loop autoplay></dotlottie-player>
            </div>`;

            const prompt = `
                Analyze the following ${language} code and generate a step-by-step execution trace.
                For each step, provide the line number being executed, a simple one-sentence explanation of what the line does, the state of global variables as an array of objects (where each object has a 'key' and a stringified 'value'), and any text that is printed to standard output.
                Only include variables that have been initialized.
                The very first step should be "Initial State" on line 0, showing the state before any code runs.
                The very last step should be "Final State", showing the final variable values and the complete output after the script finishes.
            `;
            
            const payload = {
              contents: [{
                role: 'user',
                parts: [
                  { text: prompt },
                  { text: `\`\`\`${language}\n${code}\n\`\`\`` }
                ]
              }],
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: "OBJECT",
                  properties: {
                    "steps": {
                      type: "ARRAY",
                      items: {
                        type: "OBJECT",
                        properties: {
                          "line": { "type": "INTEGER" },
                          "explanation": { "type": "STRING" },
                          "globals": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "key": { "type": "STRING" },
                                    "value": { "type": "STRING" }
                                }
                            }
                          },
                          "output": { "type": "STRING" }
                        }
                      }
                    }
                  }
                }
              }
            };

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API error during visualization.');
                }
                const data = await response.json();
                const traceText = data.candidates[0].content.parts[0].text;
                const trace = JSON.parse(traceText);
                
                if (trace.steps && trace.steps.length > 0) {
                    visualizerSteps = trace.steps;
                    currentVisStep = 0;
                    renderVisualizerUI(code, language);
                    updateVisualizerStep();
                } else {
                    throw new Error("AI could not generate a valid visualization trace.");
                }

            } catch (error) {
                console.error("Code visualization error:", error);
                interactiveModalBody.innerHTML = `<div class="p-4 text-theme-error">Error: Could not visualize code. ${error.message}</div>`;
            }
        }

        function renderVisualizerUI(code, language) {
            interactiveModalBody.innerHTML = `
                <div id="code-visualizer-container">
                    <div id="visualizer-code-pane"></div>
                    <div id="visualizer-explanation-pane"></div>
                    <div id="visualizer-state-pane"></div>
                </div>
            `;
            
            const codePane = document.getElementById('visualizer-code-pane');
            const codeLines = code.split('\n');
            codeLines.forEach((line, index) => {
                const lineEl = document.createElement('div');
                lineEl.className = 'line';
                lineEl.id = `vis-line-${index + 1}`;
                // Using a table for alignment of line number and code
                lineEl.innerHTML = `<table class="w-full"><tr>
                    <td class="w-8 text-right pr-2 text-theme-quaternary">${index + 1}</td>
                    <td><pre><code class="language-${language} !p-0 !bg-transparent">${hljs.highlight(line, {language}).value}</code></pre></td>
                </tr></table>`;
                codePane.appendChild(lineEl);
            });

            // Setup footer controls
            interactiveModalFooter.innerHTML = `
                <button id="vis-prev-btn" class="px-4 py-2 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <span id="vis-step-counter" class="text-sm text-theme-quaternary">Step 0/0</span>
                <button id="vis-next-btn" class="px-4 py-2 rounded-md bg-theme-quaternary hover:bg-theme-tertiary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
            `;
            interactiveModalFooter.classList.remove('hidden');

            document.getElementById('vis-prev-btn').addEventListener('click', () => {
                if(currentVisStep > 0) {
                    currentVisStep--;
                    updateVisualizerStep();
                }
            });
            document.getElementById('vis-next-btn').addEventListener('click', () => {
                if(currentVisStep < visualizerSteps.length - 1) {
                    currentVisStep++;
                    updateVisualizerStep();
                }
            });
        }

        function updateVisualizerStep() {
            const step = visualizerSteps[currentVisStep];
            if (!step) return;

            // Update explanation
            document.getElementById('visualizer-explanation-pane').textContent = step.explanation;

            // Update state
            const statePane = document.getElementById('visualizer-state-pane');
            let stateHtml = '<h4>Variables</h4>';
            const globalsArray = step.globals || [];
            if (globalsArray.length > 0) {
                for (const variable of globalsArray) {
                    stateHtml += `<div class="variable"><span class="var-name">${variable.key}</span> <span class="var-value">${variable.value}</span></div>`;
                }
            } else {
                stateHtml += '<p class="text-theme-quaternary text-sm">No variables initialized yet.</p>';
            }
            if (step.output) {
                stateHtml += `<h4 class="mt-4">Output</h4><pre class="text-theme-primary">${step.output}</pre>`;
            }
            statePane.innerHTML = stateHtml;

            // Highlight code line
            document.querySelectorAll('#visualizer-code-pane .line').forEach(l => l.classList.remove('highlighted'));
            // For final state, don't highlight any line.
            if(step.explanation !== "Final State") {
                const lineEl = document.getElementById(`vis-line-${step.line}`);
                if(lineEl) {
                    lineEl.classList.add('highlighted');
                    lineEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }

            // Update controls
            document.getElementById('vis-step-counter').textContent = `Step ${currentVisStep + 1} of ${visualizerSteps.length}`;
            document.getElementById('vis-prev-btn').disabled = currentVisStep === 0;
            document.getElementById('vis-next-btn').disabled = currentVisStep === visualizerSteps.length - 1;
        }

        // --- END: New Code Visualizer Functions ---

        function parseTableForChart(table) {
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            if (headers.length < 2 || rows.length === 0) {
                showNotification("Table not suitable for charting.", "error");
                return null;
            }

            const labels = rows.map(row => row.cells[0].textContent.trim());
            const datasets = [];

            for (let i = 1; i < headers.length; i++) {
                const data = rows.map(row => parseFloat(row.cells[i].textContent.trim().replace(/[^0-9.-]+/g,"")) || 0);
                const colorVal1 = Math.floor(Math.random() * 256);
                const colorVal2 = Math.floor(Math.random() * 256);
                const colorVal3 = Math.floor(Math.random() * 256);
                datasets.push({
                    label: headers[i],
                    data: data,
                    backgroundColor: `rgba(${colorVal1}, ${colorVal2}, ${colorVal3}, 0.5)`,
                    borderColor: `rgba(${colorVal1}, ${colorVal2}, ${colorVal3}, 1)`,
                    borderWidth: 1
                });
            }

            return { labels, datasets };
        }
        
        function formatJsonToHtml(obj) {
            if (obj === null) return `<span class="null">null</span>`;
            if (typeof obj === 'string') return `<span class="string">"${obj.replace(/"/g, '\\"')}"</span>`;
            if (typeof obj === 'number') return `<span class="number">${obj}</span>`;
            if (typeof obj === 'boolean') return `<span class="boolean">${obj}</span>`;

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '[]';
                let content = obj.map(item => `<li>${formatJsonToHtml(item)}</li>`).join('');
                return `<details open><summary class="inline-block">Array(${obj.length}) [</summary><ul class="pl-4">${content}</ul>]</details>`;
            }

            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '{}';
                let content = keys.map(key => `<li><span class="key">"${key}"</span>: ${formatJsonToHtml(obj[key])}</li>`).join('');
                return `<details open><summary class="inline-block">Object {</summary><ul class="pl-4">${content}</ul>}</details>`;
            }
            
            return obj.toString();
        }

        function createGoogleCalendarLink(text, context) {
            let date = new Date();
            let title = "New Event";
            const titleMatch = context.match(/(?:deadline for|meeting on|schedule)\s(.*?)(?=\sfor|\son|\sat)/i);
            if (titleMatch) title = titleMatch[1];

            const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/i);
            if (timeMatch) {
                let hours = parseInt(timeMatch[1]);
                const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                const ampm = timeMatch[3].toLowerCase();
                if (ampm === 'pm' && hours < 12) hours += 12;
                if (ampm === 'am' && hours === 12) hours = 0;
                date.setHours(hours, minutes, 0, 0);
            }

            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayMatch = text.match(new RegExp(`next (${days.join('|')})`, 'i'));
            if (dayMatch) {
                const targetDay = days.indexOf(dayMatch[1].toLowerCase());
                const currentDay = date.getDay();
                let dayDifference = targetDay - currentDay;
                if (dayDifference <= 0) dayDifference += 7;
                date.setDate(date.getDate() + dayDifference);
            }

            const startDate = date.toISOString().replace(/-|:|\.\d{3}/g, '');
            date.setHours(date.getHours() + 1);
            const endDate = date.toISOString().replace(/-|:|\.\d{3}/g, '');

            const details = `Event details: ${context}`;
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(details)}`;
            return url;
        }

        function handleTextareaKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey && !submitButton.disabled) {
                e.preventDefault();
                handleSendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.style.overflowY = textarea.scrollHeight > 200 ? 'auto' : 'hidden';
        }

        function updateSendButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            const hasFile = !!attachedFile;
            const canSend = hasText || hasFile;
            
            submitButton.disabled = !canSend;
            submitButton.classList.toggle('bg-theme-tertiary', !canSend);
            submitButton.classList.toggle('hover:bg-theme-accent', canSend);
            submitButton.classList.toggle('bg-theme-quaternary', canSend);
        }
        
        function makeTablesResponsive(element) {
            if (!element) return;
            element.querySelectorAll('table').forEach(table => {
                if (table.parentElement.classList.contains('table-responsive-wrapper')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'table-responsive-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
        }

        function enhanceCodeBlocks(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            messageElement.querySelectorAll('pre').forEach(block => {
                const code = block.querySelector('code');
                if (!code || block.querySelector('.code-btn-wrapper')) return;

                const btnWrapper = document.createElement('div');
                btnWrapper.className = 'code-btn-wrapper';
                
                const codeText = code.innerText;
                const language = Array.from(code.classList).find(c => c.startsWith('language-'))?.replace('language-', '');

                // Preview for HTML
                if (['html', 'markup', 'xml'].includes(language)) {
                    const previewBtn = document.createElement('button');
                    previewBtn.className = 'code-action-btn';
                    previewBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg> <span>Preview</span>`;
                    previewBtn.addEventListener('click', () => showCodePreviewModal(codeText, language));
                    btnWrapper.appendChild(previewBtn);
                }
                
                // Visualize for JS/HTML containing charting libraries
                if (['javascript', 'html'].includes(language) && /(new Chart|d3\.select)/.test(codeText)) {
                     const vizBtn = document.createElement('button');
                    vizBtn.className = 'code-action-btn';
                    vizBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg><span>Visualize</span>`;
                    vizBtn.addEventListener('click', () => showCodePreviewModal(codeText, language));
                    btnWrapper.appendChild(vizBtn);
                }
                
                // Visualize for supported languages
                if (vizLanguages.includes(language)) {
                     const vizBtn = document.createElement('button');
                    vizBtn.className = 'code-action-btn';
                    vizBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m10 8 6 4-6 4z"/></svg><span>Visualize</span>`;
                    vizBtn.addEventListener('click', () => showCodeVisualizationModal(codeText, language));
                    btnWrapper.appendChild(vizBtn);
                }

                // Copy button for all code blocks
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-action-btn';
                copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg> <span>Copy</span>`;
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeText).then(() => {
                        showNotification('Code copied to clipboard', 'success');
                    }).catch(err => {
                        showNotification('Failed to copy code', 'error');
                    });
                });
                btnWrapper.appendChild(copyBtn);

                block.appendChild(btnWrapper);
            });
        }
        
        function renderHistorySidebar() {
            const searchTerm = searchHistoryInput.value.toLowerCase();
            historyList.innerHTML = '';
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));

            clearAllBtn.style.display = sortedChats.length > 0 ? 'block' : 'none';

            sortedChats.forEach(chat => {
                const li = document.createElement('li');
                li.dataset.chatId = chat.id;
                const isActive = chat.id === currentChatId;
                
                const titleText = chat.title || 'New Chat';

                if (searchTerm && !titleText.toLowerCase().includes(searchTerm)) {
                    li.classList.add('hidden');
                }
                
                li.className = `history-item-container flex items-center justify-between rounded-md group ${isActive ? 'bg-theme-tertiary' : 'hover:bg-theme-tertiary/50'} ${li.classList.contains('hidden') ? 'hidden' : ''}`;

                const titleContainer = document.createElement('div');
                titleContainer.className = 'flex-1 text-left px-3 py-2 truncate';
                titleContainer.innerHTML = `<span class="text-sm ${isActive ? 'text-theme-primary' : 'text-theme-secondary group-hover:text-theme-primary'}">${titleText}</span>`;
                titleContainer.addEventListener('click', () => loadChat(chat.id));
                
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'history-item-actions flex items-center pr-2';
                
                const renameBtn = document.createElement('button');
                renameBtn.className = 'p-1.5 text-theme-quaternary hover:text-theme-primary';
                renameBtn.title = 'Rename chat';
                renameBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
                renameBtn.onclick = (e) => { e.stopPropagation(); handleRename(chat.id, titleContainer); };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'p-1.5 text-theme-quaternary hover:text-theme-error';
                deleteBtn.title = 'Delete chat';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                deleteBtn.onclick = (e) => { e.stopPropagation(); showDeleteModal(chat.id); };

                actionsContainer.appendChild(renameBtn);
                actionsContainer.appendChild(deleteBtn);

                li.appendChild(titleContainer);
                li.appendChild(actionsContainer);
                historyList.appendChild(li);
            });
        }
        
        async function handleRename(chatId, titleContainer) {
            const currentTitle = allChats[chatId].title || 'New Chat';
            const titleSpan = titleContainer.querySelector('span');

            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'w-full bg-theme-quaternary text-theme-primary text-sm rounded px-1 py-0';
            
            titleSpan.style.display = 'none';
            titleContainer.appendChild(input);
            input.focus();
            input.select();
            
            const saveRename = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    await updateDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", chatId), { title: newTitle });
                    allChats[chatId].title = newTitle;
                    showNotification('Chat renamed!', 'success');
                }
                // Always re-render to restore original state
                renderHistorySidebar();
            };
            
            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveRename();
                } else if (e.key === 'Escape') {
                    renderHistorySidebar();
                }
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
        }

        function toggleForm(isEnabled) {
            chatInput.disabled = !isEnabled;
            micBtn.disabled = !isEnabled;
            attachFileBtn.disabled = !isEnabled;
            if(isEnabled) {
                updateSendButtonState();
                chatInput.focus();
            } else {
                submitButton.disabled = true;
            }
        }

        function scrollToBottom() {
            const mainArea = chatContainer.parentElement;
            mainArea.scrollTop = mainArea.scrollHeight;
        }

        function startNewChat() {
            currentChatId = null;
            showWelcomeContent();
            renderHistorySidebar();
            removeAttachedFile();
            showNotification('Started new chat', 'success');
            exportBtn.disabled = true;

            if (window.innerWidth < 1024) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            }
        }

        async function loadChat(chatId) {
            if (!currentUser || !allChats[chatId]) return;
            currentChatId = chatId;
            chatContainer.innerHTML = '';
            exportBtn.disabled = false;

            if (!allChats[chatId].messages || allChats[chatId].messages.length === 0) {
                const messagesQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats", chatId, "messages"));
                const messagesSnapshot = await getDocs(messagesQuery);
                const messages = messagesSnapshot.docs.map(doc => doc.data()).sort((a,b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
                allChats[chatId].messages = messages;
            }
            
            allChats[chatId].messages.forEach(msg => {
                 const textContent = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';
                 const messageElementId = appendMessage({ text: textContent }, msg.role);
                 enhanceResponseMessage(document.getElementById(messageElementId), textContent);
            });

            renderHistorySidebar();
            scrollToBottom();
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        async function loadChatsFromFirestore() {
            if (!currentUser) return;
            const chatsQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            allChats = {};
            querySnapshot.forEach((doc) => {
                allChats[doc.id] = { id: doc.id, ...doc.data(), messages: [] };
            });

            loadMostRecentChat();
        }

        function loadMostRecentChat() {
            const sortedChats = Object.values(allChats).sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
            if (sortedChats.length > 0) {
                loadChat(sortedChats[0].id);
            } else {
                startNewChat();
            }
        }

        function showDeleteModal(chatId) {
            chatIdToDelete = chatId;
            deleteModalTitle.textContent = chatId ? "Delete Chat?" : "Delete All Chats?";
            deleteModalText.textContent = `This will permanently delete ${chatId ? 'this conversation' : 'all conversations'}. This action cannot be undone.`;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function hideDeleteModal() {
            chatIdToDelete = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }

        function showPreviewModal(htmlCode) {
            const fullHtml = `<html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><script src="https://cdn.tailwindcss.com"><\/script></head><body>${htmlCode}</body></html>`;
            previewIframe.srcdoc = fullHtml;
            previewModal.classList.remove('hidden');
            previewModal.classList.add('flex');
        }

        function hidePreviewModal() {
            previewIframe.srcdoc = '';
            previewModal.classList.add('hidden');
            previewModal.classList.remove('flex');
        }

        async function confirmDeletion() {
            if (chatIdToDelete) {
                await handleSingleDelete();
            } else {
                await handleDeleteAll();
            }
        }

        async function handleSingleDelete() {
            if (!chatIdToDelete || !currentUser) return;
            const idToDelete = chatIdToDelete;
            const wasCurrentChat = idToDelete === currentChatId;
            await deleteDoc(doc(db, "artifacts", appId, "users", currentUser.uid, "chats", idToDelete));
            delete allChats[idToDelete];
            hideDeleteModal();
            renderHistorySidebar();
            if (wasCurrentChat) {
                loadMostRecentChat();
            }
            showNotification('Chat deleted', 'success');
        }

        async function handleDeleteAll() {
            if(!currentUser) return;
            const chatsQuery = query(collection(db, "artifacts", appId, "users", currentUser.uid, "chats"));
            const querySnapshot = await getDocs(chatsQuery);
            const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            allChats = {};
            hideDeleteModal();
            renderHistorySidebar();
            startNewChat();
            showNotification('All chats deleted', 'success');
        }

        function toggleVoiceRecognition() {
            if (micIcon.classList.contains('mic-active')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    micIcon.classList.add('mic-active', 'animate-pulse');
                    showNotification('Listening... Speak now', 'info');
                } catch(e) { 
                    console.error("Could not start recognition:", e);
                    showNotification('Voice recognition not available', 'error');
                }
            }
        }

        function handleVoiceResult(event) {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            updateSendButtonState();
            autoResizeTextarea(chatInput);
            showNotification(`Voice input: "${transcript}"`, 'success');
        }
        
        function handleExport(format) {
            if (!currentChatId) {
                showNotification("No active chat to export.", "error");
                return;
            }

            const chat = allChats[currentChatId];
            const title = chat.title || 'chat-export';
            const messages = chat.messages || [];
            let content = '';

            if (format === 'txt') {
                content = messages.map(msg => {
                    const sender = msg.role === 'user' ? 'User' : 'Chat@AI';
                    const text = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';
                    return `${sender}:\n${text}\n\n--------------------------------\n\n`;
                }).join('');
            } else if (format === 'md') {
                content = `# ${title}\n\n`;
                content += messages.map(msg => {
                    const sender = msg.role === 'user' ? '> **User**' : '**Chat@AI**';
                    const text = msg.parts.find(p => p.text)?.text || '`[Multimedia Content]`';
                    return `${sender}\n\n${text}\n\n---\n\n`;
                }).join('');
            } else if (format === 'pdf') {
                exportToPdf(title, messages);
                return;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`Chat exported as ${format.toUpperCase()}`, 'success');
        }
        
        function exportToPdf(title, messages) {
             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();
             let y = 15;
             const pageHeight = doc.internal.pageSize.height;
             const margin = 10;
             const maxWidth = doc.internal.pageSize.width - margin * 2;
             
             doc.setFontSize(18);
             doc.text(title, margin, y);
             y += 15;
             
             messages.forEach(msg => {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                 
                const sender = msg.role === 'user' ? 'User' : 'Chat@AI';
                const text = msg.parts.find(p => p.text)?.text || '[Multimedia Content]';

                doc.setFontSize(12).setFont(undefined, 'bold');
                doc.text(sender, margin, y);
                y += 6;
                
                doc.setFontSize(10).setFont(undefined, 'normal');
                const lines = doc.splitTextToSize(text, maxWidth);
                doc.text(lines, margin, y);
                y += (lines.length * 4.5) + 10;
             });
             
             doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
             showNotification('Chat exported as PDF', 'success');
        }

        function appendLoadingIndicator() {
            const loadingHtml = `
                <div id="loading-indicator" class="flex items-center gap-2 sm:gap-3">
                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-theme-accent flex items-center justify-center shadow-md">
                       <img src="https://i.ibb.co/JWjgFGH4/chat-AI.jpg" alt="Chat AI Icon" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full shadow-md" />
                    </div>
                    <div class="rounded-lg max-w-lg flex items-center justify-center">
                        <dotlottie-player src="https://lottie.host/42a90344-ccc5-4d2a-92e2-1a62cef7473c/MqjsTEGKMS.lottie" background="transparent" speed="1" style="width: 120px; height: 120px;" loop autoplay></dotlottie-player>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
        }

        function removeLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
        }

        function addEventListeners() {
            // Auth form switching
            showSignupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authError.classList.add('hidden');
            });

            // Auth form submission
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            googleLoginBtn.addEventListener('click', handleGoogleSignIn);
            googleSignupBtn.addEventListener('click', handleGoogleSignIn);

            // Password visibility toggle
            document.getElementById('login-password-toggle').addEventListener('click', () => togglePasswordVisibility('login-password'));
            document.getElementById('signup-password-toggle').addEventListener('click', () => togglePasswordVisibility('signup-password'));

            // Advanced Auth UI Listeners
            signupPasswordInput.addEventListener('input', updatePasswordStrength);
            signupEmailInput.addEventListener('input', validateEmail);

            // Profile & Logout
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
                exportDropdown.classList.remove('show');
                themeDropdown.classList.remove('show');
            });
            logoutBtn.addEventListener('click', handleLogout);
            
            // Theme Selector
            themeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                themeDropdown.classList.toggle('show');
                profileDropdown.classList.remove('show');
                exportDropdown.classList.remove('show');
            });
            themeDropdown.addEventListener('click', (e) => {
                const themeOption = e.target.closest('.theme-option');
                if (themeOption) {
                    handleThemeChange(themeOption.dataset.theme);
                }
            });
            
            // Export Dropdown
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportDropdown.classList.toggle('show');
                profileDropdown.classList.remove('show');
                themeDropdown.classList.remove('show');
            });
            exportDropdown.addEventListener('click', (e) => {
                const format = e.target.closest('.dropdown-item')?.dataset.format;
                if(format) {
                    handleExport(format);
                }
            });

            document.addEventListener('click', (e) => {
                 if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
                 if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('show');
                }
                 if (!themeBtn.contains(e.target) && !themeDropdown.contains(e.target)) {
                    themeDropdown.classList.remove('show');
                }
            });

            // Chat app event listeners
            chatForm.addEventListener('submit', handleSendMessage);
            newChatBtn.addEventListener('click', startNewChat);
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            searchHistoryInput.addEventListener('input', () => renderHistorySidebar());
            clearAllBtn.addEventListener('click', () => showDeleteModal(null));
            confirmDeleteBtn.addEventListener('click', confirmDeletion);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            closePreviewBtn.addEventListener('click', hidePreviewModal);
            stopGeneratingBtn.addEventListener('click', () => {
                stopGenerationFlag = true;
                showNotification('Generation stopped', 'info');
            });

            chatInput.addEventListener('input', () => {
                autoResizeTextarea(chatInput);
                updateSendButtonState();
            });
            chatInput.addEventListener('keydown', handleTextareaKeydown);

            // Multimedia listeners
            attachFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            removeFileBtn.addEventListener('click', removeAttachedFile);

            if (recognition) {
                micBtn.addEventListener('click', toggleVoiceRecognition);
                recognition.onresult = handleVoiceResult;
                recognition.onend = () => {
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                    showNotification('Voice input ended', 'info');
                };
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    micIcon.classList.remove('mic-active', 'animate-pulse');
                    showNotification('Voice recognition error', 'error');
                };
            } else {
                 micBtn.disabled = true;
            }

            // Delegated Listeners for dynamic content
            chatContainer.addEventListener('click', (e) => {
                const suggestionCard = e.target.closest('.suggestion-card');
                if (suggestionCard) {
                    fillSuggestion(suggestionCard.dataset.suggestion);
                    return;
                }
            });
            
            closeInteractiveModalBtn.addEventListener('click', hideInteractiveModal);
        }

        // --- INITIALIZATION ---
        function init() {
            marked.setOptions({
                gfm: true,
                breaks: true,
                sanitizer: (html) => html,
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            });
            initializeTheme();
            addEventListeners();
            checkAPIStatus();
            checkAuthState();
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
